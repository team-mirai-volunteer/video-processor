generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Video {
  id                   String    @id @default(uuid())
  googleDriveFileId    String    @unique @map("google_drive_file_id")
  googleDriveUrl       String    @map("google_drive_url")
  title                String?
  description          String?
  durationSeconds      Int?      @map("duration_seconds")
  fileSizeBytes        BigInt?   @map("file_size_bytes")
  status               String    @default("pending")
  transcriptionPhase   String?   @map("transcription_phase")
  errorMessage         String?   @map("error_message")
  progressMessage      String?   @map("progress_message")
  gcsUri               String?   @map("gcs_uri")
  gcsExpiresAt         DateTime? @map("gcs_expires_at")
  audioGcsUri          String?   @map("audio_gcs_uri")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  clips          Clip[]
  processingJobs ProcessingJob[]
  transcription  Transcription?

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("videos")
}

model Clip {
  id                String   @id @default(uuid())
  videoId           String   @map("video_id")
  googleDriveFileId String?  @map("google_drive_file_id")
  googleDriveUrl    String?  @map("google_drive_url")
  title             String
  startTimeSeconds  Decimal  @map("start_time_seconds") @db.Decimal(10, 3)
  endTimeSeconds    Decimal  @map("end_time_seconds") @db.Decimal(10, 3)
  durationSeconds   Decimal  @map("duration_seconds") @db.Decimal(10, 3)
  transcript        String
  status            String   @default("pending")
  errorMessage      String?  @map("error_message")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("clips")
}

model ProcessingJob {
  id               String    @id @default(uuid())
  videoId          String    @map("video_id")
  clipInstructions String    @map("clip_instructions")
  status           String    @default("pending")
  aiResponse       String?   @map("ai_response")
  errorMessage     String?   @map("error_message")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("processing_jobs")
}

model Transcription {
  id              String   @id @default(uuid())
  videoId         String   @unique @map("video_id")
  fullText        String   @map("full_text")
  segments        Json
  languageCode    String   @map("language_code")
  durationSeconds Decimal  @map("duration_seconds") @db.Decimal(10, 3)
  createdAt       DateTime @default(now()) @map("created_at")

  video                 Video                  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  refinedTranscription  RefinedTranscription?

  @@map("transcriptions")
}

model RefinedTranscription {
  id                String   @id @default(uuid())
  transcriptionId   String   @unique @map("transcription_id")
  fullText          String   @map("full_text")
  sentences         Json     // RefinedSentence[]
  dictionaryVersion String   @map("dictionary_version")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  transcription Transcription @relation(fields: [transcriptionId], references: [id], onDelete: Cascade)

  @@map("refined_transcriptions")
}

// ===========================================
// shorts-gen Bounded Context
// ===========================================

// ① 企画ルート - プロジェクト全体のメタデータ
model ShortsProject {
  id               String   @id @default(uuid())
  title            String   // 企画タイトル（最終タイトルとは別）
  aspectRatio      String   @default("9:16") @map("aspect_ratio") // 縦横比
  resolutionWidth  Int      @default(1080) @map("resolution_width") // 解像度幅
  resolutionHeight Int      @default(1920) @map("resolution_height") // 解像度高さ
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  plannings           ShortsPlanning[]
  scripts             ShortsScript[]
  composedVideos      ShortsComposedVideo[]
  publishTexts        ShortsPublishText[]
  referenceCharacters ShortsReferenceCharacter[]

  @@index([createdAt(sort: Desc)])
  @@map("shorts_projects")
}

// 参照キャラクター - 画像生成の一貫性のため
model ShortsReferenceCharacter {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  description String   // キャラクター説明文
  imageUrl    String   @map("image_url") // GCSのURL
  order       Int      @default(0) // 順番（0始まり）
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project ShortsProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("shorts_reference_characters")
}

// ② 企画書 - マークダウン形式の企画書
model ShortsPlanning {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  content   String   // 企画書マークダウン
  version   Int      @default(1) // 編集バージョン
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project ShortsProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scripts ShortsScript[]

  @@index([projectId])
  @@map("shorts_plannings")
}

// ③ 台本 - シーンの集合
model ShortsScript {
  id         String   @id @default(uuid())
  projectId  String   @map("project_id")
  planningId String   @map("planning_id")
  version    Int      @default(1) // 編集バージョン
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  project        ShortsProject         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  planning       ShortsPlanning        @relation(fields: [planningId], references: [id], onDelete: Cascade)
  scenes         ShortsScene[]
  composedVideos ShortsComposedVideo[]

  @@index([projectId])
  @@index([planningId])
  @@map("shorts_scripts")
}

// ③ シーン - 台本内の各シーン
// visualType: 'image_gen' | 'stock_video' | 'solid_color'
model ShortsScene {
  id                String   @id @default(uuid())
  scriptId          String   @map("script_id")
  order             Int      // シーンの順番（0始まり）
  summary           String   // シーン概要
  visualType        String   @map("visual_type") // シーン映像タイプ
  voiceText         String?  @map("voice_text") // 読み上げ音声文（nullable）
  subtitles         Json     @default("[]") // 字幕文の配列 (string[])
  silenceDurationMs Int?     @map("silence_duration_ms") // 無音の場合のシーン長さ（nullable）
  stockVideoKey     String?  @map("stock_video_key") // ありもの動画のキー（セレクタ）
  solidColor        String?  @map("solid_color") // 塗りつぶし色（#RRGGBB）
  imagePrompt       String?  @map("image_prompt") // ⑥ 画像プロンプト（編集可能）
  imageStyleHint    String?  @map("image_style_hint") // スタイル指定文章
  voiceKey          String?  @map("voice_key") // 声の種類キー（nullの場合は"default"）
  voiceSpeed        Float?   @map("voice_speed") // 音声スピード（nullの場合は1.0、有効範囲: 0.5〜2.0）
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  script ShortsScript       @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  assets ShortsSceneAsset[]

  @@index([scriptId])
  @@map("shorts_scenes")
}

// ④⑤⑦ シーンアセット - 生成された音声/字幕画像/背景画像
// assetType: 'voice' | 'subtitle_image' | 'background_image'
model ShortsSceneAsset {
  id         String   @id @default(uuid())
  sceneId    String   @map("scene_id")
  assetType  String   @map("asset_type") // アセットタイプ
  fileUrl    String   @map("file_url") // GCSのURL
  durationMs Int?     @map("duration_ms") // 音声の場合の長さ（nullable）
  metadata   Json?    // その他のメタデータ（字幕のインデックス等）
  createdAt  DateTime @default(now()) @map("created_at")

  scene ShortsScene @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@index([assetType])
  @@map("shorts_scene_assets")
}

// ⑧ 合成動画 - FFmpegで合成された最終動画
model ShortsComposedVideo {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  scriptId        String   @map("script_id")
  fileUrl         String?  @map("file_url") // GCSのURL
  durationSeconds Decimal? @map("duration_seconds") @db.Decimal(10, 3)
  status          String   @default("pending") // pending | processing | completed | failed
  errorMessage    String?  @map("error_message")
  bgmKey          String?  @map("bgm_key") // 使用したBGMのキー
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  project ShortsProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  script  ShortsScript  @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([scriptId])
  @@index([status])
  @@map("shorts_composed_videos")
}

// ⑨ 公開テキスト - YouTube等への公開用タイトル・説明
model ShortsPublishText {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  title       String   // 動画タイトル
  description String   // ディスクリプション
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project ShortsProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("shorts_publish_texts")
}

# 画像アップロード機能設計

## 目的

**ユーザーが**、AI生成ではなく任意の画像をシーンに適用したい**ときに**、手持ちの画像をアップロードしてCompose工程で使えるようにするため。

## 概要

⑥⑦画像UIにおいて、現在は「プロンプト生成 → 画像生成」のフローのみ対応しているが、ユーザーが手持ちの画像を直接アップロードしてシーンに割り当てる機能を追加する。

### スコープ

- **対象**: フロントエンド（⑥⑦画像UI）
- **対象外**: バックエンドAPI（別途設計が必要）

### 拡張性要件

将来的に動画ファイルのアップロードにも対応できるよう、以下の点で拡張性を担保する：
- ファイル種別を抽象化したインターフェース設計
- ファイルタイプによる分岐を容易にするデータ構造

---

## 現状分析

### 現在の画像UIフロー

```
┌─────────────────────────────────────────┐
│ シーン N (visualType: 'image_gen')      │
├──────────────────┬──────────────────────┤
│ ① プロンプト     │ ② 画像               │
├──────────────────┼──────────────────────┤
│ [生成] ボタン    │ [生成] ボタン         │
│ プロンプト表示   │ 画像プレビュー        │
└──────────────────┴──────────────────────┘
```

### 関連コンポーネント

| ファイルパス | 役割 |
|-------------|------|
| `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx` | 状態管理・コールバック |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/asset-generation-step.tsx` | 素材生成UIメイン |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/scene-asset-item.tsx` | 個別シーンUI |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts` | 状態管理フック |

### 既存の参照となるパターン

参照キャラクター登録機能（`reference-character-uploader.tsx`）が画像アップロードの実装パターンを提供している：
- FormDataを使用したファイル送信
- Server Action経由でのバックエンド連携
- アップロード状態の管理

---

## 設計

### UI設計

#### 変更後の画像カラムUI

```
┌─────────────────────────────────────────┐
│ シーン N (visualType: 'image_gen')      │
├──────────────────┬──────────────────────┤
│ ① プロンプト     │ ② 画像               │
├──────────────────┼──────────────────────┤
│ [生成] ボタン    │ ┌────────┬─────────┐ │
│ プロンプト表示   │ │[生成]  │[アップ  ││
│                  │ │        │ロード]  ││
│                  │ └────────┴─────────┘ │
│                  │ 画像プレビュー        │
│                  │ ※ソースラベル表示     │
└──────────────────┴──────────────────────┘
```

#### ソースラベル

アップロードした画像と生成した画像を区別するため、画像プレビュー下部にソースを表示する：
- 「生成」: AI生成された画像
- 「アップロード」: ユーザーがアップロードした画像

### データ構造設計

#### アセットソース種別の追加

`apps/shared/types/shorts-gen.ts` に追加：

```typescript
// アセットのソース種別（拡張性を考慮）
type AssetSourceType =
  | 'generated'   // AI生成
  | 'uploaded';   // ユーザーアップロード

// 将来の拡張例:
// | 'external_url'  // 外部URL参照
```

#### SceneImage型の拡張

```typescript
interface SceneImage {
  sceneId: string;
  sceneOrder: number;
  visualType: VisualType;
  hasImagePrompt: boolean;
  imagePrompt: string | null;
  imageStyleHint: string | null;
  hasImage: boolean;
  asset: {
    assetId: string;
    fileUrl: string;
    sourceType: AssetSourceType;  // 追加
    mimeType: string;             // 追加（拡張性のため）
  } | null;
}
```

### メディアファイル抽象化（拡張性対応）

将来の動画アップロード対応を見据え、メディアファイルを抽象化する型を定義：

```typescript
// メディアタイプ
type MediaType = 'image' | 'video';

// アップロード可能なメディアファイルの抽象インターフェース
interface UploadableMedia {
  file: File;
  mediaType: MediaType;
  mimeType: string;
}

// バリデーション設定（メディアタイプ別）
interface MediaValidationConfig {
  maxSizeBytes: number;
  allowedMimeTypes: string[];
}

const MEDIA_VALIDATION: Record<MediaType, MediaValidationConfig> = {
  image: {
    maxSizeBytes: 10 * 1024 * 1024,  // 10MB
    allowedMimeTypes: ['image/png', 'image/jpeg', 'image/webp'],
  },
  video: {
    maxSizeBytes: 100 * 1024 * 1024,  // 100MB（将来用）
    allowedMimeTypes: ['video/mp4', 'video/webm'],
  },
};
```

### コンポーネント設計

#### 新規コンポーネント: MediaUploadButton

汎用的なメディアアップロードボタンコンポーネントを作成：

```
apps/webapp/src/components/features/shorts-gen/asset-generation/
├── media-upload-button.tsx    # 新規: 汎用メディアアップロードボタン
└── ...
```

**Props設計**:
```typescript
interface MediaUploadButtonProps {
  mediaType: MediaType;
  onUpload: (media: UploadableMedia) => Promise<void>;
  disabled?: boolean;
  isUploading?: boolean;
}
```

#### scene-asset-item.tsx の変更

画像カラムの右側UIを変更：
1. 「生成」ボタンの横に「アップロード」ボタンを追加
2. 画像プレビュー下部にソースラベルを表示
3. アップロード中の状態表示（スピナー）

### 状態管理設計

#### use-asset-generation.ts の拡張

```typescript
interface ImageAssetState {
  status: 'idle' | 'generating' | 'uploading' | 'completed' | 'error';
  asset: SceneAsset | null;
  sourceType: AssetSourceType | null;  // 追加
  error: string | null;
}

// フックに追加するメソッド
interface UseAssetGenerationReturn {
  // ... 既存のメソッド
  uploadImage: (sceneId: string, file: File) => Promise<void>;
}
```

### API設計（フロントエンド側）

#### 新規Server Action

```
apps/webapp/src/server/presentation/actions/shorts-gen/
├── uploadSceneImage.ts    # 新規
└── ...
```

**シグネチャ**:
```typescript
async function uploadSceneImage(
  sceneId: string,
  formData: FormData
): Promise<{ success: true; asset: SceneAsset } | { success: false; error: string }>;
```

#### 新規API Route

```
apps/webapp/src/app/api/shorts-gen/scenes/[sceneId]/
├── image/route.ts           # 既存（POST: 生成）
├── image-upload/route.ts    # 新規（POST: アップロード）
└── ...
```

---

## 影響範囲

### フロントエンド

| ファイル | 変更内容 |
|----------|----------|
| `apps/shared/types/shorts-gen.ts` | `AssetSourceType`、`SceneImage`型の拡張 |
| `scene-asset-item.tsx` | アップロードボタン追加、ソースラベル表示 |
| `use-asset-generation.ts` | `uploadImage`メソッド追加、状態管理拡張 |
| `project-detail-client.tsx` | `handleImageUpload`コールバック追加 |
| `asset-generation-step.tsx` | `onImageUpload` prop追加 |
| 新規: `media-upload-button.tsx` | 汎用アップロードボタンコンポーネント |
| 新規: `uploadSceneImage.ts` | Server Action |
| 新規: `image-upload/route.ts` | API Route |

### バックエンド（別途設計が必要）

- シーン画像アップロード用エンドポイント
- アセット登録処理の拡張（sourceTypeの保存）
- ファイルバリデーション

---

## ファイルバリデーション仕様

| 項目 | 値 |
|------|-----|
| 最大ファイルサイズ | 10MB |
| 許可フォーマット | PNG, JPEG, WebP |
| 許可MIMEタイプ | `image/png`, `image/jpeg`, `image/webp` |

---

## ユーザー操作フロー

```
1. ユーザーが画像カラムの「アップロード」ボタンをクリック
2. ファイル選択ダイアログが表示される
3. ユーザーが画像ファイルを選択
4. フロントエンドでバリデーション（サイズ、形式）
5. バリデーションOKの場合、アップロード処理開始
6. スピナー表示
7. アップロード完了後、画像プレビューを更新
8. ソースラベル「アップロード」を表示
```

---

## 考慮事項

### 画像生成との共存

- アップロード後も「生成」ボタンは有効のまま
- 「生成」を実行するとアップロード画像は上書きされる
- 逆も同様（生成済み画像はアップロードで上書き可能）

### エラーハンドリング

| エラー種別 | 対応 |
|-----------|------|
| ファイルサイズ超過 | クライアント側でバリデーション、エラートースト表示 |
| 非対応形式 | クライアント側でバリデーション、エラートースト表示 |
| アップロード失敗 | リトライボタン表示、エラーメッセージ表示 |

### 一括アップロードについて

本設計では個別シーンへのアップロードのみを対象とする。一括アップロード機能は対象外とする。

---

## 将来の動画アップロード対応への拡張ポイント

本設計では以下の点で動画アップロードへの拡張を容易にしている：

1. **MediaType型**: `'image' | 'video'` で種別を管理
2. **MediaValidationConfig**: メディアタイプ別のバリデーション設定
3. **MediaUploadButton**: メディアタイプを引数で受け取る汎用コンポーネント
4. **mimeType保存**: アセットにmimeTypeを保存し、Compose時に適切に処理可能

動画対応時の主な追加作業：
- `MediaType`に`'video'`を追加（設計済み）
- `MEDIA_VALIDATION.video`の設定（設計済み）
- バックエンドでの動画ファイル処理
- Compose工程での動画素材対応

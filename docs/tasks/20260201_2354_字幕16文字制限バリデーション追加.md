# 字幕16文字制限バリデーション追加

## 目的

動画制作者が、字幕が16文字を超えて読みにくくなる問題を防ぐため

## 背景

ショート動画の字幕は1行あたり16文字が表示上限となっている。現在はこの制約がドメインモデルで検証されておらず、AIが生成した字幕がそのまま保存されてしまう。これにより、字幕が途中で切れたり、読みにくい動画が生成される可能性がある。

## 変更概要

1. **ドメイン層**: `ShortsScene`モデルにsubtitlesの各要素が16文字以内であることのバリデーションを追加
2. **プロンプト**: 台本生成AIへの指示に16文字制限と分割ルールを追加

---

## 設計詳細

### 1. ドメインモデルの変更

**対象ファイル**: [apps/backend/src/contexts/shorts-gen/domain/models/scene.ts](../../apps/backend/src/contexts/shorts-gen/domain/models/scene.ts)

#### 1.1 新しいエラー型の追加

```typescript
export type ShortsSceneError =
  | { type: 'INVALID_SCRIPT_ID'; message: string }
  | { type: 'INVALID_ORDER'; message: string }
  | { type: 'INVALID_SUMMARY'; message: string }
  | { type: 'INVALID_VISUAL_TYPE'; message: string }
  | { type: 'MISSING_STOCK_VIDEO_KEY'; message: string }
  | { type: 'MISSING_SOLID_COLOR'; message: string }
  | { type: 'INVALID_SILENCE_DURATION'; message: string }
  | { type: 'MISSING_VOICE_OR_SILENCE'; message: string }
  | { type: 'SUBTITLE_TOO_LONG'; message: string };  // 追加
```

#### 1.2 定数の追加

```typescript
const MAX_SUBTITLE_LENGTH = 16;
```

#### 1.3 バリデーション関数の追加

```typescript
function validateSubtitles(subtitles: string[]): Result<void, ShortsSceneError> {
  for (let i = 0; i < subtitles.length; i++) {
    const subtitle = subtitles[i];
    if (subtitle && subtitle.length > MAX_SUBTITLE_LENGTH) {
      return err({
        type: 'SUBTITLE_TOO_LONG',
        message: `Subtitle at index ${i} exceeds ${MAX_SUBTITLE_LENGTH} characters: "${subtitle}" (${subtitle.length} chars)`,
      });
    }
  }
  return ok(undefined);
}
```

#### 1.4 createメソッドへのバリデーション追加

`ShortsScene.create()`内で、シーン作成時にsubtitlesのバリデーションを実行する。

#### 1.5 withSubtitlesメソッドの変更

現在の`withSubtitles`は`ShortsScene`を直接返しているが、バリデーションを追加するため`Result`型を返すように変更する。

```typescript
// Before
withSubtitles(subtitles: string[]): ShortsScene

// After
withSubtitles(subtitles: string[]): Result<ShortsScene, ShortsSceneError>
```

**影響範囲**: `withSubtitles`を使用している箇所を調査し、Result型への対応が必要。

---

### 2. プロンプトの変更

**対象ファイル**: [apps/backend/src/contexts/shorts-gen/application/usecases/generate-script.usecase.ts](../../apps/backend/src/contexts/shorts-gen/application/usecases/generate-script.usecase.ts)

#### 2.1 システムプロンプトへの制約追加

`SYSTEM_PROMPT_BASE`の「台本の要件」セクションに以下を追加:

```
3. **字幕の制約**
   - 各字幕は16文字以内にすること（絶対厳守）
   - 16文字を超える内容は、複数の字幕に分割すること
   - 例: 「政治に関心を持ってもらうためには」（17文字）
     → 「政治に関心を」「持ってもらうためには」（8文字、9文字）
   - 自然な区切りで分割し、読みやすさを優先すること
```

#### 2.2 ツール定義のdescription更新

`SAVE_SCRIPT_TOOL`内のsubtitlesのdescriptionを更新:

```typescript
subtitles: {
  type: 'array',
  items: { type: 'string' },
  description: '字幕テキストの配列（1シーンに複数可、各字幕は16文字以内）',
}
```

---

### 3. ユニットテストの追加

**対象ファイル**: 新規作成 or 既存のsceneテストファイルに追加

テストケース:
1. 16文字以内の字幕が正常に保存できること
2. 16文字ちょうどの字幕が正常に保存できること
3. 17文字以上の字幕でエラーになること
4. 複数の字幕のうち1つでも17文字以上ならエラーになること
5. 空配列の字幕が正常に保存できること
6. `withSubtitles`で17文字以上の字幕を設定しようとするとエラーになること

---

## 影響範囲

### 変更が必要なファイル

| ファイル | 変更内容 |
|----------|----------|
| `scene.ts` | バリデーション追加、`withSubtitles`の戻り値変更 |
| `generate-script.usecase.ts` | プロンプト・ツール定義の更新 |
| `script.routes.ts` | `withSubtitles`呼び出し箇所のResult型対応 |

### 呼び出し元の変更

`withSubtitles`メソッドの戻り値が`Result`型に変更されるため、以下の呼び出し元を修正する。

**対象ファイル**: [apps/backend/src/contexts/shorts-gen/presentation/routes/script.routes.ts:472](../../apps/backend/src/contexts/shorts-gen/presentation/routes/script.routes.ts#L472)

```typescript
// Before
if (body.subtitles !== undefined) {
  updatedScene = updatedScene.withSubtitles(body.subtitles);
}

// After
if (body.subtitles !== undefined) {
  const result = updatedScene.withSubtitles(body.subtitles);
  if (!result.success) {
    throw new ValidationError(result.error.message);
  }
  updatedScene = result.value;
}
```

---

## 考慮事項

### AIが制約を守らない場合

ドメイン層のバリデーションで保存を拒否するため、ユーザーには保存失敗のエラーが表示される。この場合、AIに再度修正を依頼するか、手動で字幕を編集する必要がある。

### 既存データへの影響

既存の保存済みデータには影響しない（`fromProps`はバリデーションをスキップする設計のため）。ただし、既存データを`withSubtitles`で更新しようとした場合は新しいバリデーションが適用される。

---

## チェックリスト

- [x] Gateway はドメインの言葉で定義されているか → 該当なし（Gatewayの変更なし）
- [x] Application は Infrastructure に直接依存していないか → 準拠
- [x] Context 間の直接依存がないか → 準拠
- [x] shared にビジネスロジックが含まれていないか → 準拠
- [x] Domain 層のエラーは Result 型を使っているか → 準拠（`SUBTITLE_TOO_LONG`エラーをResult型で返す）

# 画像アップロードバックエンド設計

## 目的

**ユーザーが**手持ちの画像をシーンにアップロードしたい**ときに**、バックエンドでファイルを受け取り、ストレージに保存してシーンアセットとして登録するため。

## 概要

フロントエンドの画像アップロード機能（[20260202_1048_画像アップロード機能設計.md](./20260202_1048_画像アップロード機能設計.md)）に対応するバックエンドAPIを設計する。

### スコープ

- **対象**: バックエンドAPI（shorts-gen bounded context）
- **対象外**: フロントエンド（設計・実装済み）

---

## 現状分析

### フロントエンドが期待するAPI

フロントエンドのBFFレイヤー（`apps/webapp/src/app/api/shorts-gen/scenes/[sceneId]/image-upload/route.ts`）は以下のエンドポイントを呼び出す：

```
POST /api/shorts-gen/scenes/:sceneId/images/upload
Content-Type: multipart/form-data
```

**リクエスト**:
- フィールド名: `image`
- ファイル形式: PNG, JPEG, WebP
- 最大サイズ: 10MB

**レスポンス（成功時）**:
```json
{
  "assetId": "uuid",
  "fileUrl": "https://storage.example.com/signed-url..."
}
```

**レスポンス（エラー時）**:
```json
{
  "error": "VALIDATION_ERROR",
  "message": "File size exceeds limit"
}
```

### 既存の関連コード

| ファイル | 役割 |
|----------|------|
| `presentation/routes/image.routes.ts` | 画像生成エンドポイント（追加先） |
| `presentation/routes/reference-character.routes.ts` | ファイルアップロードのパターン参照 |
| `domain/models/scene-asset.ts` | ShortsSceneAssetドメインモデル |
| `domain/gateways/scene-asset-repository.gateway.ts` | アセットリポジトリインターフェース |
| `infrastructure/repositories/scene-asset.repository.ts` | アセットリポジトリ実装 |
| `shared/infrastructure/clients/temp-storage.client.ts` | ストレージクライアント |

### 既存の参照パターン

`reference-character.routes.ts`のファイルアップロード処理：

1. multerでmemoryStorageを使用
2. ファイルサイズ・MIMEタイプをmulterでフィルタリング
3. TempStorageGatewayでクラウドストレージにアップロード
4. 署名付きURLを生成して返却

---

## API設計

### エンドポイント

```
POST /api/shorts-gen/scenes/:sceneId/images/upload
```

### パスパラメータ

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| sceneId | string (UUID) | 画像を登録するシーンのID |

### リクエスト

| 項目 | 値 |
|------|-----|
| Content-Type | multipart/form-data |
| フィールド名 | image |
| 最大ファイルサイズ | 10MB |
| 許可MIMEタイプ | image/png, image/jpeg, image/webp |

### レスポンス

**成功時 (200)**:
```typescript
{
  assetId: string;   // 作成されたアセットのID
  fileUrl: string;   // 署名付きURL
}
```

**エラー時 (400/404/500)**:
```typescript
{
  error: string;     // エラーコード
  message: string;   // エラーメッセージ
}
```

### エラーコード

| コード | HTTPステータス | 説明 |
|--------|---------------|------|
| VALIDATION_ERROR | 400 | ファイルサイズ超過、非対応形式 |
| NOT_FOUND | 404 | シーンが存在しない |
| INVALID_SCENE_TYPE | 400 | シーンのvisualTypeがimage_genでない |
| INTERNAL_ERROR | 500 | サーバーエラー |

---

## レイヤー別設計

### Presentation層

**ファイル**: `apps/backend/src/contexts/shorts-gen/presentation/routes/image.routes.ts`

既存のimage.routes.tsにエンドポイントを追加する。

**処理フロー**:
1. multerでファイルを受け取る（memoryStorage）
2. UseCaseを呼び出す
3. 結果をJSONで返却

**multer設定**:
- storage: memoryStorage
- limits: { fileSize: 10 * 1024 * 1024 }
- fileFilter: image/png, image/jpeg, image/webp のみ許可

### Application層

**ファイル**: `apps/backend/src/contexts/shorts-gen/application/usecases/upload-scene-image.usecase.ts`

**入力**:
```typescript
interface UploadSceneImageInput {
  sceneId: string;
  file: {
    buffer: Buffer;
    mimetype: string;
    originalname: string;
  };
}
```

**出力**:
```typescript
interface UploadSceneImageResult {
  assetId: string;
  fileUrl: string;
}
```

**依存するGateway**:
- ShortsSceneRepositoryGateway: シーンの存在確認
- ShortsSceneAssetRepositoryGateway: アセットの保存・削除
- TempStorageGateway: ファイルのアップロード・署名付きURL生成

**処理フロー**:
1. シーンの存在確認（存在しない場合はNotFoundError）
2. シーンのvisualTypeが`image_gen`であることを確認
3. ファイルをストレージにアップロード
4. 既存の`background_image`アセットがあれば削除
5. 新しいShortsSceneAssetを作成・保存
6. assetIdと署名付きURLを返却

### Domain層

既存のドメインモデルを使用する。変更は不要。

**使用するモデル**: `ShortsSceneAsset`

**アセット作成時のプロパティ**:
```typescript
{
  id: generateId(),
  sceneId: input.sceneId,
  assetType: 'background_image',
  fileUrl: uploadedFileUrl,
  durationMs: null,
  metadata: {
    sourceType: 'uploaded',
    originalFilename: file.originalname,
    mimeType: file.mimetype,
  },
  createdAt: new Date(),
}
```

### Infrastructure層

既存のインフラを使用する。変更は不要。

**ストレージパス規則**:
```
shorts-gen/images/scene_{sceneId}_uploaded_{uuid}.{ext}
```

拡張子は元のファイルのMIMEタイプから決定する：
- image/png → png
- image/jpeg → jpg
- image/webp → webp

---

## ファイル構成

### 新規作成

| ファイル | 役割 |
|----------|------|
| `application/usecases/upload-scene-image.usecase.ts` | アップロードユースケース |

### 変更

| ファイル | 変更内容 |
|----------|----------|
| `presentation/routes/image.routes.ts` | アップロードエンドポイント追加 |
| `presentation/routes/index.ts` | ルーティング追加（必要な場合） |

---

## テスト戦略

### ユニットテスト

**ファイル**: `test/unit/contexts/shorts-gen/application/usecases/upload-scene-image.usecase.test.ts`

| テストケース | 期待結果 |
|--------------|----------|
| 正常系: 画像アップロード成功 | assetIdとfileUrlが返る |
| シーンが存在しない | NotFoundErrorがthrowされる |
| visualTypeがimage_genでない | BadRequestErrorがthrowされる |
| 既存アセットがある場合 | 古いアセットが削除され新しいアセットが作成される |

### 統合テスト

**ファイル**: `test/integration/contexts/shorts-gen/presentation/routes/image.routes.test.ts`

| テストケース | 期待結果 |
|--------------|----------|
| 正常系: ファイルアップロード | 200, { assetId, fileUrl } |
| ファイルなし | 400 |
| ファイルサイズ超過 | 400 |
| 非対応MIMEタイプ | 400 |
| 存在しないシーンID | 404 |

---

## 影響範囲

### 変更が必要なファイル

```
apps/backend/src/contexts/shorts-gen/
├── presentation/routes/
│   └── image.routes.ts           # エンドポイント追加
└── application/usecases/
    └── upload-scene-image.usecase.ts  # 新規作成
```

### 変更不要なファイル

- domain層: 既存のShortsSceneAssetモデルをそのまま使用
- infrastructure層: 既存のrepository、clientをそのまま使用
- shared層: 変更不要

---

## 考慮事項

### 画像生成との共存

アップロードと生成は互いに上書き可能。同一シーンに対して：
- アップロード後に生成 → アップロード画像が削除され、生成画像が登録される
- 生成後にアップロード → 生成画像が削除され、アップロード画像が登録される

両方とも`assetType: 'background_image'`として扱い、同一シーンには1つのbackground_imageのみ存在する。

### メタデータによるソース識別

`metadata.sourceType`フィールドで生成とアップロードを区別する：
- 生成: `{ sourceType: 'generated', ... }`
- アップロード: `{ sourceType: 'uploaded', originalFilename, mimeType }`

これにより、フロントエンドでソースラベル（「生成」「アップロード」）を表示できる。

### ファイル削除

ストレージ上の古いファイルの削除はこのスコープに含めない。アセットレコードの削除のみ行い、ストレージの整理は別途バッチ処理等で対応する想定。

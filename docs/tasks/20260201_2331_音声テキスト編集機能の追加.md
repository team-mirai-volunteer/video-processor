# 音声テキスト編集機能の追加（④素材生成画面）

## 目的

動画制作者が、④素材生成画面で音声テキストを直接編集し再生成できるようにするため。
これにより、③台本画面に戻らずに微調整ができ、作業効率が向上する。

---

## 現状分析

### 現在のUI構成

④素材生成画面（`AssetGenerationStep`）は3カラム構成：
- 左: ④音声（voiceText → TTS → 音声ファイル）
- 中: ⑤字幕（subtitles → 字幕画像）
- 右: ⑥⑦画像（imagePrompt → 画像生成）

### 現在の音声カラムの表示

`SceneAssetItem`コンポーネントでシーンごとに以下を表示：
- ステータスアイコン（pending/running/completed/error）
- シーン番号
- voiceText（30文字で切り詰め、読み取り専用）
- 生成済みの場合は音声プレーヤー
- 再生成ボタン

### データフロー（現状）

```
③台本（SceneEditor）
    ↓ voiceText を編集・保存
    ↓ PATCH /api/shorts-gen/projects/{projectId}/scenes/{sceneId}
    ↓
④素材生成（AssetGenerationStep）
    ↓ scenes prop として voiceText を受け取る（読み取り専用）
    ↓ POST /api/shorts-gen/scenes/{sceneId}/voice
    ↓ 音声生成
```

---

## 設計

### 要件

1. ④素材生成画面の音声カラムで、シーンごとの`voiceText`を直接編集できる
2. 編集した内容を保存すると、③台本のデータにも反映される（共通のデータソース）
3. 編集後に再生成ボタンを押すと、新しいテキストで音声が生成される

### UI変更

#### `SceneAssetItem`コンポーネント（音声カラム用）の変更

**Before**:
```
┌─────────────────────────────────────┐
│ ✓ 🔊 シーン 1                    🔄 │
│ これは読み上げるテキストです...    │
│ [▶️ 音声プレーヤー]                 │
└─────────────────────────────────────┘
```

**After**:
```
┌─────────────────────────────────────┐
│ ✓ 🔊 シーン 1              [保存] 🔄│
│ ┌─────────────────────────────────┐ │
│ │ これは読み上げるテキストです   │ │
│ │ （編集可能なTextarea）         │ │
│ └─────────────────────────────────┘ │
│ [▶️ 音声プレーヤー]                 │
└─────────────────────────────────────┘
```

- Textareaで`voiceText`を編集可能にする
- 編集中は「保存」ボタンを表示（変更がある場合のみアクティブ）
- 保存すると③台本のデータも更新される
- 再生成ボタン（🔄）は保存後に有効化

### コンポーネント変更

#### 1. `SceneAssetItem`の拡張

```typescript
// 追加するprops
interface SceneAssetItemProps {
  // 既存props...

  // 音声カラム用の編集機能
  onVoiceTextChange?: (sceneId: string, newVoiceText: string) => void;
  onVoiceTextSave?: (sceneId: string, newVoiceText: string) => Promise<void>;
  isVoiceTextSaving?: boolean;
}
```

#### 2. `AssetGenerationStep`の拡張

```typescript
// 追加するprops
interface AssetGenerationStepProps {
  // 既存props...

  // シーン更新コールバック（③台本と共有）
  onSceneUpdate?: (sceneId: string, params: { voiceText?: string }) => Promise<void>;
  onScenesChange?: (updatedScenes: Scene[]) => void;
}
```

#### 3. `useAssetGeneration`フックの拡張

ローカル状態として編集中の`voiceText`を保持：

```typescript
interface AssetGenerationState {
  // 既存state...

  // 編集中のvoiceText（シーンIDをキーとする）
  editingVoiceText: Record<string, string>;
}
```

### データフロー（変更後）

```
④素材生成（AssetGenerationStep）
    ↓ voiceText をTextareaで編集
    ↓ [保存] ボタン押下
    ↓
    ├─→ onSceneUpdate(sceneId, { voiceText })
    │       ↓ PATCH /api/shorts-gen/projects/{projectId}/scenes/{sceneId}
    │       ↓ DB更新（③台本と共通のScene）
    │
    └─→ onScenesChange(updatedScenes)
            ↓ 親コンポーネント（ProjectDetailClient）のscenes stateを更新
            ↓ ③台本のUIにも反映される
```

### 状態管理

`ProjectDetailClient`が管理する`scenes` stateを単一のデータソースとして使用：

1. ④素材生成画面でvoiceTextを編集
2. 保存時に`handleSaveScene`を呼び出し（既存のAPI）
3. 保存成功後、`setScenes`で親の状態を更新
4. 更新された`scenes`が③台本画面にも反映される

### ファイル変更一覧

| ファイル | 変更内容 |
|----------|----------|
| `scene-asset-item.tsx` | 音声カラム用の編集UI追加（Textarea、保存ボタン） |
| `asset-generation-step.tsx` | `onSceneUpdate` propsの追加、AssetColumnへの伝播 |
| `use-asset-generation.ts` | 編集中テキストのローカル状態管理 |
| `project-detail-client.tsx` | `onSceneUpdate`の接続、scenes状態の更新 |

---

## 実装ステップ

### Step 1: `SceneAssetItem`に音声編集UIを追加

- 音声カラム（`columnType === 'voice'`）の場合に編集可能なTextareaを表示
- 編集中の値をローカルstateで管理
- 「保存」ボタンの追加（変更がある場合のみ有効）

### Step 2: `AssetGenerationStep`に保存機能を追加

- `onSceneUpdate` propsを受け取る
- `AssetColumn`経由で`SceneAssetItem`に伝播
- 保存成功後に`scenes` propsの更新をトリガー

### Step 3: `ProjectDetailClient`の接続

- 既存の`handleSaveScene`を`AssetGenerationStep`に渡す
- 保存成功後に`setScenes`でローカル状態を更新

### Step 4: 動作確認

- ④素材生成画面でvoiceTextを編集・保存
- ③台本画面を開いて、変更が反映されていることを確認
- 音声再生成が新しいテキストで動作することを確認

---

## 考慮事項

### 未保存の変更の扱い

- 編集中に別のシーンを操作しようとした場合
  - 特に警告は出さず、編集中の内容はローカルに保持
  - 保存ボタンを押すまでDBには反映されない

### 空文字の扱い

- voiceTextを空にして保存した場合は無音シーンとして扱う
- 既存の仕様と同様に`silenceDurationMs`が必要になる可能性があるが、今回のスコープ外

### 同時編集

- 今回のスコープでは考慮しない（単一ユーザー想定）

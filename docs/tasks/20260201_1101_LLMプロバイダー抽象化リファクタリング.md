# LLMプロバイダー抽象化リファクタリング

## 目的

開発チームが、shorts-gen機能のLLMをOpenAI GPTからClaude Sonnetに切り替えられるようにするため。
また、将来的に他のプロバイダー（Gemini等）を追加する際にも、最小限の変更で対応できる構造にする。

## 現状

### ファイル構成

```
apps/backend/src/contexts/shorts-gen/
├── domain/gateways/
│   └── agentic-ai.gateway.ts       # インターフェース定義
└── infrastructure/clients/
    └── openai-agentic.client.ts    # OpenAI実装（412行）
```

### 問題点

`OpenAiAgenticClient` が以下の責務を全て持っている:

1. **モデル初期化** - OpenAI固有（`openai(this.model)`）
2. **メッセージ変換** - プロバイダー共通（`convertMessages`）
3. **ツール変換** - プロバイダー共通（`convertTools`, `convertParametersToZod`）
4. **API呼び出し** - プロバイダー共通（`generateText`, `streamText`）
5. **ストリーム処理** - プロバイダー共通（`createStreamIterator`）
6. **エラーマッピング** - プロバイダー共通（`mapError`, `mapFinishReason`）

Claude用の実装を追加する場合、2〜6の処理をコピーする必要があり、DRY原則に反する。

## 設計

### ファイル構成（変更後）

```
apps/backend/src/contexts/shorts-gen/
├── domain/gateways/
│   └── agentic-ai.gateway.ts              # 変更なし
└── infrastructure/clients/
    ├── agentic-client-core.ts             # 新規: 共通処理
    ├── openai-agentic.client.ts           # 変更: ファサード化
    └── anthropic-agentic.client.ts        # 新規: Claudeファサード
```

### クラス図

```
AgenticAiGateway (interface)
        ↑ implements
        │
   ┌────┴────┐
   │         │
OpenAi    Anthropic
Agentic   Agentic
Client    Client
(facade)  (facade)
   │         │
   └────┬────┘
        │ uses
        ↓
AgenticClientCore
(共通処理)
```

### 各クラスの責務

#### AgenticClientCore

Vercel AI SDKを使った共通処理を担当。

**コンストラクタ引数:**
- `model: LanguageModel` - Vercel AI SDKのモデルオブジェクト

**メソッド:**
- `chat(params: ChatParams): Promise<Result<ChatCompletionResult, AgenticAiGatewayError>>`
- `chatStream(params: ChatParams): Promise<Result<AsyncIterable<StreamChunk>, AgenticAiGatewayError>>`

**内部処理（既存コードから移動）:**
- `convertMessages()`
- `convertTools()`
- `convertParametersToZod()`
- `convertPropertyToZod()`
- `createStreamIterator()`
- `extractToolCalls()`
- `mapFinishReason()`
- `mapError()`

#### OpenAiAgenticClient（ファサード）

**責務:** OpenAIモデルの初期化のみ

```typescript
export class OpenAiAgenticClient implements AgenticAiGateway {
  private readonly core: AgenticClientCore;

  constructor(model?: string) {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      throw new Error('OPENAI_API_KEY environment variable is required');
    }
    const modelName = model ?? process.env.OPENAI_MODEL ?? 'gpt-4o';
    this.core = new AgenticClientCore(openai(modelName));
  }

  chat(params: ChatParams) {
    return this.core.chat(params);
  }

  chatStream(params: ChatParams) {
    return this.core.chatStream(params);
  }
}
```

#### AnthropicAgenticClient（ファサード）

**責務:** Anthropicモデルの初期化のみ

```typescript
export class AnthropicAgenticClient implements AgenticAiGateway {
  private readonly core: AgenticClientCore;

  constructor(model?: string) {
    const apiKey = process.env.ANTHROPIC_API_KEY;
    if (!apiKey) {
      throw new Error('ANTHROPIC_API_KEY environment variable is required');
    }
    const modelName = model ?? process.env.ANTHROPIC_MODEL ?? 'claude-sonnet-4-20250514';
    this.core = new AgenticClientCore(anthropic(modelName));
  }

  chat(params: ChatParams) {
    return this.core.chat(params);
  }

  chatStream(params: ChatParams) {
    return this.core.chatStream(params);
  }
}
```

### 依存パッケージ

追加が必要:
```bash
pnpm --filter backend add @ai-sdk/anthropic
```

### 環境変数

追加が必要:
- `ANTHROPIC_API_KEY` - Anthropic APIキー（必須）
- `ANTHROPIC_MODEL` - モデル名（オプション、デフォルト: `claude-sonnet-4-20250514`）

### 利用側の変更

Route層でインスタンス化するClientを差し替えるだけ。

```typescript
// Before
const agenticAiGateway = new OpenAiAgenticClient();

// After
const agenticAiGateway = new AnthropicAgenticClient();
```

## 実装手順

1. `@ai-sdk/anthropic` パッケージをインストール
2. `AgenticClientCore` を新規作成し、`OpenAiAgenticClient` から共通処理を移動
3. `OpenAiAgenticClient` をファサード化（Coreに委譲）
4. `AnthropicAgenticClient` を新規作成
5. 既存のユニットテストが通ることを確認
6. Route層のClientを `AnthropicAgenticClient` に差し替え
7. 動作確認

## テスト方針

- `AgenticClientCore` のユニットテストを追加（既存テストを移動・拡張）
- ファサードクラスはモデル初期化のテストのみ（APIキー未設定時のエラー等）
- 統合テストは既存のものがそのまま使える（インターフェースは変わらないため）

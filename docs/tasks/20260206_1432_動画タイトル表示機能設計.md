# 動画タイトル表示機能設計

## 目的

clip-video機能のユーザーが、字幕付き動画にタイトルテキストを常時表示させることで、動画の内容や文脈を視聴者に伝えやすくするため。

## 概要

字幕合成時に、動画の上部にタイトルテキストを常時表示する機能を追加する。タイトルは動画の最初から最後まで同じ文字が表示され続ける。

## 仕様

### タイトルテキスト

| 項目 | 仕様 |
|------|------|
| 値 | `string \| null` |
| null時の挙動 | タイトルなし（描画しない） |
| 最大文字数 | 20文字 |
| 表示タイミング | 動画の最初から最後まで常時表示 |

### 文字色

- 字幕の色（`outlineColor`）と連動する
- タイトル独自の色設定は持たない
- 字幕と同じ `outlineColor` の値がタイトルのフォント色として使われる

### 文字サイズ

| 項目 | 仕様 |
|------|------|
| 設定 | タイトル専用の `titleFontSize` で個別に指定可能 |
| 階級 | 字幕と同じ `SubtitleFontSize`（`small` / `medium` / `large`） |
| デフォルト | `medium` |
| 計算方法 | 字幕と同じ `FONT_SIZE_RATIO` を使用（動画横幅に対する比率） |

### 表示位置

- 動画の上の方に水平中央揃え（`x=(w-text_w)/2`）で表示
- 縦位置はタイトルテキストの**上端**を基準に配置する

#### 縦動画（9:16）の場合

9:16動画の中央に配置される9:9正方形の**上端**にタイトルの上端を合わせる。

```
+-------------------+
|                   |   ← padding領域
|                   |
|=== タイトル上端 ===|   ← y = (H - W) / 2
|                   |
|     9:9 正方形     |
|      領域          |
|                   |
|    （字幕領域）     |
|                   |
|===================|   ← 正方形下端
|                   |
+-------------------+
```

- 計算式: `y = (height - width) / 2`
- 例: 1080x1920 の場合 → `y = (1920 - 1080) / 2 = 420px`

#### 横動画・オリジナルの場合

動画上端から一定マージンの位置にタイトル上端を配置する。

- 計算式: `y = height * 0.05`（上端から5%の位置）

### 文字スタイル

| 項目 | 仕様 |
|------|------|
| フォント | 字幕と同じ（`Noto Sans CJK JP`） |
| フォント色 | 字幕の `outlineColor` と同じ値 |
| アウトライン | 白（`#FFFFFF`）。字幕と逆転（字幕は白文字+色アウトライン、タイトルは色文字+白アウトライン） |
| アウトライン幅 | 字幕と同じ比率で算出 |
| 影 | 字幕と同じ設定 |
| 太字 | 有効 |

## 変更箇所

### 1. 共有型定義（`apps/shared`）

#### `apps/shared/types/api.ts`

`ComposeSubtitledClipRequest` にタイトル関連フィールドを追加:

- `titleText?: string | null` — タイトルテキスト（null or 未指定でタイトルなし）
- `titleFontSize?: SubtitleFontSize` — タイトルフォントサイズ（デフォルト: `medium`）

#### `apps/shared/types/clip-subtitle.ts`

タイトルの最大文字数定数を追加:

- `TITLE_MAX_CHARS = 20`

### 2. バックエンド

#### Domain Gateway: `clip-subtitle-composer.gateway.ts`

`ClipSubtitleComposeParams` にタイトル関連パラメータを追加:

- `titleText?: string | null` — タイトルテキスト
- `titleFontSize?: SubtitleFontSize` — タイトルフォントサイズ

#### Infrastructure Client: `clip-subtitle-compose.client.ts`

`compose` メソッド内で、`titleText` が指定されている場合にタイトル用の `drawtext` フィルタを追加生成する。

タイトル用フィルタの特徴:
- `enable` を指定しない（常時表示）
- Y座標は `calculateTitleVerticalPosition()` で算出
  - 縦動画: `(height - width) / 2`（上端基準）
  - その他: `height * 0.05`
- フォント色は `style.outlineColor`（字幕の枠色をタイトルのメイン色として使用）
- アウトライン色は `#FFFFFF`（白）

#### Application UseCase: `compose-subtitled-clip.usecase.ts`

`ComposeSubtitledClipInput` に `titleText` と `titleFontSize` を追加し、composer gateway に渡す。

#### Presentation Routes

compose エンドポイントのリクエストボディから `titleText`, `titleFontSize` を受け取り、usecase に渡す。`titleText` のバリデーション（20文字上限）を行う。

### 3. フロントエンド

#### `subtitle-composition-status.tsx`

字幕合成設定UIに以下を追加:

- **タイトル入力欄**: テキスト入力（最大20文字、プレースホルダー「タイトルを入力（任意）」）
- **タイトルフォントサイズ選択**: 大 / 中 / 小（字幕フォントサイズ選択と同じUI）

タイトル入力欄は字幕フォントサイズの上、または出力フォーマットの下あたりに配置する。

#### Server Action: `composeSubtitledClip.ts`

`titleText`, `titleFontSize` パラメータをバックエンドAPIに渡すように変更。

#### Backend Client: `backend-client.ts`

compose APIリクエストに `titleText`, `titleFontSize` を含めるように変更。

## バリデーション

| 項目 | ルール | 層 |
|------|--------|-----|
| titleText | null OK / 空文字は null として扱う / 最大20文字 | presentation, application |
| titleFontSize | `small` \| `medium` \| `large` のいずれか | presentation |

## drawtext フィルタ構築イメージ

タイトル用の drawtext フィルタは、字幕用フィルタチェーンの**先頭**に追加する（描画順序で字幕がタイトルの上に重なるようにする）。

```
drawtext=text='タイトルテキスト':font='Noto Sans CJK JP Black':fontsize={算出値}:fontcolor={outlineColor}:bordercolor=0xFFFFFF:borderw={算出値}:shadowcolor=0x000000:shadowx=2:shadowy=2:x=(w-text_w)/2:y={算出Y座標}
```

- `enable` なし → 常時表示
- `fontcolor` = 字幕の `outlineColor`
- `bordercolor` = `0xFFFFFF`（白アウトライン）

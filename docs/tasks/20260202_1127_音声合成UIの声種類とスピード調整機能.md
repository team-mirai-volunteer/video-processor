# 音声合成UIの声種類とスピード調整機能

## 目的

動画クリエイターが、シーンの雰囲気や内容に合わせた音声表現（声の種類・スピード）を選択できるようにするため。

---

## 機能概要

シーンごとに以下を設定可能にする:
- **声の種類**: コードで管理された音声モデルから選択
- **スピード**: スライダーで0.5〜2.0の範囲で調整

---

## 現状分析

### 既存実装

| 項目 | 現状 |
|------|------|
| 音声合成API | Fish Audio TTS使用 |
| 音声モデル | デフォルト1種のみ（環境変数で指定） |
| スピード設定 | Fish Audio APIはサポートしているが未実装 |
| シーンモデル | `voiceText`のみ、声種類・スピードのフィールドなし |

### 関連ファイル

| 種類 | パス |
|------|------|
| TTS Gateway | `apps/backend/src/contexts/shorts-gen/domain/gateways/tts.gateway.ts` |
| TTS Client | `apps/backend/src/contexts/shorts-gen/infrastructure/clients/fish-audio-tts.client.ts` |
| Scene Model | `apps/backend/src/contexts/shorts-gen/domain/models/scene.ts` |
| Asset Registry | `apps/backend/src/contexts/shorts-gen/infrastructure/assets/asset-registry.json` |
| Voice Routes | `apps/backend/src/contexts/shorts-gen/presentation/routes/voice.routes.ts` |
| Scene Editor UI | `apps/webapp/src/components/features/shorts-gen/script/scene-editor.tsx` |
| Asset Item UI | `apps/webapp/src/components/features/shorts-gen/asset-generation/scene-asset-item.tsx` |

---

## 設計

### 1. 声の種類管理（Voice Registry）

動画素材と同様に、`asset-registry.json`に`voices`セクションを追加してコード管理する。
**オープンソース対応のため、音声モデルIDは環境変数で管理する。**

#### asset-registry.jsonの拡張

```json
{
  "videos": { ... },
  "bgm": { ... },
  "voices": {
    "default": {
      "envKey": "FISH_AUDIO_VOICE_DEFAULT",
      "name": "デフォルト",
      "description": "標準的な声"
    }
  }
}
```

#### Voice型定義

| フィールド | 型 | 説明 |
|------------|-----|------|
| envKey | string | 音声モデルIDを格納する環境変数名 |
| name | string | 表示名 |
| description | string | 説明文 |

#### 環境変数設定

```env
# 声の種類ごとに環境変数を設定
FISH_AUDIO_VOICE_DEFAULT=your-voice-model-id-here
```

#### モデルID解決ロジック

1. `voiceKey`からVoice定義を取得
2. Voice定義の`envKey`から環境変数名を取得
3. 環境変数から実際のモデルIDを取得
4. 環境変数が未設定の場合はエラー（または既存の`FISH_AUDIO_DEFAULT_VOICE_MODEL_ID`にフォールバック）

#### スキーマ拡張

`asset-registry.schema.json`に`voices`の定義を追加。

---

### 2. シーンモデルの拡張

`ShortsScene`に以下のフィールドを追加:

| フィールド | 型 | デフォルト値 | 説明 |
|------------|-----|--------------|------|
| voiceKey | string \| null | null | 声の種類キー（nullの場合は"default"） |
| voiceSpeed | number \| null | null | 音声スピード（nullの場合は1.0） |

#### 制約

- `voiceSpeed`の有効範囲: 0.5 〜 2.0
- `voiceKey`は`asset-registry.json`のvoicesに存在するキーのみ許可

---

### 3. DBスキーマ拡張

`ShortsScene`テーブルに以下のカラムを追加:

| カラム | 型 | Nullable | デフォルト |
|--------|-----|----------|-----------|
| voice_key | VARCHAR | YES | NULL |
| voice_speed | FLOAT | YES | NULL |

---

### 4. TTS Gateway拡張

#### TtsSynthesizeParamsの拡張

| フィールド | 型 | 説明 |
|------------|-----|------|
| text | string | 読み上げテキスト |
| voiceModelId | string \| undefined | 音声モデルID |
| speed | number \| undefined | スピード（0.5〜2.0） |

#### Fish Audio Client実装

既存の`FishAudioTtsRequest`の`prosody.speed`フィールドを使用してAPI呼び出しに反映。

---

### 5. API拡張

#### シーン更新API

`PUT /api/shorts-gen/scenes/:sceneId`

リクエストボディに以下を追加:

| フィールド | 型 | 必須 |
|------------|-----|------|
| voiceKey | string \| null | No |
| voiceSpeed | number \| null | No |

#### 音声合成API

`POST /api/shorts-gen/scenes/:sceneId/voice`

シーンに設定された`voiceKey`と`voiceSpeed`を使用して音声合成を実行。

---

### 6. UI設計

#### 6.1 scene-editor.tsx（台本編集ステップ）

音声テキスト入力欄の下に以下を追加:

| UI要素 | 説明 |
|--------|------|
| 声の種類セレクター | ドロップダウンで声を選択 |
| スピードスライダー | 0.5〜2.0の範囲で調整（デフォルト1.0） |
| スピード値表示 | スライダー横に現在値を表示（例: 1.2x） |

#### 6.2 scene-asset-item.tsx（素材生成ステップ）

音声テキスト編集エリアに以下を追加:

| UI要素 | 説明 |
|--------|------|
| 声の種類表示/変更 | セレクターで変更可能 |
| スピード調整スライダー | 変更後は再生成が必要 |

#### レイアウトイメージ

```
┌─────────────────────────────────────────────┐
│ 読み上げテキスト                             │
│ ┌─────────────────────────────────────────┐ │
│ │ AIについて解説します...                  │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ 声の種類: [デフォルト ▼]                    │
│                                             │
│ スピード: [====●======] 1.0x               │
│           0.5          2.0                  │
└─────────────────────────────────────────────┘
```

---

## 実装タスク

### Backend

1. `asset-registry.json`に`voices`セクション追加（envKeyベース）
2. `asset-registry.schema.json`にvoicesスキーマ追加
3. `AssetRegistryGateway`にvoice取得メソッド追加（環境変数からmodelId解決）
4. `.env.example`に`FISH_AUDIO_VOICE_DEFAULT`追加
5. Prismaスキーマに`voice_key`, `voice_speed`カラム追加
6. `ShortsScene`ドメインモデルに`voiceKey`, `voiceSpeed`追加
7. `TtsSynthesizeParams`に`speed`追加
8. `FishAudioTtsClient`でspeedをAPIリクエストに反映
9. シーン更新UseCaseで`voiceKey`, `voiceSpeed`の更新対応
10. 音声合成UseCaseでシーンの設定値を使用

### Frontend

1. Voice Registry取得API呼び出し追加
2. `scene-editor.tsx`に声種類セレクター追加
3. `scene-editor.tsx`にスピードスライダー追加
4. `scene-asset-item.tsx`に声種類・スピード設定UI追加
5. シーン更新時に`voiceKey`, `voiceSpeed`を送信

### DB

1. マイグレーション: `voice_key`, `voice_speed`カラム追加

---

## 初期データ

### voices（初期登録: 1種類）

| key | envKey | name | description |
|-----|--------|------|-------------|
| default | FISH_AUDIO_VOICE_DEFAULT | デフォルト | 標準的な声 |

### 環境変数（.env.example に追記）

```env
# Voice Models (Fish Audio)
# 各声の種類に対応するモデルIDを設定
FISH_AUDIO_VOICE_DEFAULT=your-voice-model-id
```

---

## 注意事項

- `voiceKey`がnullの場合は"default"として扱う
- `voiceSpeed`がnullの場合は1.0として扱う
- 声種類・スピード変更後は音声の再生成が必要
- Fish Audio APIのspeedパラメータの有効範囲は要確認（0.5〜2.0は仮定値）
- **オープンソース対応**: 音声モデルIDはコードにハードコードせず、環境変数で管理する
- 環境変数が未設定の場合、既存の`FISH_AUDIO_DEFAULT_VOICE_MODEL_ID`にフォールバック

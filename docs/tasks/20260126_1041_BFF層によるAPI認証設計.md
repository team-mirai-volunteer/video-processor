# BFF層によるAPI認証設計

## 目的

**内部ツール利用者が、バックエンドAPIを直接外部から叩かれることによる不正利用（API利用料の発生）を防ぐため**

## 背景

- 現状: フロントエンドからバックエンドAPIを直接呼び出している
- 問題: バックエンドURLがブラウザのDevToolsから露出し、curl等で誰でも叩ける
- 対策: Next.jsのサーバーサイド（BFF）を経由させ、API Keyによる認証を追加する

## 設計方針

### 基本構成

```
Browser → Next.js Server (Vercel) → Backend API (Cloud Run)
              ↓                          ↓
         Server Actions/Loaders      API Key認証
         (サーバーサイドのみ)        (X-API-Key header)
```

### レイヤー構成

バックエンドと同じDDD構成に従い、サーバー処理を明示的に分離する:

```
apps/webapp/src/server/
├── presentation/
│   ├── loaders/                   # 読み取り処理（副作用なし）
│   │   ├── loadVideos.ts
│   │   ├── loadVideo.ts
│   │   ├── loadClips.ts
│   │   ├── loadTranscription.ts
│   │   └── loadRefinedTranscription.ts
│   └── actions/                   # 書き込み処理（副作用あり）
│       ├── submitVideo.ts
│       ├── transcribeVideo.ts
│       ├── refineTranscript.ts
│       ├── extractClips.ts
│       └── deleteVideo.ts
└── infrastructure/
    └── clients/
        └── backend-client.ts      # バックエンドAPI呼び出しクライアント
```

※ `application/` と `domain/` はwebappがバックエンドへの薄いBFFであるため、現時点では不要。ロジックが増えた場合に追加する。

### 命名規則

| 種別 | 命名パターン | 例 |
|------|-------------|-----|
| Loader | `load{リソース名}` | `loadVideos`, `loadVideo` |
| Action | `{動詞}{リソース名}` | `submitVideo`, `deleteVideo` |

### Loader/Action の責務

**Loaders（読み取り）**
- `'use server'` ディレクティブを付与
- バックエンドAPIへのGETリクエストをラップ
- キャッシュ戦略の適用（Next.js fetch cache）
- エラーハンドリングとレスポンス整形

**Actions（書き込み）**
- `'use server'` ディレクティブを付与
- バックエンドAPIへのPOST/PUT/DELETE リクエストをラップ
- revalidate によるキャッシュ無効化
- エラーハンドリングとレスポンス整形

## 詳細設計

### 1. バックエンドクライアント

```
server/infrastructure/clients/backend-client.ts
```

- 環境変数から `BACKEND_URL` と `BACKEND_API_KEY` を読み込む
- すべてのリクエストに `X-API-Key` ヘッダーを付与
- エラーレスポンスの統一的なハンドリング

### 2. Loaders 一覧

| ファイル | 対応API | 用途 |
|---------|---------|------|
| `loadVideos.ts` | `GET /api/videos` | 動画一覧取得 |
| `loadVideo.ts` | `GET /api/videos/:id` | 動画詳細取得 |
| `loadClips.ts` | `GET /api/videos/:id/clips` | クリップ一覧取得 |
| `loadTranscription.ts` | `GET /api/videos/:id/transcription` | 文字起こし取得 |
| `loadRefinedTranscription.ts` | `GET /api/videos/:id/transcription/refined` | 校正済み文字起こし取得 |

### 3. Actions 一覧

| ファイル | 対応API | 用途 |
|---------|---------|------|
| `submitVideo.ts` | `POST /api/videos` | 動画登録 |
| `transcribeVideo.ts` | `POST /api/videos/:id/transcribe` | 文字起こし開始 |
| `refineTranscript.ts` | `POST /api/videos/:id/refine-transcript` | 文字起こし校正 |
| `extractClips.ts` | `POST /api/videos/:id/extract-clips` | クリップ切り出し |
| `deleteVideo.ts` | `DELETE /api/videos/:id` | 動画削除 |

### 4. 環境変数

```env
# apps/webapp/.env.local (サーバーサイドのみ、NEXT_PUBLIC_ なし)
BACKEND_URL=https://video-processor-api.a.run.app
BACKEND_API_KEY=your-secret-api-key
```

※ `NEXT_PUBLIC_` プレフィックスを外すことで、クライアントサイドには露出しない

### 5. バックエンド側の変更

バックエンドで `X-API-Key` ヘッダーを検証するミドルウェアを追加:

```
apps/backend/src/presentation/middleware/api-key-auth.ts
```

- 環境変数 `API_KEY` と比較
- 一致しない場合は 401 Unauthorized を返却
- `/health` エンドポイントは認証不要

## コンポーネントからの利用

### Loaders の利用（サーバーコンポーネント）

サーバーコンポーネントから直接 import して使用:

```
app/page.tsx → loadVideos()
app/videos/[id]/page.tsx → loadVideo(), loadTranscription()
```

### Actions の利用（クライアントコンポーネント）

クライアントコンポーネントから import して使用:

```
components/features/video-form/submit-form.tsx → submitVideo()
components/features/video-list/video-table.tsx → deleteVideo()
```

## 移行計画

### Phase 1: サーバー層の追加

1. `server/infrastructure/clients/backend-client.ts` を作成
2. `server/presentation/loaders/` に各ローダーを作成
3. `server/presentation/actions/` に各アクションを作成

### Phase 2: コンポーネントの移行

1. 各ページコンポーネントを Loaders 使用に変更
2. 各フォーム/ボタンを Actions 使用に変更
3. `lib/api-client.ts` の使用箇所を全て置換

### Phase 3: バックエンド認証の追加

1. バックエンドに API Key 認証ミドルウェアを追加
2. 環境変数を設定（Vercel / Cloud Run）

### Phase 4: クリーンアップ

1. `NEXT_PUBLIC_API_URL` 環境変数を削除
2. `lib/api-client.ts` を削除（または開発用モックとして保持）

## 既存コードへの影響

### 変更が必要なファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/page.tsx` | `apiClient.getVideos()` → `loadVideos()` |
| `app/videos/[id]/page.tsx` | 複数のAPI呼び出しをLoaders/Actionsに置換 |
| `app/submit/page.tsx` | 変更なし（フォームコンポーネント側で対応） |
| `components/features/video-form/submit-form.tsx` | `apiClient.submitVideo()` → `submitVideo()` |
| `components/features/video-list/video-table.tsx` | `apiClient.deleteVideo()` → `deleteVideo()` |

### 削除対象

- `lib/api-client.ts`（移行完了後）
- `.env.local` の `NEXT_PUBLIC_API_URL`（移行完了後）

## セキュリティ考慮事項

### 防げる攻撃

- DevToolsからバックエンドURLを取得してcurlで叩く
- ブラウザのネットワークタブからAPIエンドポイントを特定

### 防げない攻撃（許容範囲）

- Server Actionsのエンドポイントをリバースエンジニアリングして呼び出す
  - → 内部ツールとして許容範囲、必要なら Vercel Authentication を追加

### 追加で検討可能な対策（今回スコープ外）

- Rate Limiting（Vercel Edge Middleware）
- Vercel Authentication（社内IP制限等）
- CSRFトークン

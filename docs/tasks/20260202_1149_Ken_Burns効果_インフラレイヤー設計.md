# Ken Burns効果 Infrastructure Layer 設計

## 目的

**ショート動画の視聴者**が、**静止画像のシーンで単調さを感じる状態**を解消するため。

Ken Burns効果（ズーム＋パンのアニメーション）を静止画像に適用することで、視覚的な動きを生み出し、視聴体験を向上させる。

---

## 現状の実装

### アーキテクチャ

```
Domain Layer (Gateway Interface)
├── video-compose.gateway.ts
│   └── SceneVisual: { type, filePath?, color? }

Infrastructure Layer (Client Implementation)
├── ffmpeg-compose.client.ts
│   └── createSceneVideo(): 画像を静止状態でループ表示
```

### 画像背景の現在の処理

`ffmpeg-compose.client.ts:248-249`:
```typescript
// 画像をループ表示（静止状態）
args.push('-loop', '1', '-t', String(durationSec), '-i', scene.visual.filePath);
```

フィルターチェーン（`ffmpeg-compose.client.ts:278`）:
```typescript
`[0:v]scale=${width}:${height}:force_original_aspect_ratio=decrease,pad=${width}:${height}:(ow-iw)/2:(oh-ih)/2,setsar=1,fps=${frameRate}[bg];`
```

現状では画像は静止表示のみで、ズームやパンのアニメーションは未対応。

---

## Ken Burns効果の概要

### FFmpegの`zoompan`フィルター

```bash
zoompan=z='min(zoom+0.0015,1.5)':d=125:x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)':s=1080x1920
```

| パラメータ | 説明 |
|-----------|------|
| `z` | ズーム値（1.0 = 等倍、1.5 = 150%） |
| `d` | 各フレームの表示時間（frames） |
| `x`, `y` | クロップの中心座標 |
| `s` | 出力解像度 |

### エフェクトのバリエーション

| 種類 | 動作 |
|-----|------|
| Zoom In | 徐々にズームイン（1.0 → 1.3） |
| Zoom Out | 徐々にズームアウト（1.3 → 1.0） |
| Pan Left | 左から右へパン |
| Pan Right | 右から左へパン |
| Pan Up | 下から上へパン |
| Pan Down | 上から下へパン |

---

## インターフェース設計（Domain Layer）

### SceneVisualの拡張

`domain/gateways/video-compose.gateway.ts`:

```typescript
/**
 * Ken Burns効果の設定
 */
export interface KenBurnsEffect {
  /** エフェクトの種類 */
  type: 'zoom_in' | 'zoom_out' | 'pan_left' | 'pan_right' | 'pan_up' | 'pan_down';
  /** ズーム倍率（1.0〜2.0、デフォルト: 1.3） */
  zoomScale?: number;
  /** パン移動量（出力サイズに対する割合、0.0〜0.5、デフォルト: 0.2） */
  panAmount?: number;
}

/**
 * シーン素材情報
 */
export interface SceneVisual {
  /** 素材の種類 */
  type: SceneVisualType;
  /** 画像/動画ファイルのパス（type === 'image' or 'video'の場合） */
  filePath?: string;
  /** 塗りつぶし色（type === 'solid_color'の場合、#RRGGBB形式） */
  color?: string;
  /** Ken Burns効果設定（type === 'image'の場合のみ有効） */
  kenBurns?: KenBurnsEffect;
}
```

### KenBurnsEffectの設計判断

1. **`type`フィールドは必須**: どのエフェクトを適用するかを明示
2. **`zoomScale`/`panAmount`はオプショナル**: デフォルト値で十分な場合が多い
3. **`image`タイプのみ有効**: `video`や`solid_color`には適用しない（バリデーションでスキップ）

---

## 実装詳細（Infrastructure Layer）

### FFmpegComposeClientの変更箇所

`infrastructure/clients/ffmpeg-compose.client.ts`の`createSceneVideo`メソッドを拡張:

#### 1. 画像入力の変更

Ken Burns効果を使う場合、元画像を大きめにスケールしてからzoompanを適用する必要がある:

```
現状: -loop 1 -t {duration} -i {image}
変更: -loop 1 -framerate {fps} -t {duration} -i {image}
```

#### 2. フィルターチェーンの拡張

Ken Burns効果がある場合のフィルターチェーン構築:

```
[0:v]scale={scaledW}:{scaledH}:force_original_aspect_ratio=increase,
zoompan=z='{zoomExpr}':x='{xExpr}':y='{yExpr}':d={totalFrames}:s={width}x{height}:fps={fps},
setsar=1[bg];
```

#### 3. zoompan式の構築ロジック

| type | z式 | x式 | y式 |
|------|-----|-----|-----|
| zoom_in | `1+(${scale}-1)*on/${frames}` | `iw/2-(iw/zoom/2)` | `ih/2-(ih/zoom/2)` |
| zoom_out | `${scale}-(${scale}-1)*on/${frames}` | `iw/2-(iw/zoom/2)` | `ih/2-(ih/zoom/2)` |
| pan_left | `${scale}` | `${panPx}*(1-on/${frames})` | `(ih-oh)/2` |
| pan_right | `${scale}` | `${panPx}*on/${frames}` | `(ih-oh)/2` |
| pan_up | `${scale}` | `(iw-ow)/2` | `${panPx}*(1-on/${frames})` |
| pan_down | `${scale}` | `(iw-ow)/2` | `${panPx}*on/${frames}` |

※ `on` = 現在のフレーム番号、`frames` = 総フレーム数

### 新規privateメソッド

```typescript
/**
 * Ken Burns効果用のzoompanフィルター式を構築
 */
private buildKenBurnsFilter(
  effect: KenBurnsEffect,
  width: number,
  height: number,
  durationSec: number,
  frameRate: number
): string
```

### バリデーションの追加

`validateParams`メソッドに追加:

- `kenBurns`が指定されているが`type`が`image`でない場合はエラーではなく無視
- `zoomScale`が範囲外（1.0未満または2.0超）の場合はデフォルト値に補正
- `panAmount`が範囲外（0.0未満または0.5超）の場合はデフォルト値に補正

---

## インテグレーションテスト

### テストファイル

`test/contexts/shorts-gen/infrastructure/clients/ffmpeg-compose.client.integration.test.ts`

### 追加するテストケース

#### 1. 基本的なKen Burns効果（zoom_in）

```typescript
it('should compose a scene with Ken Burns zoom_in effect', async () => {
  const testImagePath = path.join(tempDir, 'kb_test_image.png');
  createTestImage(testImagePath, 1080, 1920, '#3498db');

  const outputPath = path.join(tempDir, 'ken_burns_zoom_in.mp4');

  const params: VideoComposeParams = {
    outputPath,
    width: 1080,
    height: 1920,
    frameRate: 30,
    scenes: [
      {
        sceneId: 'scene-1',
        order: 0,
        durationMs: 3000,
        visual: {
          type: 'image',
          filePath: testImagePath,
          kenBurns: {
            type: 'zoom_in',
          },
        },
        audioPath: null,
        subtitles: [],
      },
    ],
  };

  const result = await client.compose(params);

  expect(result.success).toBe(true);
  if (result.success) {
    expect(result.value.durationSeconds).toBeCloseTo(3, 0);
    expect(fs.existsSync(outputPath)).toBe(true);
  }
});
```

#### 2. カスタムzoomScaleのテスト

```typescript
it('should compose with custom zoomScale', async () => {
  // zoomScale: 1.5 を指定してテスト
});
```

#### 3. パン効果のテスト

```typescript
it('should compose with pan_left effect', async () => {
  // pan_left を指定してテスト
});
```

#### 4. 複数シーンでの混在テスト

```typescript
it('should compose multiple scenes with different Ken Burns effects', async () => {
  // シーン1: zoom_in, シーン2: pan_right, シーン3: 効果なし
});
```

#### 5. 字幕との組み合わせテスト

```typescript
it('should compose Ken Burns effect with subtitle overlays', async () => {
  // Ken Burns + 字幕オーバーレイの組み合わせ
});
```

#### 6. videoタイプでkenBurnsを指定した場合のテスト

```typescript
it('should ignore kenBurns for video type', async () => {
  // videoタイプでkenBurnsを指定しても正常に処理される（無視される）
});
```

### テスト実行条件

既存と同じ:
- `INTEGRATION_TEST=true`
- FFmpegがインストールされていること

### テスト時間の考慮

Ken Burns効果はフィルター処理が重いため、テストタイムアウトを十分に設定:
- 単一シーンテスト: デフォルト（5秒）で十分
- 複数シーンテスト: 60秒程度を設定

---

## チェックリスト

### アーキテクチャルールとの整合性

- [x] Gateway インターフェースはドメイン層に配置（`domain/gateways/`）
- [x] Client 実装はインフラ層に配置（`infrastructure/clients/`）
- [x] Application 層は Infrastructure に直接依存しない（Gateway 経由）
- [x] エラーハンドリング: インフラ層では `throw`

### 実装スコープ

- [x] Infrastructure層のみの変更（このドキュメントの対象）
- [ ] Application層の変更（別途設計が必要な場合）
- [ ] API層の変更（別途設計が必要な場合）
- [ ] フロントエンドの変更（別途設計が必要）

---

## 制約事項

1. **Ken Burns効果は`image`タイプのみ**: `video`や`solid_color`には適用しない
2. **zoompanフィルターの性能**: 高解像度・長時間の場合はエンコード時間が増加
3. **画像の解像度要件**: Ken Burns効果を適用する場合、元画像は出力解像度より大きい方が望ましい（そうでない場合は拡大後にzoompanが適用される）

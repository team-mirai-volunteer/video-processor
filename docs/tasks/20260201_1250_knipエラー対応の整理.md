# knip エラー対応の整理

## 目的

開発者がCI/CDでknipを有効化し、未使用コードの検出による品質管理を再開するため。
現在「if: false」で無効化されているknipチェックをONにしたい。

## 現状分析

### knipの実行結果

```
Unused files (4)
Unlisted binaries (1)
Unused exports (28)
Unused exported types (51)
Configuration hints (2)
```

## 対応方針

### 1. 削除すべきもの（本当に未使用）

#### Unused files (4件)
**判定: すべてbarrel fileとして必要だが、knipのentry設定を調整する方が適切**

| ファイル | 状況 | 対応 |
|---------|------|------|
| `application/errors/index.ts` | barrel file。他ファイルから参照あり | knip entryに追加 |
| `application/index.ts` | barrel file。他ファイルから参照あり | knip entryに追加 |
| `application/usecases/index.ts` | barrel file。他ファイルから参照あり | knip entryに追加 |
| `domain/models/index.ts` | barrel file。他ファイルから参照あり | knip entryに追加 |

→ **削除ではなくknip設定の調整で対応**

#### Unused exports - 本当に未使用（削除可能）

| Export | ファイル | 理由 |
|--------|----------|------|
| `ConflictError` | `application/errors/errors.ts` | shorts-genコンテキストでは未使用。clip-videoにはあるが、shorts-genには不要 |
| `createGenerateSubtitlesError` | `application/errors/generate-subtitles.errors.ts` | ヘルパー関数だが、直接`new GenerateSubtitlesError()`で生成されている |

#### Unused exports - Server Actions（実際は一部未使用）

| Export | ファイル | 実使用状況 |
|--------|----------|-----------|
| `composeVideoSync` | `composeVideo.ts` | 未使用（`composeVideo`は使用されている） |
| `getComposedVideo` | `composeVideo.ts` | 未使用（`getComposedVideoByProject`は使用されている） |
| `deleteComposedVideo` | `composeVideo.ts` | 未使用 |
| `generateImagePrompt` | `generateImage.ts` | 未使用（別実装が使用されている） |
| `generateImage` | `generateImage.ts` | 未使用（別実装が使用されている） |
| `generateAllImages` | `generateImage.ts` | 未使用（別実装が使用されている） |
| `generateSubtitle` | `generateSubtitle.ts` | 未使用（別実装が使用されている） |
| `generateAllSubtitles` | `generateSubtitle.ts` | 未使用（別実装が使用されている） |
| `getPublishText` | `publishText.ts` | 未使用（`getPublishTextByProject`は使用されている） |
| `deletePublishText` | `publishText.ts` | 未使用 |

**注意**: `generateVoice`, `generateAllVoices` は `asset-generation-demo.tsx` でimportされているが、これはデモファイルなので別途判断が必要。

#### Unused exported types - index.ts re-exportの問題

`gateways/index.ts`と`clients/index.ts`から大量の型がre-exportされているが、実際のコードでは直接ファイルからimportされている。

**対応案**:
- re-export用のindex.tsは廃止し、直接importパターンに統一
- または、knipのignoreExportsパターンで除外

### 2. knip.jsonに追加すべきもの

#### Unlisted binaries (1件)

| Binary | 使用箇所 | 対応 |
|--------|---------|------|
| `dot` | `apps/webapp/package.json` の `lint:deps:graph` スクリプト | graphvizの`dot`コマンド。開発ツールなのでignoreBinariesに追加 |

#### Configuration hints (2件)

| 項目 | 現状 | 対応 |
|------|------|------|
| `dotenv` in ignoreDependencies | vitest config内で使用されている | テストファイルをignoreしているため発生。vitestプラグインを有効化すれば解決 |
| `src/index.ts` redundant entry | entry: ["src/index.ts", ...] | 他のentryでカバーされている。削除可能 |

### 3. 対応まとめ

#### 削除すべきファイル/コード

1. **backend - 未使用exports削除**
   - `apps/backend/src/contexts/shorts-gen/application/errors/errors.ts` から `ConflictError` を削除
   - `apps/backend/src/contexts/shorts-gen/application/errors/generate-subtitles.errors.ts` から `createGenerateSubtitlesError` を削除

2. **webapp - 未使用Server Actions削除** (要確認)
   - `composeVideoSync`, `getComposedVideo`, `deleteComposedVideo`
   - `generateImagePrompt`, `generateImage`, `generateAllImages`
   - `generateSubtitle`, `generateAllSubtitles`
   - `getPublishText`, `deletePublishText`

   **注意**: これらは将来的に使う可能性があるため、プロダクトオーナーに確認が必要

3. **clients/index.ts のre-export整理**
   - 直接importに統一されているため、index.tsからの re-export は削除可能

#### knip.json 更新内容

```json
{
  "$schema": "https://unpkg.com/knip@5/schema.json",
  "workspaces": {
    "apps/backend": {
      "project": ["src/**/*.ts"],
      "entry": [
        "src/contexts/*/presentation/routes/*.ts",
        "src/contexts/*/application/index.ts",
        "src/contexts/*/application/usecases/index.ts",
        "src/contexts/*/application/errors/index.ts",
        "src/contexts/*/domain/models/index.ts"
      ],
      "ignore": [
        "src/**/*.test.ts",
        "test/**/*.ts",
        "src/contexts/shared/infrastructure/clients/local-storage.client.ts"
      ],
      "vitest": true
    },
    "apps/webapp": {
      "entry": [
        "src/app/**/*.{ts,tsx}",
        "src/components/**/*.{ts,tsx}",
        "src/server/presentation/actions/**/*.ts"
      ],
      "project": ["src/**/*.{ts,tsx}"],
      "ignore": ["src/**/*.test.{ts,tsx}"],
      "ignoreBinaries": ["dot"],
      "playwright": false
    },
    "apps/shared": {
      "project": ["types/**/*.ts"]
    }
  }
}
```

#### CI変更内容

`.github/workflows/ci.yml`:
```yaml
  knip:
    # if: false を削除してknipを有効化
    runs-on: ubuntu-latest
```

## 実装ステップ

1. **Phase 1: knip.json設定の調整**
   - entryにbarrel filesを追加
   - vitestプラグインを有効化
   - ignoreBinariesに`dot`を追加

2. **Phase 2: 明らかに不要なコードの削除**
   - `ConflictError` (shorts-gen)
   - `createGenerateSubtitlesError`

3. **Phase 3: Server Actionsの整理（要確認）**
   - 未使用のServer Actionsについてプロダクトオーナーに確認
   - 確認後、不要なものを削除

4. **Phase 4: CIでknipを有効化**
   - `.github/workflows/ci.yml` の `if: false` を削除
   - PRでテスト実行を確認

## 補足: Unused exported types (51件) について

大部分は `gateways/index.ts` からのre-exportパターンが原因。
実際のコードでは直接ファイルからimportしているため、index.ts経由のexportは未使用と判定されている。

**推奨**:
- 現状のまま直接importパターンを維持
- gateways/index.ts, clients/index.ts のre-exportは廃止
- または、knipでindex.tsからのre-exportをexportされるentry pointとして認識させる

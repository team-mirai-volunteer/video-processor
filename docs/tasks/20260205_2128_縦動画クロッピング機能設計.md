# 縦動画クロッピング機能設計

## 目的

ユーザーが、切り抜き動画をYouTube ShortsやTikTok向けの9:16縦動画フォーマットで出力できるようにするため。

現状では元動画のアスペクト比がそのまま維持されるため、横長動画から縦動画プラットフォーム向けのコンテンツを作成できない課題を解消する。

## 機能概要

- 切り抜き作成時に「縦動画（9:16）」オプションを選択可能にする
- 選択した場合、元動画を9:16フレームの中央に配置し、余白を指定色で埋める
- 既存の「オリジナルアスペクト比維持」との選択式にする

## 処理イメージ

```
┌─────────────────────────────┐
│                             │  ← 余白（指定色）
│   ┌───────────────────┐     │
│   │                   │     │
│   │   元の横長動画     │     │  ← 中央配置・アスペクト比維持
│   │                   │     │
│   └───────────────────┘     │
│                             │  ← 余白（指定色）
└─────────────────────────────┘
         9:16 フレーム
```

## オプション設計

### 新規オプション

| オプション名 | 型 | デフォルト | 説明 |
|-------------|-----|----------|------|
| `outputFormat` | `'original' \| 'vertical'` | `'original'` | 出力フォーマット |
| `paddingColor` | `'#000000' \| '#30bca7'` | `'#000000'` | 余白の色（プリセットから選択） |

### 余白カラープリセット

| 値 | 名前 | 説明 |
|----|------|------|
| `#000000` | 黒 | デフォルト |
| `#30bca7` | チームみらいグリーン | 文字縁取りのデフォルト色と同じ |

### UI表示

- **オリジナル**: 元動画のアスペクト比を維持（現行動作）
- **縦動画（9:16）**: 9:16フレームに中央配置、余白を指定色で埋める

`outputFormat: 'vertical'` 選択時のみ `paddingColor` の選択欄を表示する。
カラーピッカーではなく、プリセットからの選択式とする（ラジオボタンまたはセレクトボックス）。

## 変更箇所

### 1. 共有型定義 (`apps/shared/types/api.ts`)

`ExtractClipsRequest` に新しいオプションを追加:

```typescript
/** 余白カラープリセット */
export type PaddingColor = '#000000' | '#30bca7';

export interface ExtractClipsRequest {
  clipInstructions: string;
  multipleClips?: boolean;
  // 新規追加
  outputFormat?: 'original' | 'vertical';
  paddingColor?: PaddingColor; // プリセットから選択
}
```

### 2. Gateway インターフェース (`contexts/shared/domain/gateways/video-processing.gateway.ts`)

`extractClipFromFile` メソッドにオプションパラメータを追加:

```typescript
/** 余白カラープリセット */
export type PaddingColor = '#000000' | '#30bca7';

export interface ClipExtractionOptions {
  /** 出力フォーマット。'vertical' の場合は9:16に変換 */
  outputFormat?: 'original' | 'vertical';
  /** 余白の色（プリセットから選択）。outputFormat: 'vertical' 時のみ有効 */
  paddingColor?: PaddingColor;
}

export interface VideoProcessingGateway {
  // 既存メソッドにオプション追加
  extractClipFromFile(
    inputPath: string,
    outputPath: string,
    startTimeSeconds: number,
    endTimeSeconds: number,
    options?: ClipExtractionOptions
  ): Promise<void>;
  // ...他のメソッド
}
```

### 3. FFmpeg Client (`contexts/shared/infrastructure/clients/ffmpeg.client.ts`)

`extractClipFromFile` メソッドに9:16変換ロジックを追加。

FFmpegフィルター構成:

```bash
# 9:16 = 1080x1920 (縦動画の一般的な解像度)
# 元動画を幅1080pxにスケーリングし、1920pxの高さに中央配置

-vf "scale=1080:-2,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=#000000"
```

ポイント:
- `scale=1080:-2`: 幅を1080pxに固定、高さはアスペクト比維持（偶数に丸め）
- `pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=#000000`: 1080x1920にパディング、中央配置、指定色で埋める

元動画が縦長の場合（高さが1920pxを超える場合）の考慮:

```bash
# 高さ基準でスケーリングする場合
-vf "scale=-2:1920,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=#000000"
```

実装では、元動画のアスペクト比を判定して適切なスケーリング方向を選択する。

### 4. UseCase (`contexts/clip-video/application/usecases/extract-clips.usecase.ts`)

`ExtractClipsInput` に新しいオプションを追加し、`videoProcessingGateway.extractClipFromFile` 呼び出し時に渡す:

```typescript
export interface ExtractClipsInput {
  videoId: string;
  clipInstructions: string;
  multipleClips?: boolean;
  // 新規追加
  outputFormat?: 'original' | 'vertical';
  paddingColor?: string;
}
```

### 5. Route (`contexts/clip-video/presentation/routes/videos.ts`)

リクエストボディから新しいオプションを取得してUseCaseに渡す。

### 6. フロントエンド (`apps/webapp/src/app/videos/[id]/video-detail-client.tsx`)

切り抜き作成フォームに以下を追加:
- **出力フォーマット**: ラジオボタンまたはセレクトボックス（オリジナル / 縦動画）
- **余白の色**: ラジオボタンまたはセレクトボックス（縦動画選択時のみ表示）
  - 黒 (`#000000`) - デフォルト
  - チームみらいグリーン (`#30bca7`)

### 7. Server Action (`apps/webapp/src/server/presentation/clip-video/actions/extractClips.ts`)

新しいオプションをバックエンドに渡す（型が自動的に拡張される）。

## データフロー

```
フロントエンド (video-detail-client.tsx)
    ↓ outputFormat, paddingColor
Server Action (extractClips.ts)
    ↓
Backend Route (videos.ts)
    ↓
ExtractClipsUseCase
    ↓ options: { outputFormat, paddingColor }
VideoProcessingGateway.extractClipFromFile()
    ↓
FFmpegClient (9:16変換 or オリジナル維持)
```

## FFmpeg実装詳細

### アスペクト比判定ロジック

```typescript
// 元動画のアスペクト比を取得（ffprobe）
const sourceAspectRatio = sourceWidth / sourceHeight;
const targetAspectRatio = 9 / 16; // 0.5625

if (sourceAspectRatio > targetAspectRatio) {
  // 元動画の方が横長 → 幅基準でスケーリング
  filter = `scale=1080:-2,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=${paddingColor}`;
} else {
  // 元動画の方が縦長 → 高さ基準でスケーリング
  filter = `scale=-2:1920,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:color=${paddingColor}`;
}
```

### カラーコード

FFmpegは `#RRGGBB` 形式をそのまま受け付けるため、プリセット値をそのまま使用可能。

## バリデーション

### フロントエンド

- `paddingColor` がプリセット値（`#000000` または `#30bca7`）であることを検証
- `outputFormat: 'vertical'` 時のみ `paddingColor` を送信

### バックエンド

- `outputFormat` が `'original'` または `'vertical'` であることを検証
- `paddingColor` がプリセット値（`#000000` または `#30bca7`）であることを検証（`outputFormat: 'vertical'` 時）
- 不正な値の場合はデフォルト `#000000` を使用

## テスト方針

### ユニットテスト

- `ExtractClipsUseCase`: 新しいオプションが正しくGatewayに渡されることを確認
- プリセットカラーのバリデーションロジック

### 統合テスト

- `FFmpegClient.extractClipFromFile`:
  - `outputFormat: 'original'` で従来通りの出力
  - `outputFormat: 'vertical'` で9:16の出力
  - `paddingColor: '#000000'`（黒）での出力
  - `paddingColor: '#30bca7'`（チームみらいグリーン）での出力

### E2Eテスト

- 切り抜き作成フォームでオプションを選択して実行
- 生成された動画が正しいアスペクト比であることを確認

## 影響範囲

| 層 | ファイル | 変更内容 |
|----|---------|---------|
| shared | `apps/shared/types/api.ts` | `ExtractClipsRequest` 型拡張 |
| domain | `contexts/shared/domain/gateways/video-processing.gateway.ts` | `ClipExtractionOptions` 型追加、メソッドシグネチャ変更 |
| infrastructure | `contexts/shared/infrastructure/clients/ffmpeg.client.ts` | 9:16変換ロジック実装 |
| application | `contexts/clip-video/application/usecases/extract-clips.usecase.ts` | 新オプション受け渡し |
| presentation | `contexts/clip-video/presentation/routes/videos.ts` | リクエストパラメータ追加 |
| webapp | `apps/webapp/src/app/videos/[id]/video-detail-client.tsx` | UIオプション追加 |

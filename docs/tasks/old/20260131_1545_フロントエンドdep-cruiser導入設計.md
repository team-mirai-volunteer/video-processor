# フロントエンド dep-cruiser 導入設計

## 目的

**開発者が**フロントエンドの依存関係ルール違反を自動検出できるようにし、**アーキテクチャの劣化を防ぐため**。

バックエンドでは既にdep-cruiserでDDDレイヤールールを強制しており、フロントエンドにも同様の仕組みを導入することで、コードベース全体の設計品質を維持する。

## 現状分析

### フロントエンドのディレクトリ構成

```
apps/webapp/src/
├── app/                          # Next.js App Router (ページ)
│   ├── api/                      # API Routes
│   ├── shorts-gen/               # 機能別ページ
│   ├── videos/[id]/
│   └── submit/
├── components/
│   ├── ui/                       # shadcn/ui プリミティブ
│   └── features/                 # 機能別コンポーネント
│       ├── shorts-gen/           # 44ファイル、サブフォルダ多数
│       │   ├── asset-generation/
│       │   ├── chat/
│       │   ├── compose/
│       │   ├── planning/
│       │   ├── script/
│       │   └── ...
│       ├── clip-list/
│       ├── transcript/
│       └── ...
├── server/                       # サーバーサイドコード
│   ├── infrastructure/
│   │   └── clients/              # バックエンドAPIクライアント
│   └── presentation/
│       ├── actions/              # Server Actions
│       └── loaders/              # データフェッチャー
└── lib/                          # ユーティリティ
```

### 暗黙的に存在する設計ルール

現状、以下のルールが暗黙的に守られている：

1. **レイヤー方向**: `app/` → `components/features/` → `components/ui/` → `lib/`
2. **サーバー/クライアント境界**: クライアントコンポーネントは `server/presentation/actions/` 経由でサーバー処理を呼ぶ
3. **UIの独立性**: `components/ui/` は他のレイヤーに依存しない

## 設計

### 依存ルール定義

| Source | Allowed Imports | Forbidden Imports |
|--------|-----------------|-------------------|
| `app/**` | features, ui, server, lib, shared | - |
| `components/features/{X}/**` | 同一feature内, ui, lib, server/actions, shared | 他のfeature |
| `components/ui/**` | lib, shared | features, server |
| `server/presentation/**` | server/infrastructure, shared | components |
| `server/infrastructure/**` | shared, external | 内部import |
| `lib/**` | shared, external | 内部import |

### dep-cruiser設定ファイル

`apps/webapp/.dependency-cruiser.cjs` を新規作成する。

```javascript
/** @type {import('dependency-cruiser').IConfiguration} */
module.exports = {
  forbidden: [
    // === UI layer isolation ===
    {
      name: 'ui-cannot-import-features',
      severity: 'error',
      comment: 'UI components must not depend on feature components',
      from: { path: '^src/components/ui' },
      to: { path: '^src/components/features' },
    },
    {
      name: 'ui-cannot-import-server',
      severity: 'error',
      comment: 'UI components must not depend on server layer',
      from: { path: '^src/components/ui' },
      to: { path: '^src/server' },
    },
    {
      name: 'ui-cannot-import-app',
      severity: 'error',
      comment: 'UI components must not depend on app layer',
      from: { path: '^src/components/ui' },
      to: { path: '^src/app' },
    },

    // === Feature isolation ===
    {
      name: 'feature-cannot-import-other-features',
      severity: 'error',
      comment: 'Features should not directly import from other features',
      from: { path: '^src/components/features/([^/]+)/' },
      to: {
        path: '^src/components/features/([^/]+)/',
        pathNot: '^src/components/features/$1/',
      },
    },
    {
      name: 'features-cannot-import-app',
      severity: 'error',
      comment: 'Feature components must not depend on app layer',
      from: { path: '^src/components/features' },
      to: { path: '^src/app' },
    },

    // === Server layer isolation ===
    {
      name: 'server-cannot-import-components',
      severity: 'error',
      comment: 'Server layer must not depend on components',
      from: { path: '^src/server' },
      to: { path: '^src/components' },
    },
    {
      name: 'server-cannot-import-app',
      severity: 'error',
      comment: 'Server layer must not depend on app layer',
      from: { path: '^src/server' },
      to: { path: '^src/app' },
    },
    {
      name: 'infrastructure-cannot-import-presentation',
      severity: 'error',
      comment: 'Infrastructure must not depend on presentation',
      from: { path: '^src/server/infrastructure' },
      to: { path: '^src/server/presentation' },
    },

    // === Lib isolation ===
    {
      name: 'lib-cannot-import-internal',
      severity: 'error',
      comment: 'Lib must not depend on internal modules',
      from: { path: '^src/lib' },
      to: { path: '^src/(app|components|server)' },
    },

    // === Common anti-patterns ===
    {
      name: 'no-circular',
      severity: 'error',
      comment: 'Circular dependencies are not allowed',
      from: {},
      to: { circular: true },
    },
  ],
  options: {
    doNotFollow: {
      path: 'node_modules',
    },
    tsPreCompilationDeps: true,
    tsConfig: {
      fileName: './tsconfig.json',
    },
    enhancedResolveOptions: {
      exportsFields: ['exports'],
      conditionNames: ['import', 'require', 'node', 'default'],
    },
    reporterOptions: {
      text: {
        highlightFocused: true,
      },
    },
  },
};
```

### package.json への追加

```json
{
  "devDependencies": {
    "dependency-cruiser": "^16.0.0"
  },
  "scripts": {
    "lint:deps": "depcruise src --config .dependency-cruiser.cjs",
    "lint:deps:graph": "depcruise src --config .dependency-cruiser.cjs --output-type dot | dot -T svg > dependency-graph.svg"
  }
}
```

### CI統合

既存の lint チェックに `pnpm --filter @video-processor/webapp lint:deps` を追加する。

## 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `apps/webapp/.dependency-cruiser.cjs` | 新規作成 |
| `apps/webapp/package.json` | devDependencies と scripts 追加 |

## 備考

### feature間の共有について

現状、`shorts-gen/chat` が他のサブフィーチャー（planning, script）から参照されている。これは許容パターンとして、同一feature内のサブフォルダ間参照は許可している。

もし将来的に異なるfeature間で共通コンポーネントが必要になった場合は、以下のいずれかの対応を検討する：

1. `components/shared/` ディレクトリを新設
2. 該当コンポーネントを `components/ui/` に昇格

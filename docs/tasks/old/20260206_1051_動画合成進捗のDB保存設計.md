# 動画合成進捗のDB保存設計

## 目的

**shorts-gen機能のユーザー**が、**動画合成（Compose）処理中に進捗が分からず不安になる状態**を解消するため。

---

## 現状の課題

### 現在の実装
- `ShortsComposedVideo`テーブルの`status`は `pending | processing | completed | failed` の4状態のみ
- 長時間のFFmpeg処理中、フロントエンドには「processing」としか表示されない
- 処理の何%くらいが完了しているかが全く分からない

### ユーザー体験
- 合成処理は動画の長さやシーン数によって数分かかることがある
- 「processing」表示のまま変化がないため、正常に動作しているのか不安になる

---

## 設計

### 1. DBスキーマ変更

`ShortsComposedVideo`テーブルに以下のカラムを追加する。

```prisma
model ShortsComposedVideo {
  // 既存カラム
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  scriptId        String   @map("script_id")
  fileUrl         String?  @map("file_url")
  durationSeconds Decimal? @map("duration_seconds") @db.Decimal(10, 3)
  status          String   @default("pending")
  errorMessage    String?  @map("error_message")
  bgmKey          String?  @map("bgm_key")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 追加カラム
  progressPhase   String?  @map("progress_phase")    // 処理フェーズ
  progressPercent Int?     @map("progress_percent")  // 進捗パーセンテージ (0-100)

  // relations...
}
```

### 2. 進捗フェーズ定義

| フェーズ | 説明 | パーセンテージ範囲 |
|---------|------|-------------------|
| `preparing` | シーン・アセット情報の取得 | 0-10% |
| `downloading` | GCSからアセットをダウンロード | 10-30% |
| `composing` | FFmpegで動画合成 | 30-90% |
| `uploading` | GCSへ完成動画をアップロード | 90-100% |

### 3. 進捗計算ロジック

`ComposeVideoUseCase`内で、処理の各ステップで進捗を更新する。

```
[0%]   processing開始
[5%]   プロジェクト・シーン情報取得完了
[10%]  アセット情報取得完了
       --- downloading フェーズ ---
[10-30%] シーンごとにダウンロード完了時に進捗更新
         例: 5シーン中2シーン目完了 → 10 + (20 * 2/5) = 18%
       --- composing フェーズ ---
[30-90%] シーンごとに合成完了時に進捗更新
         例: 5シーン中3シーン目完了 → 30 + (60 * 3/5) = 66%
       --- uploading フェーズ ---
[90%]  アップロード開始
[100%] 完了
```

### 4. バックエンド実装変更

#### 4.1 ドメインモデル変更

[composed-video.ts](../apps/backend/src/contexts/shorts-gen/domain/models/composed-video.ts)に進捗更新メソッドを追加。

```typescript
interface ProgressUpdate {
  phase: 'preparing' | 'downloading' | 'composing' | 'uploading';
  percent: number;
}

// withProgress() メソッドを追加
withProgress(update: ProgressUpdate): ShortsComposedVideo
```

#### 4.2 UseCase変更

[compose-video.usecase.ts](../apps/backend/src/contexts/shorts-gen/application/usecases/compose-video.usecase.ts)の各ステップで進捗を更新。

主な更新ポイント:
1. シーン情報取得後 → `preparing`, 5%
2. アセット情報取得後 → `preparing`, 10%
3. 各シーンのアセットダウンロード後 → `downloading`, 10-30%の按分
4. 各シーンの合成後 → `composing`, 30-90%の按分
5. アップロード開始時 → `uploading`, 90%
6. 完了時 → 100%（statusがcompletedになる）

#### 4.3 Repository変更

進捗更新用の軽量な更新メソッドを追加。

```typescript
// ShortsComposedVideoRepositoryGateway
updateProgress(id: string, phase: string, percent: number): Promise<void>
```

### 5. フロントエンド実装変更

#### 5.1 型定義変更

`GetComposedVideoResponse`に進捗フィールドを追加。

```typescript
interface GetComposedVideoResponse {
  // 既存フィールド
  id: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  fileUrl: string | null;
  // ...

  // 追加フィールド
  progressPhase: string | null;
  progressPercent: number | null;
}
```

#### 5.2 UI表示変更

[compose-step.tsx](../apps/webapp/src/components/features/shorts-gen/compose/compose-step.tsx)で進捗を表示。

表示例:
- `アセットをダウンロード中... (25%)`
- `動画を合成中... (65%)`
- `アップロード中... (95%)`

プログレスバーの表示も検討。

### 6. API変更

既存のGETエンドポイント `/api/shorts-gen/compose/project/:projectId` のレスポンスに `progressPhase`, `progressPercent` を含める（DBカラム追加により自動的に含まれる）。

---

## 実装順序

1. Prismaスキーマ変更 + マイグレーション
2. ドメインモデル（`ShortsComposedVideo`）に進捗関連の型・メソッド追加
3. Repository実装（進捗更新メソッド追加）
4. UseCase実装（各ステップで進捗更新を呼び出し）
5. 共有型定義更新（`@video-processor/shared`）
6. フロントエンドUI更新

---

## 考慮事項

### FFmpeg処理中の詳細進捗

FFmpegの処理中（シーン合成中）の詳細進捗を取得するには、FFmpegの標準出力をパースする必要がある。現在の`FFmpegComposeClient`実装では対応していないため、今回のスコープでは「シーン単位」の進捗とする。

将来的にFFmpegの詳細進捗が必要になった場合は、`-progress` オプションを使用した実装を検討する。

### 頻繁なDB更新のパフォーマンス

シーンが多い場合、進捗更新のDB書き込みが頻繁になる可能性がある。ただし、通常のショート動画は10シーン程度であり、更新間隔も数秒〜数十秒に1回程度のため、パフォーマンス上の問題にはならないと判断。

---

## ファイル変更一覧

| ファイル | 変更内容 |
|---------|---------|
| `apps/backend/.../prisma/schema.prisma` | カラム追加 |
| `apps/backend/.../domain/models/composed-video.ts` | 進捗更新メソッド追加 |
| `apps/backend/.../domain/gateways/composed-video-repository.gateway.ts` | 進捗更新メソッド追加 |
| `apps/backend/.../infrastructure/repositories/composed-video.repository.ts` | 進捗更新実装 |
| `apps/backend/.../application/usecases/compose-video.usecase.ts` | 各ステップで進捗更新 |
| `apps/shared/src/types/shorts-gen.ts` | レスポンス型に進捗フィールド追加 |
| `apps/webapp/.../compose/compose-step.tsx` | 進捗表示UI追加 |

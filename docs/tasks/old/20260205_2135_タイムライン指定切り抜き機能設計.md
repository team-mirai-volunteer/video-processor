# タイムライン指定切り抜き機能設計

## 目的

ユーザーが「文字起こしのタイムライン表示から直接セクションを選択して切り抜きを作成できる」ようにするため。

現在は「セリフを指定して切り抜き」のみで、テキストエリアに切り抜きたい箇所を手入力する必要があるが、タイムライン表示から視覚的に選択できるようにすることで、より直感的な操作を実現する。

---

## 機能概要

「切り抜き作成」セクションにセグメンテッドコントロールを追加し、以下の2つのモードを切り替え可能にする：

| モード | 説明 |
|--------|------|
| **セリフを指定して切り抜き** | 現在の機能。テキストエリアでセリフを指定し、AIがタイムスタンプを解析して切り出す |
| **タイムラインから指定して切り抜き** | 新機能。タイムライン表示でセクション（RefinedSentence）を選択し、直接タイムスタンプ指定で切り出す |

### 「タイムラインから指定して切り抜き」の仕様

- **単一切り抜きのみ**（複数クリップ作成は不可）
- **連続セクションのみ選択可能**
  - OK: `2`, `2,3`, `1,2,3,4,5`
  - NG: `2,4`, `1,3,4`（間が空く選択は不可）
- **LLMを使わない**：選択したセクションの開始〜終了タイムスタンプを直接バックエンドに送信し、FFmpegで切り出す

---

## UI設計

### セグメンテッドコントロール

「切り抜き作成」カード内の先頭に配置：

```
┌─────────────────────────────────────────────────────────────┐
│ [セリフを指定して切り抜き] [タイムラインから指定して切り抜き] │
└─────────────────────────────────────────────────────────────┘
```

shadcn/ui の `Tabs` コンポーネントを使用。

### 「タイムラインから指定して切り抜き」モードのUI

既存の `RefinedTranscriptView` に似た見た目で、各セクションをクリックで選択可能にする：

```
┌──────────────────────────────────────────────────────────────────────┐
│ [ ] [00:02.44 - 00:15.96] ソフトを書くだけではなく、例えば...        │
│ [*] [00:15.96 - 00:35.64] そんな中で是非皆さんにまだまだ...          │ ← 選択中
│ [*] [00:35.64 - 00:47.08] こういう政党があるんだということを...      │ ← 選択中
│ [ ] [00:47.08 - 01:02.30] それでは、よろしくお願いいたします。       │
└──────────────────────────────────────────────────────────────────────┘

選択中: 00:15.96 - 00:47.08 (31.12秒)

                                          [切り抜きを作成]
```

### 選択ロジック

1. **クリックで範囲選択**
   - 未選択状態でクリック → そのセクションのみ選択
   - 選択中セクションの端をクリック → 選択解除（範囲縮小）
   - 選択中セクションに隣接するセクションをクリック → 範囲拡大
   - 選択中セクションと離れたセクションをクリック → 新しい範囲として選択し直し

2. **Shift+クリックで範囲指定**（オプション）
   - 最初に選択したセクションから Shift+クリック したセクションまでを一括選択

---

## データフロー

### 現行（セリフを指定して切り抜き）

```
Frontend                          Backend
   │                                 │
   │ POST /extract-clips             │
   │ { clipInstructions, multipleClips }
   │ ─────────────────────────────→  │
   │                                 │ AI分析 → タイムスタンプ抽出 → FFmpeg切り出し
   │                                 │
   │ { videoId, status }             │
   │ ←─────────────────────────────  │
```

### 新規（タイムラインから指定して切り抜き）

```
Frontend                          Backend
   │                                 │
   │ POST /extract-clip-by-time      │  ← 新規APIエンドポイント
   │ { startTimeSeconds, endTimeSeconds, title? }
   │ ─────────────────────────────→  │
   │                                 │ FFmpeg切り出し（AI不使用）
   │                                 │
   │ { videoId, status }             │
   │ ←─────────────────────────────  │
```

---

## API設計

### 新規エンドポイント

`POST /api/videos/:videoId/extract-clip-by-time`

#### Request Body

```typescript
interface ExtractClipByTimeRequest {
  startTimeSeconds: number;  // 切り抜き開始時刻（秒）
  endTimeSeconds: number;    // 切り抜き終了時刻（秒）
  title?: string;            // クリップのタイトル（省略時は自動生成）
}
```

#### Response

```typescript
interface ExtractClipByTimeResponse {
  videoId: string;
  clipId: string;
  status: 'extracting' | 'completed' | 'failed';
}
```

#### バリデーション

- `startTimeSeconds >= 0`
- `endTimeSeconds > startTimeSeconds`
- `endTimeSeconds <= 動画の長さ`
- `endTimeSeconds - startTimeSeconds` が妥当な範囲内（例: 5秒以上、10分以下）

---

## バックエンド実装

### 新規UseCase: `ExtractClipByTimeUseCase`

`apps/backend/src/contexts/clip-video/application/usecases/extract-clip-by-time.usecase.ts`

既存の `ExtractClipsUseCase` からAI分析部分を除去し、タイムスタンプ直接指定で切り出す簡略版。

#### 依存Gateway

| Gateway | 用途 |
|---------|------|
| `VideoRepositoryGateway` | 動画情報取得・ステータス更新 |
| `ClipRepositoryGateway` | クリップ保存 |
| `StorageGateway` | Google Drive操作（メタデータ取得、アップロード） |
| `TempStorageGateway` | GCSキャッシュ操作 |
| `VideoProcessingGateway` | FFmpeg切り出し |

**不要なGateway**（AIを使わないため）:
- `AiGateway`
- `TranscriptionRepositoryGateway`
- `RefinedTranscriptionRepositoryGateway`

#### 処理フロー

1. 動画存在確認
2. バリデーション（タイムスタンプ範囲）
3. 動画ファイル準備（GCSキャッシュ or Google Driveからダウンロード）
4. FFmpegでクリップ切り出し
5. Google Driveにアップロード
6. クリップ情報をDB保存
7. 動画ステータス更新

### 型定義追加

`apps/shared/types/api.ts` に以下を追加：

```typescript
export interface ExtractClipByTimeRequest {
  startTimeSeconds: number;
  endTimeSeconds: number;
  title?: string;
}

export interface ExtractClipByTimeResponse {
  videoId: string;
  clipId: string;
  status: 'extracting' | 'completed' | 'failed';
}
```

---

## フロントエンド実装

### 新規コンポーネント

#### `TimelineClipSelector`

`apps/webapp/src/components/features/clip-extraction/timeline-clip-selector.tsx`

タイムラインからセクションを選択するためのコンポーネント。

```typescript
interface TimelineClipSelectorProps {
  sentences: RefinedSentence[];
  onExtract: (startTime: number, endTime: number) => void;
  extracting: boolean;
}
```

#### 状態管理

```typescript
// 選択範囲（連続するセクションのインデックス）
const [selectedRange, setSelectedRange] = useState<{
  startIndex: number;
  endIndex: number;
} | null>(null);
```

### 既存コンポーネント修正

#### `video-detail-client.tsx`

1. セグメンテッドコントロール用の状態追加
   ```typescript
   type ClipExtractionMode = 'by-instruction' | 'by-timeline';
   const [clipExtractionMode, setClipExtractionMode] = useState<ClipExtractionMode>('by-instruction');
   ```

2. モードに応じたUIの出し分け

3. `handleExtractClipByTime` ハンドラー追加

### 新規Server Action

`apps/webapp/src/server/presentation/clip-video/actions/extractClipByTime.ts`

```typescript
export async function extractClipByTime(
  videoId: string,
  params: { startTimeSeconds: number; endTimeSeconds: number; title?: string }
): Promise<ExtractClipByTimeResponse>
```

---

## ファイル変更一覧

### 新規作成

| ファイルパス | 説明 |
|-------------|------|
| `apps/backend/src/contexts/clip-video/application/usecases/extract-clip-by-time.usecase.ts` | タイムスタンプ指定切り出しUseCase |
| `apps/webapp/src/components/features/clip-extraction/timeline-clip-selector.tsx` | タイムライン選択コンポーネント |
| `apps/webapp/src/server/presentation/clip-video/actions/extractClipByTime.ts` | Server Action |

### 修正

| ファイルパス | 修正内容 |
|-------------|----------|
| `apps/shared/types/api.ts` | 新規API型定義追加 |
| `apps/backend/src/contexts/clip-video/presentation/routes/videos.ts` | 新規エンドポイント追加 |
| `apps/webapp/src/app/videos/[id]/video-detail-client.tsx` | セグメンテッドコントロール追加、モード切り替え |
| `apps/webapp/src/server/infrastructure/clients/backend-client.ts` | 新規API呼び出しメソッド追加 |

---

## テスト方針

### バックエンド

| レイヤー | テスト種別 | テスト内容 |
|---------|-----------|-----------|
| UseCase | unit | `ExtractClipByTimeUseCase` の正常系・異常系 |
| Route | integration | API エンドポイントの動作確認 |

### フロントエンド

| テスト種別 | テスト内容 |
|-----------|-----------|
| E2E | タイムライン選択 → 切り抜き作成の一連の流れ |

---

## 考慮事項

### 選択範囲の制限

- 最小時間: 5秒（それ以下は切り抜きとして意味がない）
- 最大時間: 10分（長すぎる切り抜きは処理負荷が高い）

### タイトル自動生成

`title` が省略された場合、選択したセクションのテキストから先頭N文字を抽出してタイトルとする（既存の `Clip.create` ロジックに準拠）。

### エラーハンドリング

- タイムスタンプが動画の長さを超える場合 → ValidationError
- 連続しないセクションを選択しようとした場合 → フロントエンドでブロック（APIには到達しない）

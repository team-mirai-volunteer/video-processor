# 参照画像機能による画像生成一貫性の実装

## 目的

**ショート動画制作者**が、**複数シーンでキャラクターやスタイルがバラバラになる問題**を解消するため。

参照画像を渡すことで、同一動画内の全シーンで一貫したビジュアル（キャラクター、画風）を実現する。

---

## 背景調査

### Gemini API 参照画像機能

Gemini API（Nano Banana）には、画像生成の一貫性を保つ2つの方式がある：

1. **マルチターン編集（gemini-2.5-flash-image）**
   - 最初の画像を生成後、その画像をコンテキストとして次の画像を生成
   - 会話形式でスタイル・キャラクターの一貫性を維持
   - 既存モデル（gemini-2.5-flash-image）で利用可能

2. **参照画像入力（gemini-3-pro-image-preview）**
   - 事前に用意した参照画像（最大14枚）を入力として渡す
   - オブジェクト6枚、人物5枚まで高忠実度で再現可能
   - 専用モデル（gemini-3-pro-image-preview）が必要

### 採用方式

**マルチターン編集方式**を採用する。

理由：
- 既存のgemini-2.5-flash-imageモデルで利用可能
- 追加のモデル変更不要
- レートリミットの制約が少ない

---

## 現状のコード構造

### ImageGenGateway インターフェース

```
apps/backend/src/contexts/shorts-gen/domain/gateways/image-gen.gateway.ts
```

```typescript
interface ImageGenParams {
  prompt: string;
  negativePrompt?: string;
  width: number;
  height: number;
  style?: string;
  seed?: number;
}

interface ImageGenGateway {
  generate(params: ImageGenParams): Promise<Result<ImageGenResult, ImageGenGatewayError>>;
  getSupportedDimensions(): { width: number; height: number }[];
  getSupportedStyles(): string[];
}
```

### NanoBananaImageGenClient

```
apps/backend/src/contexts/shorts-gen/infrastructure/clients/nano-banana-image-gen.client.ts
```

- 現在は単一画像生成のみ対応
- 参照画像機能なし
- マルチターン会話機能なし

---

## 設計

### 1. Gateway インターフェース拡張

`ImageGenParams`に参照画像パラメータを追加する。

```typescript
interface ReferenceImage {
  /** 画像データ（Buffer） */
  imageBuffer: Buffer;
  /** MIMEタイプ（例: 'image/png', 'image/jpeg'） */
  mimeType: string;
}

interface ImageGenParams {
  prompt: string;
  negativePrompt?: string;
  width: number;
  height: number;
  style?: string;
  seed?: number;
  /** 参照画像（スタイル・キャラクター一貫性のため） */
  referenceImages?: ReferenceImage[];
}
```

### 2. NanoBananaImageGenClient 実装変更

参照画像が渡された場合、マルチターン形式のリクエストを構築する。

#### リクエスト形式

参照画像なし（現行）：
```json
{
  "contents": [
    {
      "parts": [{ "text": "プロンプト" }]
    }
  ],
  "generationConfig": { ... }
}
```

参照画像あり（新規）：
```json
{
  "contents": [
    {
      "role": "user",
      "parts": [
        { "text": "このキャラクターを使って画像を生成してください" },
        {
          "inline_data": {
            "mime_type": "image/png",
            "data": "<BASE64>"
          }
        }
      ]
    },
    {
      "role": "model",
      "parts": [
        { "text": "了解しました。このキャラクターのスタイルで画像を生成します。" }
      ]
    },
    {
      "role": "user",
      "parts": [{ "text": "実際のプロンプト" }]
    }
  ],
  "generationConfig": { ... }
}
```

#### 実装ポイント

- `referenceImages`が空または未指定の場合は現行の動作を維持
- 参照画像は最大3枚まで（gemini-2.5-flash-imageの推奨上限）
- 参照画像のサイズ制限（大きすぎる場合はリサイズを検討）

### 3. エラーハンドリング

新規エラータイプは追加しない。既存のエラータイプで対応：
- 参照画像が多すぎる場合 → `INVALID_PROMPT`
- 参照画像形式不正 → `API_ERROR`

---

## ファイル変更一覧

| ファイル | 変更内容 |
|---------|---------|
| `apps/backend/src/contexts/shorts-gen/domain/gateways/image-gen.gateway.ts` | `ReferenceImage`型追加、`ImageGenParams`に`referenceImages`追加 |
| `apps/backend/src/contexts/shorts-gen/infrastructure/clients/nano-banana-image-gen.client.ts` | 参照画像付きリクエスト構築ロジック追加 |
| `apps/backend/test/contexts/shorts-gen/infrastructure/clients/nano-banana-image-gen.client.integration.test.ts` | 参照画像テストケース追加 |

---

## 統合テスト

### テストファイル

```
apps/backend/test/contexts/shorts-gen/infrastructure/clients/nano-banana-image-gen.client.integration.test.ts
```

### 使用するfixture

既存のfixture画像を参照画像として使用する：

```
apps/backend/test/contexts/shorts-gen/fixtures/input/images/scene1.png  # 夜空と三日月の風景画像
apps/backend/test/contexts/shorts-gen/fixtures/input/images/scene2.png
apps/backend/test/contexts/shorts-gen/fixtures/input/images/scene3.png
```

出力先：
```
apps/backend/test/contexts/shorts-gen/fixtures/output/nano-banana/
```

### 追加するテストケース

#### 1. fixture画像を参照画像として渡すテスト

```typescript
it('should generate image with reference image from fixture', async () => {
  // fixture画像を読み込み
  const referenceImagePath = path.join(FIXTURES_DIR, 'input/images/scene1.png');
  const referenceImageBuffer = await fs.promises.readFile(referenceImagePath);

  // 参照画像のスタイルを引き継いで新しい画像を生成
  const result = await client.generate({
    prompt: 'A similar night sky scene with a full moon over mountains',
    width: 1080,
    height: 1920,
    referenceImages: [{
      imageBuffer: referenceImageBuffer,
      mimeType: 'image/png',
    }],
  });

  expect(result.success).toBe(true);
  if (result.success) {
    // 出力を保存して目視確認可能に
    const outputPath = path.join(OUTPUT_DIR, `test-reference-single.${result.value.format}`);
    await fs.promises.writeFile(outputPath, result.value.imageBuffer);
    console.log(`Generated image with reference saved to: ${outputPath}`);
  }
}, 60000);
```

#### 2. 複数fixture画像を参照画像として渡すテスト

```typescript
it('should generate image with multiple reference images from fixtures', async () => {
  // 複数のfixture画像を読み込み
  const ref1 = await fs.promises.readFile(path.join(FIXTURES_DIR, 'input/images/scene1.png'));
  const ref2 = await fs.promises.readFile(path.join(FIXTURES_DIR, 'input/images/scene2.png'));

  const result = await client.generate({
    prompt: 'A new scene combining the visual style of these reference images',
    width: 1080,
    height: 1920,
    referenceImages: [
      { imageBuffer: ref1, mimeType: 'image/png' },
      { imageBuffer: ref2, mimeType: 'image/png' },
    ],
  });

  expect(result.success).toBe(true);
  if (result.success) {
    const outputPath = path.join(OUTPUT_DIR, `test-reference-multiple.${result.value.format}`);
    await fs.promises.writeFile(outputPath, result.value.imageBuffer);
    console.log(`Generated image with multiple references saved to: ${outputPath}`);
  }
}, 60000);
```

#### 3. 参照画像なしの後方互換性テスト（既存テストで担保）

既存のテストケースがそのまま後方互換性テストとなる。`referenceImages`が未指定の場合は従来どおり動作することを確認。

#### 4. 空の参照画像配列テスト

```typescript
it('should work with empty reference images array', async () => {
  const result = await client.generate({
    prompt: 'A simple test image',
    width: 1024,
    height: 1024,
    referenceImages: [], // 空配列
  });

  expect(result.success).toBe(true);
}, 60000);
```

### テスト実行条件

既存と同様：
```typescript
const runIntegrationTests = process.env.INTEGRATION_TEST === 'true' && isGeminiConfigured();
```

---

## 実装順序

1. `image-gen.gateway.ts`に`ReferenceImage`型と`referenceImages`パラメータを追加
2. `nano-banana-image-gen.client.ts`にマルチターンリクエスト構築ロジックを実装
3. 統合テストを追加・実行して動作確認
4. lint/typecheckの実行

---

## 補足

- 参照画像機能はオプショナルであり、既存のユースケースへの影響はない
- 将来的にgemini-3-pro-image-previewへの切り替えが必要になった場合も、Gatewayインターフェースは変更不要

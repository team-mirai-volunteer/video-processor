# 字幕フォント日本語対応

## 目的

**ショート動画生成機能を利用するユーザーが、Cloud Run環境で日本語字幕が正しく表示されない問題を解消するため。**

現状、字幕生成時のデフォルトフォント `Hiragino Kaku Gothic Pro` はmacOS専用であり、Cloud Run（Linux）環境には存在しない。これにより、本番環境で日本語が文字化けまたは表示されない。

## 現状分析

### 問題のあるコード

[ffmpeg-subtitle-generator.client.ts:21](../apps/backend/src/contexts/shorts-gen/infrastructure/clients/ffmpeg-subtitle-generator.client.ts#L21)

```typescript
const DEFAULT_FONT_FAMILY = process.env.SUBTITLE_FONT_FAMILY || 'Hiragino Kaku Gothic Pro';
```

- `Hiragino Kaku Gothic Pro` はmacOS専用フォント
- Cloud Run（Debian Linux）には存在しない
- 環境変数 `SUBTITLE_FONT_FAMILY` は現在設定されていない

### Dockerfileの現状

[Dockerfile:37](../apps/backend/Dockerfile#L37)

```dockerfile
RUN apt-get update && apt-get install -y ffmpeg openssl && rm -rf /var/lib/apt/lists/*
```

- FFmpegとOpenSSLのみインストール
- 日本語フォントがインストールされていない

## 解決策

### 採用するフォント: Noto Sans CJK JP

| 項目 | 内容 |
|------|------|
| フォント名 | Noto Sans CJK JP |
| 提供元 | Google |
| ライセンス | SIL Open Font License 1.1 |
| 商用利用 | OK |
| 再配布 | OK |
| パッケージ名 | `fonts-noto-cjk` |

**選定理由:**
- Google製で品質が高い
- SIL OFLライセンスにより商用利用・再配布が自由
- 世界中で広く使われており、信頼性が高い
- Debianの標準リポジトリからインストール可能

## 変更箇所

### 1. Dockerfile（インフラ変更）

**ファイル:** `apps/backend/Dockerfile`

**変更内容:** Production stageで日本語フォントをインストール

```dockerfile
# Production stage
FROM node:22-slim AS runner

# Install FFmpeg, OpenSSL, and Japanese fonts
RUN apt-get update && apt-get install -y \
    ffmpeg \
    openssl \
    fonts-noto-cjk \
    && rm -rf /var/lib/apt/lists/* \
    && fc-cache -fv
```

**ポイント:**
- `fonts-noto-cjk` パッケージをインストール
- `fc-cache -fv` でフォントキャッシュを更新

### 2. バックエンドコード

**ファイル:** `apps/backend/src/contexts/shorts-gen/infrastructure/clients/ffmpeg-subtitle-generator.client.ts`

**変更内容:** デフォルトフォントをプラットフォームに応じて切り替え

```typescript
/**
 * Default font family with fallbacks for different platforms
 * - Linux (Cloud Run): Noto Sans CJK JP
 * - macOS (local dev): Hiragino Kaku Gothic Pro
 */
const DEFAULT_FONT_FAMILY =
  process.env.SUBTITLE_FONT_FAMILY ||
  (process.platform === 'darwin' ? 'Hiragino Kaku Gothic Pro' : 'Noto Sans CJK JP');
```

**ポイント:**
- 環境変数 `SUBTITLE_FONT_FAMILY` が最優先
- macOS（darwin）では `Hiragino Kaku Gothic Pro` を使用（ローカル開発用）
- Linux（Cloud Run）では `Noto Sans CJK JP` を使用

### 3. Terraform（任意、環境変数で明示する場合）

**ファイル:** `infrastructure/terraform/modules/cloud-run/main.tf`

明示的に環境変数を設定する場合のみ追加が必要。コード側でプラットフォーム判定するため、Terraform変更は不要。

## イメージサイズへの影響

`fonts-noto-cjk` パッケージは約150MB程度。現在のイメージサイズに対して許容範囲内。

## テスト方法

1. ローカル環境でDocker buildしてフォントがインストールされることを確認
2. ステージング環境にデプロイし、字幕生成を実行
3. 生成された字幕画像で日本語が正しく表示されることを確認

## 実装手順

1. `apps/backend/Dockerfile` を修正（フォントインストール追加）
2. `ffmpeg-subtitle-generator.client.ts` を修正（フォントフォールバック改善）
3. ローカルでDocker buildして動作確認
4. PRを作成してレビュー
5. マージ後、CI/CDでCloud Runにデプロイ

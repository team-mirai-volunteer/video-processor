# クリップ削除機能設計

## 目的

ユーザーが不要になったクリップを削除して、クリップ一覧を整理できるようにするため。

## 前提条件

- RDBの関連情報（Clipレコード）のみ削除する
- Google Driveにアップロード済みの動画ファイルは削除しない

---

## 現状

### Clipテーブル構造

| カラム | 型 | 説明 |
|--------|-----|------|
| id | String | 主キー |
| videoId | String | 親動画への外部キー |
| googleDriveFileId | String? | アップロード後のDrive ID |
| googleDriveUrl | String? | アップロード後のDrive URL |
| title | String | クリップタイトル |
| status | String | pending / processing / completed / failed |
| ... | ... | その他フィールド |

### 既存リポジトリメソッド

`ClipRepository` (apps/backend/src/contexts/clip-video/infrastructure/repositories/clip.repository.ts):
- `save(clip)` - 単一クリップの保存
- `saveMany(clips)` - 複数クリップの一括保存
- `findById(id)` - ID指定で取得
- `findByVideoId(videoId)` - 動画ID指定で取得
- `findAllPaginated(params)` - ページング取得

**deleteメソッドは未実装**

### 既存API

`clips.ts` (apps/backend/src/contexts/clip-video/presentation/routes/clips.ts):
- `GET /api/clips` - 全クリップ一覧
- `GET /api/videos/:videoId/clips` - 特定動画のクリップ一覧
- `GET /api/clips/:id` - クリップ詳細

**DELETE APIは未実装**

---

## 設計

### バックエンド

#### 1. ClipRepository.delete() の追加

**ファイル**: `apps/backend/src/contexts/clip-video/infrastructure/repositories/clip.repository.ts`

```typescript
async delete(id: string): Promise<void> {
  await this.prisma.clip.delete({
    where: { id },
  });
}
```

#### 2. DeleteClipUseCase の作成

**ファイル**: `apps/backend/src/contexts/clip-video/application/usecases/delete-clip.usecase.ts`

**処理フロー**:
1. クリップIDでクリップを取得
2. クリップが存在しない場合は `NotFoundError` をthrow
3. クリップを削除

**インターフェース**:
```typescript
interface DeleteClipInput {
  clipId: string;
}

interface DeleteClipOutput {
  deletedClipId: string;
}
```

#### 3. DELETE API の追加

**ファイル**: `apps/backend/src/contexts/clip-video/presentation/routes/clips.ts`

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/clips/:id` | DELETE | クリップを削除 |

**レスポンス**:
- 成功時: `204 No Content`
- 存在しない場合: `404 Not Found`

### フロントエンド

#### 削除可能な画面

| 画面 | パス | 使用コンポーネント |
|------|------|------------------|
| クリップ一覧ページ | `/clips` | `ClipListTable` |
| 動画詳細ページ | `/videos/[id]` | `ClipList` → `ClipCard` |

#### 1. Server Action の追加

**ファイル**: `apps/webapp/src/server/presentation/clip-video/actions/deleteClip.ts` (新規作成)

```typescript
'use server'

export async function deleteClip(clipId: string): Promise<{ success: boolean; error?: string }> {
  // DELETE /api/clips/:id を呼び出し
  // 成功時: revalidatePath('/clips') と revalidatePath('/videos/[id]')
}
```

#### 2. ClipCard コンポーネントの修正

**ファイル**: `apps/webapp/src/components/features/clip-list/clip-card.tsx`

- 削除ボタンを追加（ゴミ箱アイコン）
- ボタン配置: CardHeaderの右上（Badgeの横）
- `onDelete` コールバックpropsを追加

```typescript
interface ClipCardProps {
  clip: Clip;
  onDelete?: (clipId: string) => void;  // 追加
}
```

#### 3. ClipList コンポーネントの修正

**ファイル**: `apps/webapp/src/components/features/clip-list/clip-list.tsx`

- `onClipDelete` コールバックpropsを追加
- ClipCardに `onDelete` を渡す

```typescript
interface ClipListProps {
  clips: Clip[];
  onClipDelete?: (clipId: string) => void;  // 追加
}
```

#### 4. ClipListTable コンポーネントの修正

**ファイル**: `apps/webapp/src/components/features/clip-list/clip-list-table.tsx`

- 各行に削除ボタンを追加

#### 5. 動画詳細ページの修正

**ファイル**: `apps/webapp/src/app/videos/[id]/video-detail-client.tsx`

- ClipListに `onClipDelete` を渡す
- 削除後にvideoの状態を更新（clipsから削除したクリップを除外）

#### 6. クリップ一覧ページの修正

**ファイル**: `apps/webapp/src/app/clips/page.tsx`

- Client Componentとして削除機能をラップ
- または `ClipListTable` 内で削除処理を完結させる

#### 7. 確認ダイアログ

shadcn/ui の `AlertDialog` を使用:

- タイトル: 「クリップを削除しますか？」
- 本文: 「このクリップをリストから削除します。Google Driveにアップロードされた動画ファイルは削除されません。」
- ボタン: 「キャンセル」「削除」

---

## テスト方針

| レイヤー | テスト種別 | 対象 |
|---------|----------|------|
| application | unit | DeleteClipUseCase |
| infrastructure | integration | ClipRepository.delete() |
| webapp | e2e | 削除フロー全体 |

### ユニットテスト (DeleteClipUseCase)

- 正常系: クリップが存在する場合に削除される
- 異常系: クリップが存在しない場合に NotFoundError がthrowされる

### 統合テスト (ClipRepository)

- 正常系: 指定IDのクリップがDBから削除される
- 異常系: 存在しないIDを指定した場合の動作確認

---

## 影響範囲

### 変更対象ファイル

**バックエンド**:
- `apps/backend/src/contexts/clip-video/infrastructure/repositories/clip.repository.ts` - deleteメソッド追加
- `apps/backend/src/contexts/clip-video/application/usecases/delete-clip.usecase.ts` - 新規作成
- `apps/backend/src/contexts/clip-video/application/usecases/index.ts` - export追加
- `apps/backend/src/contexts/clip-video/presentation/routes/clips.ts` - DELETE API追加

**フロントエンド**:
- `apps/webapp/src/server/presentation/clip-video/actions/deleteClip.ts` - 新規作成（Server Action）
- `apps/webapp/src/components/features/clip-list/clip-card.tsx` - 削除ボタン追加
- `apps/webapp/src/components/features/clip-list/clip-list.tsx` - onClipDelete props追加
- `apps/webapp/src/components/features/clip-list/clip-list-table.tsx` - 削除ボタン追加
- `apps/webapp/src/app/videos/[id]/video-detail-client.tsx` - 削除ハンドラ追加

### shorts-genへの影響

現状、shorts-gen BCはClipテーブルを参照していないため、影響なし。

---

## 参照ドキュメント

- [docs/backend-architecture-guide.md](../backend-architecture-guide.md) - アーキテクチャルール
- [docs/backend-testing-guide.md](../backend-testing-guide.md) - テストガイドライン

# 字幕画像一括生成の直列化設計

**作成日**: 2026-01-31

---

## 目的（Why）

フロントエンドから字幕画像の一括生成（生成ボタン経由）が失敗する問題を解決するため。

**現在の状況**:
- 個別シーンでの字幕画像生成は成功する
- 一括生成ボタン経由での生成は失敗する
- レスポンスが早く返ってくることから、処理が途中で中断されている可能性が高い

**ユーザーへの影響**:
- 一括生成ボタンが使えず、個別に生成する手間が発生している
- ショート動画制作のワークフローが非効率になっている

---

## 問題の原因分析

### 現在の実装の調査結果

#### フロントエンド

**ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts`

- `generateAllSubtitles` 関数 (253-303行目) がバックエンドエンドポイント `/api/shorts-gen/scripts/${scriptId}/subtitles` を呼び出す
- フロントエンドは1回のHTTPリクエストでバックエンドに処理を委譲している

#### バックエンド

**ファイル**: `apps/backend/src/contexts/shorts-gen/application/usecases/generate-subtitles.usecase.ts`

現在の実装では以下の処理が **直列** で行われている:

```typescript
// 158-183行目
for (const scene of scenesWithSubtitles) {
  // 既存の字幕アセットを削除（再生成の場合）
  await this.sceneAssetRepository.deleteBySceneIdAndType(scene.id, 'subtitle_image');

  const assets = await this.generateSubtitlesForScene(
    scene,
    project.resolutionWidth,
    project.resolutionHeight,
    project.id,
    subtitleStyle,
    verticalPosition
  );

  // アセットを保存
  if (assets.length > 0) {
    await this.sceneAssetRepository.saveMany(assets);
  }

  sceneResults.push({
    sceneId: scene.id,
    order: scene.order,
    assets,
  });

  totalAssetsGenerated += assets.length;
}
```

さらに、`generateSubtitlesForScene` メソッド内でも字幕ごとに直列処理している (207-276行目):

```typescript
for (let i = 0; i < scene.subtitles.length; i++) {
  const subtitleText = scene.subtitles[i];

  // 字幕画像を生成
  const result = await this.subtitleGenerator.generate({...});

  // GCSにアップロード
  uploadResult = await this.assetStorage.upload({...});

  // ShortsSceneAssetを作成
  const assetResult = ShortsSceneAssetModel.create({...});

  assets.push(assetResult.value);
}
```

### 問題点の特定

実装は既に **完全に直列** になっている。それでも一括生成が失敗する理由として以下が考えられる:

1. **HTTPタイムアウト**: フロントエンド → Next.js API Route → バックエンドの各レイヤーでタイムアウトが設定されている可能性
2. **処理時間の長期化**: シーン数が多い場合、全シーン処理完了まで時間がかかりすぎている
3. **メモリ不足**: 大量の画像生成でメモリを使い果たしている可能性
4. **FFmpegプロセスの制約**: FFmpegが並行実行されず、プロセスが詰まっている可能性

---

## 設計方針

### 基本戦略

**ストリーミング処理への移行** を検討せず、まず以下の対策を実施する:

1. **タイムアウトの延長**: HTTP層のタイムアウトを延長
2. **進捗の可視化**: フロントエンドでの進捗表示の改善
3. **リトライ機能の強化**: 失敗した際の再試行を容易にする

### 設計の詳細

#### 1. バックエンド: 処理の安定性向上

**対象ファイル**: `apps/backend/src/contexts/shorts-gen/application/usecases/generate-subtitles.usecase.ts`

**変更内容**:
- 現在の直列処理はそのまま維持（既に実装済み）
- エラーハンドリングを改善し、どのシーンで失敗したか明確にする
- 部分的な成功も許容する設計に変更（一部のシーンが失敗しても他は成功とする）

**エラーハンドリング改善案**:

```typescript
const sceneResults: SceneSubtitleResult[] = [];
const errors: Array<{ sceneId: string; error: string }> = [];
let totalAssetsGenerated = 0;

for (const scene of scenesWithSubtitles) {
  try {
    await this.sceneAssetRepository.deleteBySceneIdAndType(scene.id, 'subtitle_image');

    const assets = await this.generateSubtitlesForScene(
      scene,
      project.resolutionWidth,
      project.resolutionHeight,
      project.id,
      subtitleStyle,
      verticalPosition
    );

    if (assets.length > 0) {
      await this.sceneAssetRepository.saveMany(assets);
    }

    sceneResults.push({
      sceneId: scene.id,
      order: scene.order,
      assets,
      success: true,
    });

    totalAssetsGenerated += assets.length;
  } catch (error) {
    // シーンごとのエラーをキャッチして記録
    errors.push({
      sceneId: scene.id,
      error: error instanceof Error ? error.message : String(error),
    });

    sceneResults.push({
      sceneId: scene.id,
      order: scene.order,
      assets: [],
      success: false,
      error: error instanceof Error ? error.message : String(error),
    });
  }
}

return {
  scriptId,
  projectId: project.id,
  sceneResults,
  totalScenesProcessed: scenesWithSubtitles.length,
  totalAssetsGenerated,
  errors: errors.length > 0 ? errors : undefined,
};
```

#### 2. フロントエンド: タイムアウト対策

**対象ファイル**: `apps/webapp/src/app/api/shorts-gen/scripts/[scriptId]/subtitles/route.ts`

**変更内容**:
- Next.js API Route のタイムアウトを延長（`export const maxDuration = 300` を追加）
- fetch のタイムアウトを適切に設定

```typescript
export const maxDuration = 300; // 5分

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ scriptId: string }> }
) {
  const { scriptId } = await params;

  try {
    const body = await request.json().catch(() => ({}));
    const backendUrl = `${BACKEND_URL}/api/shorts-gen/scripts/${scriptId}/subtitles`;

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分

    const response = await fetch(backendUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(BACKEND_API_KEY && { 'X-API-Key': BACKEND_API_KEY }),
      },
      body: JSON.stringify(body),
      signal: controller.signal,
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      return new Response(errorText, {
        status: response.status,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    const data = await response.json();
    return new Response(JSON.stringify(data), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error proxying subtitle generate request:', error);
    return new Response(JSON.stringify({ error: 'Internal server error' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
```

#### 3. フロントエンド: 進捗表示の改善

**対象ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts`

**変更内容**:
- バックエンドからの部分成功レスポンスに対応
- エラーがあっても成功したシーンは表示する

```typescript
const handleAllSubtitlesGenerate = useCallback(async (): Promise<GenerateAllAssetsResponse> => {
  if (!script) throw new Error('Script not found');
  const response = await fetch(`/api/shorts-gen/scripts/${script.id}/subtitles`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
  });
  if (!response.ok) {
    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
    throw new Error(error.error || 'Failed to generate subtitles');
  }
  const data = await response.json();

  // エラーがあってもresultsは返す
  return {
    success: !data.errors || data.errors.length === 0,
    results:
      data.sceneResults?.map(
        (sr: { sceneId: string; success: boolean; assets?: unknown[]; error?: string }) => ({
          sceneId: sr.sceneId,
          success: sr.success,
          assets: sr.assets,
          error: sr.error,
        })
      ) || [],
    partialSuccess: data.errors && data.errors.length > 0,
    errors: data.errors,
  };
}, [script]);
```

---

## 型定義の変更

### バックエンド

**ファイル**: `apps/backend/src/contexts/shorts-gen/application/usecases/generate-subtitles.usecase.ts`

```typescript
export interface SceneSubtitleResult {
  sceneId: string;
  order: number;
  assets: ShortsSceneAsset[];
  success: boolean;  // 追加
  error?: string;    // 追加
}

export interface GenerateSubtitlesOutput {
  scriptId: string;
  projectId: string;
  sceneResults: SceneSubtitleResult[];
  totalScenesProcessed: number;
  totalAssetsGenerated: number;
  errors?: Array<{ sceneId: string; error: string }>;  // 追加
}
```

### フロントエンド

**ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/types.ts`

```typescript
export interface GenerateAllAssetsResponse {
  success: boolean;
  results: Array<{
    sceneId: string;
    success: boolean;
    asset?: SceneAsset;
    assets?: SceneAsset[];
    error?: string;
  }>;
  partialSuccess?: boolean;  // 追加: 一部成功、一部失敗
  errors?: Array<{ sceneId: string; error: string }>;  // 追加
}
```

---

## 実装手順

### ステップ1: バックエンドの改善

1. `generate-subtitles.usecase.ts` のエラーハンドリングを改善
   - シーンごとの try-catch を追加
   - 部分的な成功を許容する
   - エラー情報を詳細に記録

2. 型定義を更新
   - `SceneSubtitleResult` に `success` と `error` を追加
   - `GenerateSubtitlesOutput` に `errors` を追加

3. ユニットテストを更新
   - 部分的な成功のケースをテスト
   - エラーハンドリングのテスト

### ステップ2: Next.js API Route の改善

1. `apps/webapp/src/app/api/shorts-gen/scripts/[scriptId]/subtitles/route.ts` にタイムアウト設定を追加
   - `maxDuration` を追加
   - fetch のタイムアウトを設定

### ステップ3: フロントエンドの対応

1. `use-asset-generation.ts` を更新
   - 部分成功のレスポンスに対応
   - エラー表示の改善

2. 型定義を更新
   - `GenerateAllAssetsResponse` に `partialSuccess` と `errors` を追加

### ステップ4: テストと検証

1. 大量のシーンでの動作確認
2. タイムアウトの動作確認
3. 部分失敗時の挙動確認

---

## アーキテクチャルールとの整合性

本設計は `docs/backend-architecture-guide.md` のルールに準拠している:

- **Gateway の使用**: `SubtitleGeneratorGateway` と `AssetStorageGateway` を使用
- **エラーハンドリング**: Application層で throw、Presentation層でキャッチ
- **依存関係**: Domain ← Application ← Infrastructure の依存方向を維持

---

## 制約と注意点

### 制約

1. **処理時間**: 大量のシーン（例: 50シーン以上）の場合、5分でも足りない可能性がある
2. **メモリ使用量**: FFmpegが大量のメモリを消費する可能性がある

### 今後の改善案

将来的に以下の改善を検討する:

1. **ストリーミング処理**: WebSocket や Server-Sent Events を使った進捗の実時間通知
2. **バックグラウンドジョブ**: Cloud Tasks や Bull などのジョブキューを使った非同期処理
3. **キャッシュ**: 同じ字幕テキスト・スタイルの画像を再利用

---

## 変更対象ファイル

1. `apps/backend/src/contexts/shorts-gen/application/usecases/generate-subtitles.usecase.ts`
2. `apps/webapp/src/app/api/shorts-gen/scripts/[scriptId]/subtitles/route.ts`
3. `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts`
4. `apps/webapp/src/components/features/shorts-gen/asset-generation/types.ts`

---

## まとめ

本設計では、字幕画像の一括生成における失敗問題を以下の方針で解決する:

1. **タイムアウトの延長**: Next.js API Route と fetch のタイムアウトを5分に設定
2. **部分成功の許容**: 一部のシーンが失敗しても他は成功とする
3. **エラーハンドリングの改善**: どのシーンで失敗したか明確にし、ユーザーに伝える

これにより、ユーザーは一括生成ボタンを使って効率的に字幕画像を生成できるようになる。

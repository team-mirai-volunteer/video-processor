# 参照キャラクター画像登録機能の設計

## 目的

**ショート動画制作者**が、**各シーンで登場するキャラクターの外見がバラバラになる問題**を解消するため。

プロンプト一括生成の前段階で参照画像（キャラクター画像）と説明文を登録し、それを画像プロンプト生成と画像生成に活用することで、動画全体で一貫したキャラクターを実現する。

---

## 背景

既存の参照画像機能（[20260201_1245_参照画像機能による画像生成一貫性の実装.md](old/20260201_1245_参照画像機能による画像生成一貫性の実装.md)）により、`NanoBananaImageGenClient`は参照画像を受け取って一貫性のある画像を生成できる。

しかし現状では：
- 参照画像をユーザーがアップロードする手段がない
- 画像プロンプト生成時に参照画像の説明を活用する仕組みがない
- 画像生成時に参照画像を渡す仕組みがない

---

## 機能概要

1. **参照キャラクター登録（オプショナル）** - 画像 + 説明文を最大3枚まで登録
2. **画像プロンプト生成への反映** - 説明文を`styleHint`として渡す
3. **画像生成への反映** - 参照画像を`referenceImages`として渡す

---

## API仕様（先に確定）

### POST /api/shorts-gen/projects/:projectId/reference-characters

```typescript
// Request (multipart/form-data)
{
  image: File;           // 画像ファイル (PNG/JPEG, 最大5MB)
  description: string;   // キャラクター説明文
}

// Response
{
  id: string;
  projectId: string;
  description: string;
  imageUrl: string;      // 署名付きURL
  order: number;
}

// Error
// 400: 画像形式不正、説明文空、登録上限(3枚)超過
// 404: プロジェクト不存在
```

### GET /api/shorts-gen/projects/:projectId/reference-characters

```typescript
// Response
{
  projectId: string;
  characters: Array<{
    id: string;
    description: string;
    imageUrl: string;    // 署名付きURL
    order: number;
  }>;
}
```

### DELETE /api/shorts-gen/projects/:projectId/reference-characters/:id

```typescript
// Response
{ success: true }

// Error
// 404: キャラクター不存在
```

### 共有型定義

```typescript
// apps/shared/types/shorts-gen.ts に追加
export interface ReferenceCharacter {
  id: string;
  projectId: string;
  description: string;
  imageUrl: string;
  order: number;
}
```

---

## 実装ステップ

### Step 0: 共通基盤（最初に実施）

| 内容 | ファイル |
|------|----------|
| DBスキーマ追加 | `schema.prisma` |
| 共有型定義 | `apps/shared/types/shorts-gen.ts` |

```prisma
model ShortsReferenceCharacter {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  description String
  imageUrl    String   @map("image_url")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project ShortsProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("shorts_reference_characters")
}
```

---

### Step A: バックエンド（Step 0完了後）

| 内容 | ファイル |
|------|----------|
| ドメインモデル | `domain/models/reference-character.ts` |
| Gateway | `domain/gateways/reference-character-repository.gateway.ts` |
| Repository | `infrastructure/repositories/reference-character.repository.ts` |
| CRUD API | `presentation/routes/reference-character.routes.ts` |
| プロンプト生成統合 | `application/usecases/generate-image-prompts.usecase.ts` 修正 |
| 画像生成統合 | `application/usecases/generate-images.usecase.ts` 修正 |

---

### Step B: フロントエンド（Step 0完了後、Aと並列可）

| 内容 | ファイル |
|------|----------|
| Server Action | `server/presentation/actions/shorts-gen/reference-character.ts` |
| 登録UI | `components/features/shorts-gen/asset-generation/reference-character-uploader.tsx` |
| 素材生成ステップ統合 | `asset-generation-step.tsx` 修正 |
| SSR初期データ | `[projectId]/page.tsx` 修正 |

---

## 依存関係図

```
Step 0 (スキーマ・型定義)
    ↓
    ├── Step A (バックエンド) ──┐
    │                          │
    └── Step B (フロントエンド)─┴── 並列実行可
```

API仕様が確定しているため、Step AとStep Bは独立して進行可能。

---

## UI設計

画像カラムの上部に配置：

```
┌─────────────────────────────────────────────┐
│ 参照キャラクター（オプション）               │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│ │ [画像1] │ │ [画像2] │ │ [+追加] │        │
│ │ 青い猫  │ │ 赤い帽子│ │         │        │
│ │   [×]   │ │   [×]   │ │         │        │
│ └─────────┘ └─────────┘ └─────────┘        │
│ ※ 登録したキャラクターで画像を生成します    │
├─────────────────────────────────────────────┤
│ [プロンプト一括生成] [画像一括生成]          │
```

---

## 注意事項

- **後方互換性**: 参照キャラクター未登録の場合は既存動作と同一
- **画像サイズ**: アップロード時に1024px以下にリサイズ
- **上限**: 1プロジェクトあたり最大3枚（NanoBanana推奨上限）

# GCP Terraform インフラ設計

## 目的

開発者が本番環境とステージング環境を安全かつ再現可能にデプロイできるようにするため。

手動でのGCPリソース作成による設定漏れ・環境差異を解消し、コードでインフラを管理することで運用負荷を軽減する。

## 設計スコープ

- GCPリソースのTerraform化（Backend API向け）
- 本番環境（prod）とステージング環境（stg）の2環境
- 環境変数の安全な管理（tfvars + envsubst パターン）

### スコープ外

- Frontend（Vercelで継続運用）
- Load Balancer / カスタムドメイン（Cloud RunデフォルトURLを使用）
- CI/CD パイプライン（別途設計）

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                         GCP Project                          │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                    Cloud Run                          │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  video-processor-{env}-api                     │  │   │
│  │  │  - Container Image from Artifact Registry      │  │   │
│  │  │  - 環境変数: DATABASE_URL, CORS_ORIGIN, etc    │  │   │
│  │  │  - https://xxx.run.app (デフォルトURL)         │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                 │
│                            │ VPC Connector                   │
│                            ▼                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                       VPC                             │   │
│  │  ┌─────────────┐    ┌─────────────┐                  │   │
│  │  │  Subnet     │    │ Cloud NAT   │                  │   │
│  │  │ 10.0.0.0/24 │    │ (外部API用) │                  │   │
│  │  └─────────────┘    └─────────────┘                  │   │
│  │         │                                             │   │
│  │         ▼                                             │   │
│  │  ┌─────────────────────────────────────────────────┐ │   │
│  │  │              Cloud SQL (PostgreSQL 15)          │ │   │
│  │  │  - Private IP (VPC内からのみアクセス可)         │ │   │
│  │  │  - 自動バックアップ (prodのみ)                  │ │   │
│  │  └─────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Artifact Registry                        │   │
│  │  - Docker images for Cloud Run                        │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Secret Manager                           │   │
│  │  - database-password                                  │   │
│  │  - google-credentials (サービスアカウントキー)        │   │
│  │  - openai-api-key                                     │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## ディレクトリ構成

```
infrastructure/terraform/
├── envs/
│   ├── stg/
│   │   ├── main.tf              # モジュール呼び出し
│   │   ├── variables.tf         # 変数定義
│   │   ├── outputs.tf           # 出力値
│   │   ├── backend.tf           # tfstate設定
│   │   ├── terraform.tfvars.tpl # テンプレート (git管理)
│   │   └── terraform.tfvars     # 実値 (gitignore)
│   └── prod/
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       ├── backend.tf
│       ├── terraform.tfvars.tpl
│       └── terraform.tfvars
├── modules/
│   ├── cloud-run/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── cloud-sql/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── networking/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   └── secrets/
│       ├── main.tf
│       ├── variables.tf
│       └── outputs.tf
├── deploy.sh                    # デプロイスクリプト
└── README.md                    # 使い方
```

## 環境変数管理

### 設計方針

1. **terraform.tfvars.tpl** - テンプレートファイル（git管理）
2. **terraform.tfvars** - 実際の値を含むファイル（gitignore）
3. **deploy.sh** - envsubstでテンプレートから実ファイルを生成

### terraform.tfvars.tpl の例

```hcl
# GCP Project
project_id = "${GCP_PROJECT_ID}"
region     = "asia-northeast1"

# Database
database_password = "${DATABASE_PASSWORD}"

# Secrets (Secret Manager に格納する値)
google_credentials_json = "${GOOGLE_CREDENTIALS_JSON}"
openai_api_key          = "${OPENAI_API_KEY}"

# Application
cors_origin                  = "${CORS_ORIGIN}"
google_drive_output_folder_id = "${GOOGLE_DRIVE_OUTPUT_FOLDER_ID}"
```

### deploy.sh の構成

```bash
#!/bin/bash
set -euo pipefail

ENV=${1:-stg}
ACTION=${2:-plan}

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ENV_DIR="${SCRIPT_DIR}/envs/${ENV}"

# .env ファイルを読み込み（存在する場合）
if [ -f "${ENV_DIR}/.env" ]; then
  export $(grep -v '^#' "${ENV_DIR}/.env" | xargs)
fi

# tfvars.tpl から tfvars を生成
envsubst < "${ENV_DIR}/terraform.tfvars.tpl" > "${ENV_DIR}/terraform.tfvars"

# Terraform 実行
cd "${ENV_DIR}"
terraform init
terraform ${ACTION}
```

### .gitignore への追記

```gitignore
# Terraform
infrastructure/terraform/envs/**/terraform.tfvars
infrastructure/terraform/envs/**/.env
!infrastructure/terraform/envs/**/terraform.tfvars.tpl
```

## GCPリソース詳細

### 1. Networking モジュール

| リソース | 用途 |
|---------|------|
| VPC | プライベートネットワーク |
| Subnet | Cloud SQL / VPC Connector 用 (10.0.0.0/24) |
| Cloud Router | Cloud NAT 用 |
| Cloud NAT | 外部API（OpenAI, Google Drive）へのアウトバウンド |
| VPC Connector | Cloud Run → VPC 接続 |
| Private Service Connection | Cloud SQL プライベートIP用 |

### 2. Cloud SQL モジュール

| 設定項目 | stg | prod |
|---------|-----|------|
| バージョン | PostgreSQL 15 | PostgreSQL 15 |
| インスタンスタイプ | db-f1-micro | db-custom-2-4096 |
| ディスクサイズ | 10GB | 20GB |
| 高可用性 | ZONAL | REGIONAL |
| 自動バックアップ | 無効 | 有効（7日保持） |
| 削除保護 | 無効 | 有効 |
| IPタイプ | Private IP only | Private IP only |

### 3. Cloud Run モジュール

| 設定項目 | stg | prod |
|---------|-----|------|
| CPU | 1 | 2 |
| メモリ | 1Gi | 2Gi |
| 最小インスタンス | 0 | 1 |
| 最大インスタンス | 2 | 10 |
| リクエストタイムアウト | 300秒 | 3600秒 |
| 認証 | 未認証許可 | 未認証許可 |

Cloud Run環境変数:
- `NODE_ENV` - production
- `DATABASE_URL` - Cloud SQL接続文字列（Unix socket）
- `CORS_ORIGIN` - 許可するオリジン
- `GOOGLE_CLOUD_PROJECT` - プロジェクトID
- `GOOGLE_DRIVE_OUTPUT_FOLDER_ID` - Google Drive出力先

Secret Manager参照:
- `OPENAI_API_KEY`
- `GOOGLE_APPLICATION_CREDENTIALS` (サービスアカウントキー)

### 4. Secrets モジュール

| シークレット名 | 用途 |
|---------------|------|
| `database-password` | Cloud SQL ユーザーパスワード |
| `google-credentials` | Google Drive/Speech APIアクセス用サービスアカウントキー |
| `openai-api-key` | OpenAI API キー |

### 5. IAM (Cloud Run サービスアカウント)

| ロール | 用途 |
|-------|------|
| `roles/cloudsql.client` | Cloud SQL 接続 |
| `roles/secretmanager.secretAccessor` | Secret Manager 読み取り |
| `roles/logging.logWriter` | Cloud Logging 書き込み |
| `roles/cloudtrace.agent` | Cloud Trace |

## 有効化が必要なAPI

```
run.googleapis.com
sqladmin.googleapis.com
compute.googleapis.com
vpcaccess.googleapis.com
servicenetworking.googleapis.com
secretmanager.googleapis.com
artifactregistry.googleapis.com
cloudresourcemanager.googleapis.com
```

## Terraform State 管理

### GCS Backend

各環境のstateはGCSバケットで管理:

```hcl
# backend.tf (stg)
terraform {
  backend "gcs" {
    bucket = "video-processor-tfstate"
    prefix = "stg"
  }
}

# backend.tf (prod)
terraform {
  backend "gcs" {
    bucket = "video-processor-tfstate"
    prefix = "prod"
  }
}
```

### 初期セットアップ

tfstateバケットはTerraform管理外で事前作成が必要:

```bash
# 初回のみ手動で実行
gcloud storage buckets create gs://video-processor-tfstate \
  --location=asia-northeast1 \
  --uniform-bucket-level-access
```

## 実装ファイル一覧

### Phase 1: 基盤

| ファイル | 内容 |
|---------|------|
| `modules/networking/main.tf` | VPC, Subnet, NAT, VPC Connector |
| `modules/networking/variables.tf` | project_id, region, env |
| `modules/networking/outputs.tf` | vpc_id, subnet_id, connector_id |

### Phase 2: データベース

| ファイル | 内容 |
|---------|------|
| `modules/cloud-sql/main.tf` | Cloud SQL instance, database, user |
| `modules/cloud-sql/variables.tf` | tier, disk_size, ha_type, backup設定 |
| `modules/cloud-sql/outputs.tf` | connection_name, private_ip |

### Phase 3: シークレット

| ファイル | 内容 |
|---------|------|
| `modules/secrets/main.tf` | Secret Manager secrets + versions |
| `modules/secrets/variables.tf` | シークレット値（sensitive） |
| `modules/secrets/outputs.tf` | secret_ids |

### Phase 4: Cloud Run

| ファイル | 内容 |
|---------|------|
| `modules/cloud-run/main.tf` | Cloud Run service, IAM |
| `modules/cloud-run/variables.tf` | image, cpu, memory, envvars |
| `modules/cloud-run/outputs.tf` | service_url |

### Phase 5: 環境定義

| ファイル | 内容 |
|---------|------|
| `envs/stg/main.tf` | stg環境のモジュール呼び出し |
| `envs/stg/terraform.tfvars.tpl` | stg用テンプレート |
| `envs/prod/main.tf` | prod環境のモジュール呼び出し |
| `envs/prod/terraform.tfvars.tpl` | prod用テンプレート |

### Phase 6: デプロイスクリプト

| ファイル | 内容 |
|---------|------|
| `deploy.sh` | envsubst + terraform 実行 |
| `README.md` | セットアップ手順 |

## 使用方法（完成後）

### 初回セットアップ

```bash
# 1. tfstateバケット作成（初回のみ）
gcloud storage buckets create gs://video-processor-tfstate \
  --location=asia-northeast1

# 2. 環境変数ファイル作成
cp infrastructure/terraform/envs/stg/.env.example \
   infrastructure/terraform/envs/stg/.env
# .env を編集して値を設定

# 3. デプロイ
cd infrastructure/terraform
./deploy.sh stg plan    # 確認
./deploy.sh stg apply   # 適用
```

### 日常運用

```bash
# ステージング環境
./deploy.sh stg plan
./deploy.sh stg apply

# 本番環境
./deploy.sh prod plan
./deploy.sh prod apply
```

## 既存Terraform設定との関係

現在の `infrastructure/terraform/` は完全に置き換える。新しい構成では:

1. `environments/` → `envs/` にリネーム（短く）
2. `dev/` → `stg/` に変更（開発環境はローカルなので）
3. モジュール構成を整理（secrets モジュール追加）
4. tfvars テンプレート方式を導入

## 補足: Artifact Registry

Container Imageは別途ビルド＆プッシュが必要:

```bash
# イメージビルド＆プッシュ（CI/CD or 手動）
docker build -t asia-northeast1-docker.pkg.dev/${PROJECT}/video-processor/api:${TAG} .
docker push asia-northeast1-docker.pkg.dev/${PROJECT}/video-processor/api:${TAG}
```

Artifact RegistryリポジトリはTerraformで作成する。

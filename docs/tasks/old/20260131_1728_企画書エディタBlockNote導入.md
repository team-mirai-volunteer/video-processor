# 企画書エディタ BlockNote 導入設計

## 目的

ユーザーが企画書の編集時に「表示モード → 編集モード切替」のストレスを解消し、Notionのような直感的なWYSIWYG編集体験を得るため。

## 現状

現在の実装は以下の2コンポーネントで構成されている：

| コンポーネント | 役割 |
|---------------|------|
| [planning-display.tsx](../../apps/webapp/src/components/features/shorts-gen/planning/planning-display.tsx) | 企画書の表示（プレーンテキスト） |
| [planning-editor.tsx](../../apps/webapp/src/components/features/shorts-gen/planning/planning-editor.tsx) | 企画書の編集（Textarea） |

`isEditing` フラグで2つのコンポーネントを切り替えている。

**課題:**
- 表示モードから編集モードへの切り替えが必要
- Markdownのプレビューがない（プレーンテキスト表示）
- 編集時のリッチテキスト体験がない

## 設計方針

### 採用ライブラリ

**BlockNote** (`@blocknote/shadcn`)
- Notion風のブロックベースWYSIWYGエディタ
- 既存のshadcn/ui + TailwindCSSと親和性が高い
- Markdown ⇔ Block変換機能あり
- MPL-2.0ライセンス（商用利用可）

### アーキテクチャ変更

**Before:**
```
planning-generation-step.tsx
├── PlanningDisplay (表示モード)
└── PlanningEditor (編集モード)
    └── isEditing で切り替え
```

**After:**
```
planning-generation-step.tsx
└── PlanningBlockEditor (WYSIWYGエディタ、常に編集可能)
    ├── BlockNoteView (エディタ本体)
    └── 保存ボタン (差分がある時のみ有効)
```

## 実装詳細

### 1. パッケージ追加

```bash
pnpm --filter @video-processor/webapp add @blocknote/core @blocknote/react @blocknote/shadcn
```

### 2. Tailwind設定更新

[tailwind.config.js](../../apps/webapp/tailwind.config.js) の `content` にBlockNoteのパスを追加:

```js
content: [
  './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
  './src/components/**/*.{js,ts,jsx,tsx,mdx}',
  './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  './node_modules/@blocknote/shadcn/dist/**/*.js', // 追加
],
```

### 3. 新コンポーネント: PlanningBlockEditor

**ファイル:** `apps/webapp/src/components/features/shorts-gen/planning/planning-block-editor.tsx`

**Props:**

```typescript
interface PlanningBlockEditorProps {
  planning: Planning;
  onSave: (planningId: string, params: UpdatePlanningParams) => Promise<void>;
  isSaving?: boolean;
  className?: string;
}
```

**状態管理:**

| 状態 | 説明 |
|-----|------|
| `originalContent` | 保存済みのMarkdownコンテンツ（初期値） |
| `currentContent` | 現在のエディタ内容（Markdown形式） |
| `hasChanges` | `originalContent !== currentContent` で判定 |

**BlockNote初期化:**

```typescript
const editor = useCreateBlockNote({
  initialContent: await tryParseMarkdownToBlocks(planning.content),
});
```

**変更検知:**

BlockNoteの `onChange` コールバックで現在のコンテンツをMarkdownに変換し、差分を検知：

```typescript
const handleChange = async () => {
  const markdown = await editor.blocksToMarkdownLossy(editor.document);
  setCurrentContent(markdown);
};
```

**保存処理:**

```typescript
const handleSave = async () => {
  await onSave(planning.id, { content: currentContent });
  setOriginalContent(currentContent); // 保存成功後に基準を更新
};
```

### 4. UI構成

```
┌─────────────────────────────────────────────────┐
│ ┌─────────────────────────────────────────────┐ │
│ │ BlockNoteView (WYSIWYG Editor)              │ │
│ │                                             │ │
│ │ # ショート動画企画書                         │ │
│ │                                             │ │
│ │ **ターゲット:** 20代後半〜30代前半の子育て... │ │
│ │                                             │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ [バージョン 6]           [コピー] [保存]    │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

**保存ボタンの状態:**

| 状態 | 表示 |
|-----|------|
| 変更なし | disabled |
| 変更あり | enabled (primary色) |
| 保存中 | disabled + Spinner |

### 5. planning-generation-step.tsx の変更

- `PlanningDisplay` と `PlanningEditor` の切り替えロジックを削除
- `isEditing` state を削除
- 代わりに `PlanningBlockEditor` を常時表示

### 6. 削除するファイル

- `apps/webapp/src/components/features/shorts-gen/planning/planning-display.tsx`
- `apps/webapp/src/components/features/shorts-gen/planning/planning-editor.tsx`

## 影響範囲

| ファイル | 変更内容 |
|---------|---------|
| `apps/webapp/package.json` | BlockNoteパッケージ追加 |
| `apps/webapp/tailwind.config.js` | contentパス追加 |
| `planning-generation-step.tsx` | PlanningBlockEditor使用に変更 |
| `planning-block-editor.tsx` | 新規作成 |
| `planning-display.tsx` | 削除 |
| `planning-editor.tsx` | 削除 |

## 既知の制約

- BlockNoteのMarkdown変換は「Lossy」（一部情報が失われる可能性）
  - 例: ブロック引用符のネスト、チェックリストの一部
- 現状の企画書は基本的なMarkdown（見出し、太字、リスト）のみ使用しているため、影響は軽微

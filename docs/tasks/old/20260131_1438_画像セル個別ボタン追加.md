# 画像セルにプロンプト生成・画像生成ボタンを個別追加

## 目的

ユーザーが各シーンの画像を個別に制御できるようにするため。現状は一括生成のみで、特定シーンだけプロンプトを再生成したり、画像を再生成したりする操作ができない。

## 現状

### バックエンドAPI（実装済み）

| 機能 | エンドポイント | 用途 |
|------|---------------|------|
| プロンプト一括生成 | `POST /api/shorts-gen/scripts/:scriptId/image-prompts` | 全シーンのプロンプト生成 |
| プロンプト個別生成 | `POST /api/shorts-gen/scenes/:sceneId/image-prompts` | **単一シーンのプロンプト再生成** |
| 画像一括生成 | `POST /api/shorts-gen/scripts/:scriptId/images` | 全シーンの画像生成 |
| 画像個別生成 | `POST /api/shorts-gen/scenes/:sceneId/images` | **単一シーンの画像再生成** |
| プロンプト取得 | `GET /api/shorts-gen/scripts/:scriptId/image-prompts` | プロンプト一覧取得 |
| 画像取得 | `GET /api/shorts-gen/scripts/:scriptId/images` | 画像アセット一覧取得 |

### フロントエンド現状

- `asset-generation-step.tsx`: 3カラム（音声・字幕・画像）で素材生成UI
- `scene-asset-item.tsx`: 各シーンのアセット表示、再生成ボタンあり（`onRegenerate`）
- `use-asset-generation.ts`: 状態管理、`generateImage(sceneId)` は存在するが画像生成のみ
- 画像セルでは「プロンプト生成」と「画像生成」が分離されていない

## 設計

### 1. 型追加 (types.ts)

```typescript
// 既に追加済み
export interface GenerateImagePromptResponse {
  sceneId: string;
  imagePrompt: string;
  styleHint: string | null;
}
```

### 2. Server Action追加 (generateImage.ts)

以下の関数を追加：

```typescript
export async function generateImagePrompt(
  sceneId: string,
  styleHint?: string
): Promise<GenerateImagePromptResponse>
```

バックエンドの `POST /api/shorts-gen/scenes/:sceneId/image-prompts` を呼び出す。

### 3. Scene型拡張 (types.ts)

`Scene` 型に `imagePrompt` の状態を追跡するため、画像セル用の拡張情報を持たせる。

既存：
```typescript
export interface Scene {
  id: string;
  order: number;
  summary: string;
  visualType: VisualType;
  voiceText: string | null;
  subtitles: string[];
  silenceDurationMs: number | null;
  imagePrompt: string | null;  // これは既にある
}
```

### 4. use-asset-generation.ts 修正

#### 4.1 状態追加

画像カラムの各シーンに対して「プロンプト生成中」の状態を追加：

```typescript
interface AssetGenerationState {
  // 既存
  voice: Record<string, SceneAssetState>;
  subtitle: Record<string, SceneAssetState>;
  image: Record<string, SceneAssetState>;
  // 追加
  imagePrompt: Record<string, ImagePromptState>;
  // 既存
  isGeneratingVoice: boolean;
  isGeneratingSubtitle: boolean;
  isGeneratingImage: boolean;
  // 追加
  isGeneratingImagePrompt: boolean;
}

interface ImagePromptState {
  sceneId: string;
  status: 'pending' | 'running' | 'completed' | 'error';
  imagePrompt?: string;
  error?: string;
}
```

#### 4.2 コールバック追加

```typescript
interface UseAssetGenerationOptions {
  // 既存のコールバックに追加
  onImagePromptGenerate?: (sceneId: string) => Promise<GenerateImagePromptResponse>;
}
```

#### 4.3 メソッド追加

```typescript
// 個別プロンプト生成
generateImagePrompt: (sceneId: string) => Promise<void>
```

### 5. scene-asset-item.tsx 修正

画像カラム（`columnType === 'image'`）の場合のみ、以下のボタンを表示：

| ボタン | 表示条件 | アクション |
|--------|----------|------------|
| プロンプト生成 | `visualType === 'image_gen'` | `onGeneratePrompt()` |
| 画像生成 | `visualType === 'image_gen' && imagePrompt あり` | `onGenerateImage()` |

#### Props追加

```typescript
interface SceneAssetItemProps {
  // 既存
  scene: Scene;
  state: SceneAssetState;
  columnType: AssetColumnData['id'];
  onRetry?: () => void;
  onRegenerate?: () => void;
  onPreview?: () => void;
  // 追加（画像カラム専用）
  imagePromptState?: ImagePromptState;
  onGeneratePrompt?: () => void;
  onGenerateImage?: () => void;
}
```

#### UI設計

```
┌─────────────────────────────────────────┐
│ シーン 1                                │
│ プロンプト: A cute anime cat...         │
│                                         │
│ [プロンプト生成] [画像生成] [プレビュー]   │
└─────────────────────────────────────────┘
```

- プロンプト未設定時: 「プロンプト生成」ボタンのみ有効
- プロンプト設定済み: 両方のボタンが有効
- 各ボタンは個別にローディング状態を持つ

### 6. asset-generation-step.tsx 修正

#### 6.1 コールバック追加

```typescript
export interface AssetGenerationStepProps {
  // 既存に追加
  onImagePromptGenerate?: (sceneId: string) => Promise<GenerateImagePromptResponse>;
}
```

#### 6.2 SceneAssetItem への props 追加

AssetColumn コンポーネント内で、画像カラムの場合のみ追加の props を渡す。

### 7. project-detail-client.tsx 修正

Server Action を呼び出すコールバックを追加し、AssetGenerationStep に渡す。

## 実装順序

1. **generateImage.ts**: `generateImagePrompt` Server Action 追加
2. **types.ts**: `ImagePromptState` 型追加、index.ts でエクスポート
3. **use-asset-generation.ts**:
   - `imagePrompt` 状態追加
   - `generateImagePrompt` メソッド追加
   - `onImagePromptGenerate` コールバック対応
4. **scene-asset-item.tsx**: 画像カラム用のボタンUI追加
5. **asset-generation-step.tsx**: 新しい props とコールバック連携
6. **project-detail-client.tsx**: Server Action 呼び出し連携

## ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `apps/webapp/src/server/presentation/actions/shorts-gen/generateImage.ts` | `generateImagePrompt` 追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/types.ts` | `ImagePromptState` 追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/index.ts` | エクスポート追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts` | 状態・メソッド追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/scene-asset-item.tsx` | ボタンUI追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/asset-generation-step.tsx` | props 追加 |
| `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx` | コールバック連携 |

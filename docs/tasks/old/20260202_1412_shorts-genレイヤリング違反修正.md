# shorts-gen レイヤリング違反修正タスク

## 目的

開発者がアーキテクチャガイドに沿った保守性の高いコードを維持できるようにするため。

現状、`shorts-gen` コンテキストの一部で `docs/backend-architecture-guide.md` に記載されたレイヤリングルールに違反している箇所があり、テスト容易性やコードの保守性に影響を与えている。

---

## タスク一覧

### タスク1: Application層でのfetch直接呼び出しをGateway化

**対象ファイル**: `apps/backend/src/contexts/shorts-gen/application/usecases/generate-planning.usecase.ts`

**問題箇所**: 225-251行目の `fetchUrlContent` 関数

```
async function fetchUrlContent(url: string): Promise<string> {
  const jinaUrl = `https://r.jina.ai/${url}`;
  const response = await fetch(jinaUrl, { ... });  // ← 違反
  ...
}
```

**違反ルール**: `application → infrastructure` の直接依存は禁止（Gateway経由で使用すべき）

**修正内容**:
1. `domain/gateways/url-content-fetcher.gateway.ts` を作成し、インターフェースを定義
2. `infrastructure/clients/jina-url-content-fetcher.client.ts` を作成し、実装を移動
3. `GeneratePlanningUseCase` の依存に `UrlContentFetcherGateway` を追加
4. `fetchUrlContent` 関数を削除し、Gateway経由の呼び出しに置き換え

---

### タスク2: Application層でのファイルシステム直接操作をGateway化

**対象ファイル**: `apps/backend/src/contexts/shorts-gen/application/usecases/compose-video.usecase.ts`

**問題箇所**:
- 1-3行目: `fs`, `os`, `path` の直接import
- 161行目: `fs.promises.mkdtemp()` によるtempディレクトリ作成
- 239行目: `fs.promises.readFile()` によるファイル読み込み
- 482行目: `fs.promises.writeFile()` によるファイル書き込み
- 566-574行目: `cleanupTempDir()` メソッド内でのfs操作

**違反ルール**: `application → infrastructure` の直接依存は禁止

**現状**: `TempStorageGateway` が依存として注入されているが、一部のファイル操作は `fs` を直接使用している（責務が混在）

**修正内容**:
1. `TempStorageGateway` インターフェースに不足しているメソッドを追加（または `LocalFileGateway` を新設）
   - `createTempDir(): Promise<string>`
   - `readFile(path: string): Promise<Buffer>`
   - `writeFile(path: string, data: Buffer): Promise<void>`
   - `cleanup(dirPath: string): Promise<void>`
2. 既存の `TempStorageGateway` 実装を拡張
3. `compose-video.usecase.ts` から `fs`, `os`, `path` のimportを削除
4. すべてのファイル操作をGateway経由に統一

---

### タスク3: Presentation層のビジネスロジックをUseCase化

**対象ファイル**: `apps/backend/src/contexts/shorts-gen/presentation/routes/project.routes.ts`

**問題箇所**: 101-127行目（`GET /api/shorts-gen/projects` エンドポイント）

```
router.get('/', async (req, res, next) => {
  const result = await projectRepository.findMany({...});

  const projectSummaries = await Promise.all(
    result.projects.map(async (p) => {
      const [planning, script, composedVideo] = await Promise.all([
        planningRepository.findByProjectId(p.id),
        scriptRepository.findByProjectId(p.id),
        composedVideoRepository.findByProjectId(p.id),
      ]);
      // サマリー構築ロジック...
    })
  );
});
```

**問題点**: Presentation層が複数のRepositoryを直接操作してビジネスロジック（プロジェクトサマリー構築）を実行している

**修正内容**:
1. `application/usecases/get-project-summaries.usecase.ts` を作成
2. サマリー構築ロジックをUseCaseに移動
3. `project.routes.ts` からRepository直接呼び出しを削除し、UseCase経由に変更

---

## 参照ドキュメント

- [docs/backend-architecture-guide.md](../backend-architecture-guide.md) - レイヤリングルールの定義
- [docs/backend-shorts-gen-guide.md](../backend-shorts-gen-guide.md) - shorts-gen実装ガイド

# クリップ字幕機能設計

## 目的

**クリップ動画の視聴者が、字幕付きで動画を視聴できるようにするため**

クリップ動画（切り抜き動画）は音声のみだと内容が伝わりにくい場合がある。字幕を付けることで、音声が聞こえない環境でも視聴でき、SNSでの拡散性も向上する。

---

## 機能概要

1. **クリップ詳細ページ（パーマリンク）**: `/clips/[id]` でクリップ個別ページを提供
2. **字幕セグメント生成**: クリップの `transcript` を、LLMを使って適切な表示単位に分割
3. **字幕編集UI**: 自動生成された字幕を人間が編集可能にする
4. **字幕付き動画合成**: FFmpegで字幕を焼き込んだ動画を生成
5. **Google Driveアップロード**: 合成動画をDriveにアップロードし、URLを保存

---

## データモデル設計

### Prisma スキーマ追加

```prisma
// クリップの字幕セグメント情報
model ClipSubtitle {
  id              String   @id @default(uuid())
  clipId          String   @map("clip_id")
  segments        Json     // ClipSubtitleSegment[]
  status          String   @default("draft")  // draft | confirmed
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  clip Clip @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@unique([clipId])
  @@map("clip_subtitles")
}

// Clip モデルに字幕付き動画のURLを追加
model Clip {
  // ... 既存フィールド ...
  subtitledVideoGcsUri     String?  @map("subtitled_video_gcs_uri")
  subtitledVideoUrl        String?  @map("subtitled_video_url")
  subtitledVideoDriveId    String?  @map("subtitled_video_drive_id")
  subtitledVideoDriveUrl   String?  @map("subtitled_video_drive_url")

  subtitle ClipSubtitle?
}
```

### 型定義（shared）

```typescript
// apps/shared/types/clip-subtitle.ts

export interface ClipSubtitleSegment {
  index: number;
  text: string;
  startTimeSeconds: number;
  endTimeSeconds: number;
}

export interface ClipSubtitle {
  id: string;
  clipId: string;
  segments: ClipSubtitleSegment[];
  status: 'draft' | 'confirmed';
  createdAt: Date;
  updatedAt: Date;
}
```

---

## API設計

### バックエンド（Express）

| メソッド | パス | 説明 |
|---------|------|------|
| POST | `/api/clips/:clipId/subtitles/generate` | LLMで字幕セグメントを生成 |
| GET | `/api/clips/:clipId/subtitles` | 字幕セグメントを取得 |
| PUT | `/api/clips/:clipId/subtitles` | 字幕セグメントを更新（編集） |
| POST | `/api/clips/:clipId/subtitles/confirm` | 字幕を確定 |
| POST | `/api/clips/:clipId/compose` | 字幕付き動画を合成 |
| POST | `/api/clips/:clipId/upload-to-drive` | 合成動画をDriveにアップロード |

### フロントエンド BFF（Vercel Functions）

| メソッド | パス | 説明 | 備考 |
|---------|------|------|------|
| POST | `/api/clip-video/clips/[clipId]/subtitles/generate` | 字幕生成プロキシ | maxDuration: 60 |
| POST | `/api/clip-video/clips/[clipId]/compose` | 動画合成プロキシ | maxDuration: 300 |
| POST | `/api/clip-video/clips/[clipId]/upload-to-drive` | Driveアップロードプロキシ | maxDuration: 180 |

---

## 処理フロー

### 1. 字幕セグメント生成フロー

```
[クリップ詳細ページ]
    ↓ 「字幕を生成」ボタンクリック
[POST /api/clips/:clipId/subtitles/generate]
    ↓
[GenerateClipSubtitlesUseCase]
    ├─ クリップ取得（transcript, startTime, endTime）
    ├─ 元動画のRefinedTranscription取得
    ├─ クリップ範囲の sentences を抽出
    ├─ LLM呼び出し: 長い文を適切な表示単位に分割
    ├─ ClipSubtitle エンティティ作成（status: draft）
    └─ 保存
    ↓
[フロントエンド: 字幕編集UI表示]
```

### 2. 字幕編集・確定フロー

```
[字幕編集UI]
    ↓ テキスト編集、タイミング微調整
[PUT /api/clips/:clipId/subtitles]
    ↓
[UpdateClipSubtitlesUseCase]
    └─ segments更新
    ↓
[「確定」ボタンクリック]
    ↓
[POST /api/clips/:clipId/subtitles/confirm]
    ↓
[ConfirmClipSubtitlesUseCase]
    └─ status を 'confirmed' に変更
```

### 3. 字幕付き動画合成フロー

```
[「動画を合成」ボタンクリック]
    ↓
[POST /api/clips/:clipId/compose]
    ↓
[ComposeSubtitledClipUseCase]
    ├─ クリップ取得
    ├─ 字幕セグメント取得（confirmed必須）
    ├─ 元動画ファイルをGCSから取得
    ├─ FFmpegで字幕を焼き込み
    │   └─ drawtext フィルターで各セグメントを時間指定で表示
    ├─ 合成動画をGCSにアップロード
    └─ Clip.subtitledVideoGcsUri, subtitledVideoUrl を更新
```

### 4. Google Driveアップロードフロー

```
[「Driveにアップロード」ボタンクリック]
    ↓
[POST /api/clips/:clipId/upload-to-drive]
    ↓
[UploadSubtitledClipToDriveUseCase]
    ├─ GCSから合成動画をダウンロード
    ├─ Google Drive APIでアップロード
    │   └─ 元動画と同じフォルダ、または指定フォルダ
    └─ Clip.subtitledVideoDriveId, subtitledVideoDriveUrl を更新
```

---

## LLM字幕分割の設計

### データソースの使い分け

| データ | 用途 | 特徴 |
|--------|------|------|
| **Transcription（生）** | タイムスタンプ計算 | 単語単位（0.04秒〜）で精度高い。ただし漢字変換に誤りあり |
| **RefinedTranscription（精製）** | テキスト参照 | LLMで校正済み。ただし文単位でタイムスタンプが粗い |

### 入力データの前処理（フィルタリング）

生のTranscriptionは文字数が膨大なため、**クリップ範囲のみを抽出**してLLMに渡す。

```typescript
// 前処理: クリップ範囲のセグメントのみ抽出
function filterSegmentsForClip(
  segments: TranscriptionSegment[],  // 生データ（単語単位）
  clipStartSeconds: number,
  clipEndSeconds: number
): TranscriptionSegment[] {
  return segments.filter(seg =>
    seg.startTimeSeconds >= clipStartSeconds &&
    seg.endTimeSeconds <= clipEndSeconds
  );
}
```

**例**: 30分動画から30秒のクリップを切り出す場合
- 生データ全体: 数千セグメント
- フィルタ後: 数十〜百数十セグメント（LLMに渡せるサイズ）

### 入力

1. **フィルタ済みTranscription segments**: クリップ範囲の単語単位データ（タイムスタンプ用）
2. **RefinedTranscription fullText**: 校正済みテキスト（文字参照用）
3. **クリップのメタデータ**: startTimeSeconds, endTimeSeconds

### 出力

- `ClipSubtitleSegment[]`: 画面表示に適した単位に分割された字幕

### LLM処理フロー

```
1. クリップ範囲のTranscriptionセグメントを抽出（フィルタリング）
2. RefinedTranscriptionから該当範囲のテキストを取得
3. LLMに両方を渡して字幕分割を依頼
   - RefinedTextを参考にテキストを決定（漢字変換が正しい）
   - Transcriptionのタイムスタンプを使って表示時間を計算
4. 結果をClipSubtitleSegment[]として返却
```

### 分割ルール（LLMへの指示）

1. 1セグメントは15〜25文字程度を目安
2. 文の切れ目、句読点、意味の区切りで分割
3. **RefinedTextのテキストを採用**（漢字変換が正しい）
4. **Transcriptionのタイムスタンプを使用**（精度が高い）
5. 読みやすさを優先（1画面に表示する量を調整）

### プロンプト設計

```
あなたは動画字幕の編集者です。
以下の文字起こしデータを、動画の字幕として表示するのに適した単位に分割してください。

## 入力データ

### 1. 単語単位データ（タイムスタンプ用）
クリップ範囲: {clipStartSeconds}秒 〜 {clipEndSeconds}秒
```json
[
  {"text": "今", "startTimeSeconds": 0.04, "endTimeSeconds": 0.12},
  {"text": "まで", "startTimeSeconds": 0.12, "endTimeSeconds": 0.28},
  ...
]
```

### 2. 校正済みテキスト（文字参照用）
```
今までのところ、実際に成果を行って出せてるっていうのは...
```

## 出力形式
```json
{
  "segments": [
    {
      "text": "今までのところ実際に",
      "startTimeSeconds": 0.04,
      "endTimeSeconds": 1.5
    },
    {
      "text": "成果を出せてるっていうのは",
      "startTimeSeconds": 1.5,
      "endTimeSeconds": 3.2
    }
  ]
}
```

## ルール
- 1セグメントは15〜25文字程度
- テキストは「校正済みテキスト」を参考に（漢字変換が正しい）
- タイムスタンプは「単語単位データ」から計算
- 文の途中で切る場合は、意味の区切りで
```

---

## フロントエンド設計

### 新規ページ

**`/clips/[id]/page.tsx`** - クリップ詳細ページ

```
┌─────────────────────────────────────────────────┐
│ ← クリップ一覧へ                                 │
├─────────────────────────────────────────────────┤
│ [クリップタイトル]                    [ステータス] │
│ 元動画: [動画タイトル]                           │
│ 時間: 00:30 - 01:15 (45秒)                      │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │                                             │ │
│ │           [動画プレイヤー]                   │ │
│ │                                             │ │
│ └─────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│ ■ 字幕                                          │
│ ┌─────────────────────────────────────────────┐ │
│ │ 字幕セグメント編集UI                         │ │
│ │ [00:00-00:02] これは字幕テキストです          │ │
│ │ [00:02-00:05] 次の字幕テキスト               │ │
│ │ ...                                         │ │
│ └─────────────────────────────────────────────┘ │
│ [字幕を生成] [確定] [動画を合成] [Driveにアップ]  │
├─────────────────────────────────────────────────┤
│ ■ 合成動画                                      │
│ [プレビュー] [Google Driveで開く]                │
└─────────────────────────────────────────────────┘
```

### 新規コンポーネント

| コンポーネント | 説明 |
|---------------|------|
| `ClipDetailClient` | クリップ詳細のクライアントコンポーネント |
| `SubtitleEditor` | 字幕セグメントの編集UI |
| `SubtitleSegmentRow` | 個別セグメントの編集行 |
| `ClipVideoPlayer` | クリップ動画のプレイヤー（GCS署名付きURL使用） |
| `SubtitleCompositionStatus` | 合成処理のステータス表示 |

---

## バックエンド実装構成（DDD）

### Domain層

```
contexts/clip-video/domain/
├── models/
│   └── clip-subtitle.ts           # ClipSubtitleエンティティ
├── services/
│   └── subtitle-segmentation-prompt.service.ts  # LLMプロンプト生成・解析
└── gateways/
    ├── clip-subtitle-repository.gateway.ts
    └── subtitle-composer.gateway.ts  # 字幕合成のインターフェース
```

### Application層

```
contexts/clip-video/application/
├── usecases/
│   ├── generate-clip-subtitles.usecase.ts
│   ├── get-clip-subtitles.usecase.ts
│   ├── update-clip-subtitles.usecase.ts
│   ├── confirm-clip-subtitles.usecase.ts
│   ├── compose-subtitled-clip.usecase.ts
│   └── upload-subtitled-clip-to-drive.usecase.ts
└── errors/
    └── clip-subtitle.errors.ts
```

### Infrastructure層

```
contexts/clip-video/infrastructure/
└── repositories/
    └── clip-subtitle.repository.ts
```

### Shared Infrastructure（既存を活用 + 移動）

```
contexts/shared/infrastructure/clients/
├── ffmpeg.client.ts                        # 既存: 動画切り出し
├── ffmpeg-subtitle-generator.client.ts     # shorts-gen から移動: 字幕PNG生成
├── google-drive.client.ts                  # 既存: Driveアップロード
└── gcs.client.ts                           # 既存: GCSアクセス

contexts/shared/domain/gateways/
└── subtitle-generator.gateway.ts           # shorts-gen から移動: Gateway定義

contexts/clip-video/infrastructure/clients/
└── clip-subtitle-compose.client.ts         # 新規: クリップ用字幕合成
```

### Presentation層

```
contexts/clip-video/presentation/routes/
└── clip-subtitles.ts              # 字幕関連エンドポイント
```

---

## 並列実装計画

2フェーズ構成で、Phase 2 は5並列で実装可能。

### Phase 1: 共通インターフェース定義（先行作業） ✅ 完了

**目的**: 並列実装のための契約を先に定める

| 作成物 | 内容 | ステータス |
|--------|------|---------|
| **Prisma スキーマ** | `ClipSubtitle` モデル、`Clip` への列追加 | ✅ 完了 |
| **共有型定義** | `ClipSubtitleSegment`, `ClipSubtitle`, API Request/Response 型 | ✅ 完了 |
| **Gateway インターフェース** | `ClipSubtitleRepositoryGateway`, `ClipSubtitleComposerGateway` | ✅ 完了 |
| **ドメインモデル** | `ClipSubtitle` ドメインモデル（バリデーション含む） | ✅ 完了 |

これらが定まれば、Frontend / Backend / Vercel Backend は独立して実装可能。

#### Phase 1 で作成・変更したファイル

**新規作成:**
- `apps/shared/types/clip-subtitle.ts` - 共有型定義
- `apps/backend/src/contexts/clip-video/domain/models/clip-subtitle.ts` - ドメインモデル
- `apps/backend/src/contexts/clip-video/domain/gateways/clip-subtitle-repository.gateway.ts` - Repository Gateway
- `apps/backend/src/contexts/clip-video/domain/gateways/clip-subtitle-composer.gateway.ts` - Composer Gateway

**変更:**
- `apps/backend/src/contexts/shared/infrastructure/database/prisma/schema.prisma` - スキーマ追加
- `apps/shared/types/api.ts` - API型追加
- `apps/shared/types/clip.ts` - Clip型に新フィールド追加
- `apps/shared/types/index.ts` - エクスポート追加
- `apps/backend/src/contexts/clip-video/domain/models/clip.ts` - 新フィールド追加
- `apps/backend/src/contexts/clip-video/infrastructure/repositories/clip.repository.ts` - 新フィールド対応
- `apps/backend/src/contexts/clip-video/application/usecases/get-video.usecase.ts` - 新フィールド対応
- `test/contexts/clip-video/**` - テストファイルの修正

---

### Phase 2: 並列実装（5並列）

```
┌─────────────────────────────────────────────────────────────────┐
│                     Phase 1 完了後                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Worker A   │  │   Worker B   │  │   Worker C   │          │
│  │   Backend    │  │   Backend    │  │ Vercel BFF   │          │
│  │   字幕CRUD   │  │  動画合成    │  │   API Routes │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐                            │
│  │   Worker D   │  │   Worker E   │                            │
│  │  Frontend    │  │  Frontend    │                            │
│  │ 詳細ページ   │  │ 字幕編集UI   │                            │
│  └──────────────┘  └──────────────┘                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

#### Worker A: Backend - 字幕CRUD

**スコープ**: 字幕データの生成・取得・更新・確定

| 実装内容 |
|---------|
| `ClipSubtitle` ドメインモデル |
| `ClipSubtitleRepository` |
| `SubtitleSegmentationPromptService`（LLM連携） |
| `GenerateClipSubtitlesUseCase` |
| `GetClipSubtitlesUseCase` |
| `UpdateClipSubtitlesUseCase` |
| `ConfirmClipSubtitlesUseCase` |
| API Routes: `/api/clips/:clipId/subtitles/*` |
| ユニットテスト |

---

#### Worker B: Backend - 動画合成 & Driveアップロード

**スコープ**: 字幕付き動画の生成とDriveへのアップロード

| 実装内容 |
|---------|
| `FFmpegSubtitleGeneratorClient` を shared へ移動 |
| `SubtitleGeneratorGateway` を shared へ移動 |
| `ClipSubtitleComposeClient`（新規） |
| `ComposeSubtitledClipUseCase` |
| `UploadSubtitledClipToDriveUseCase` |
| API Routes: `/api/clips/:clipId/compose`, `/api/clips/:clipId/upload-to-drive` |
| 統合テスト（FFmpeg） |

---

#### Worker C: Vercel BFF - API Routes

**スコープ**: バックエンドへのプロキシ層

| 実装内容 |
|---------|
| `POST /api/clip-video/clips/[clipId]/subtitles/generate` |
| `GET /api/clip-video/clips/[clipId]/subtitles` |
| `PUT /api/clip-video/clips/[clipId]/subtitles` |
| `POST /api/clip-video/clips/[clipId]/subtitles/confirm` |
| `POST /api/clip-video/clips/[clipId]/compose` |
| `POST /api/clip-video/clips/[clipId]/upload-to-drive` |
| maxDuration 設定（compose: 300秒, upload: 180秒） |

---

#### Worker D: Frontend - クリップ詳細ページ

**スコープ**: パーマリンク + 動画プレイヤー + 全体レイアウト

| 実装内容 |
|---------|
| `/clips/[id]/page.tsx`（SSR） |
| `/clips/[id]/clip-detail-client.tsx` |
| `ClipVideoPlayer` コンポーネント（GCS署名付きURL使用） |
| `loadClipDetail` ローダー |
| `backend-client.ts` にメソッド追加 |
| クリップ一覧からのリンク追加 |

**動画プレイヤーの実装方針**: 後述の「動画プレイヤー設計」セクション参照

---

#### Worker E: Frontend - 字幕編集UI

**スコープ**: 字幕の表示・編集・アクション

| 実装内容 |
|---------|
| `SubtitleEditor` コンポーネント |
| `SubtitleSegmentRow` コンポーネント |
| `SubtitleCompositionStatus` コンポーネント |
| Server Actions（generate, update, confirm, compose, upload） |
| 字幕とプレイヤーの連動（現在再生位置のハイライト等） |

---

### Phase 3: 統合 & テスト

Phase 2 の全 Worker 完了後、統合して E2E テストを実施。

---

## Phase 1: 共通インターフェース定義（詳細）

Phase 2 の並列実装を可能にするため、以下を先に定義する。

### 1. Prisma スキーマ

```prisma
model ClipSubtitle {
  id        String   @id @default(uuid())
  clipId    String   @unique @map("clip_id")
  segments  Json     // ClipSubtitleSegment[]
  status    String   @default("draft")  // draft | confirmed
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  clip Clip @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@map("clip_subtitles")
}

// Clip モデルに追加
model Clip {
  // ... 既存 ...
  subtitledVideoGcsUri   String? @map("subtitled_video_gcs_uri")
  subtitledVideoUrl      String? @map("subtitled_video_url")
  subtitledVideoDriveId  String? @map("subtitled_video_drive_id")
  subtitledVideoDriveUrl String? @map("subtitled_video_drive_url")

  subtitle ClipSubtitle?
}
```

### 2. 共有型定義（apps/shared/types/）

```typescript
// clip-subtitle.ts
export interface ClipSubtitleSegment {
  index: number;
  text: string;
  startTimeSeconds: number;
  endTimeSeconds: number;
}

export interface ClipSubtitle {
  id: string;
  clipId: string;
  segments: ClipSubtitleSegment[];
  status: 'draft' | 'confirmed';
  createdAt: Date;
  updatedAt: Date;
}

// api.ts に追加
export interface GenerateClipSubtitlesResponse {
  clipId: string;
  subtitle: ClipSubtitle;
}

export interface GetClipSubtitleResponse {
  subtitle: ClipSubtitle | null;
}

export interface UpdateClipSubtitleRequest {
  segments: ClipSubtitleSegment[];
}

export interface ComposeSubtitledClipResponse {
  clipId: string;
  subtitledVideoUrl: string;
}

export interface UploadSubtitledClipResponse {
  clipId: string;
  driveFileId: string;
  driveUrl: string;
}
```

### 3. Gateway インターフェース

```typescript
// ClipSubtitleRepositoryGateway
interface ClipSubtitleRepositoryGateway {
  save(subtitle: ClipSubtitle): Promise<void>;
  findByClipId(clipId: string): Promise<ClipSubtitle | null>;
  delete(clipId: string): Promise<void>;
}

// ClipSubtitleComposerGateway
interface ClipSubtitleComposerGateway {
  compose(params: {
    inputVideoPath: string;
    segments: ClipSubtitleSegment[];
    outputPath: string;
    width: number;
    height: number;
    style?: SubtitleStyle;
  }): Promise<Result<{ durationSeconds: number }, ComposeError>>;
}
```

---

## FFmpeg 字幕合成の実装方針

**既存の shorts-gen モジュールを再利用する**

### 採用理由

1. **実績と安定性**: shorts-gen で実運用されており、テスト済み
2. **日本語フォント対応**: Noto Sans CJK JP で動作確認済み
3. **コードの再利用**: 新規実装のリスクを回避

### 再利用するモジュール

| モジュール | 場所 | 用途 |
|-----------|------|------|
| `FFmpegSubtitleGeneratorClient` | `shared/infrastructure/clients/` | 字幕PNG画像生成 |
| `SubtitleGeneratorGateway` | shorts-gen から shared へ移動 | Gateway インターフェース |

### 処理フロー

```
1. 字幕セグメントごとにPNG画像を生成
   └─ FFmpegSubtitleGeneratorClient.generate()

2. 生成した画像をGCSにアップロード
   └─ GcsClient.upload()

3. 元クリップ動画に字幕画像をoverlayで合成
   └─ FFmpegComposeClient の overlay 処理を参考に実装

4. 合成動画をGCSにアップロード
```

### 実装上の注意

- shorts-gen の `FFmpegComposeClient` はシーンベース設計のため、clip-video 用に簡略化した `ClipSubtitleComposeClient` を新規作成
- 字幕画像の生成・overlay 処理は既存ロジックをそのまま活用
- クリップ動画は既に存在するため、背景生成は不要（入力動画をそのまま使用）

---

## 動画プレイヤー設計

クリップ詳細ページで動画を再生可能にする。

### 現状の課題

| 保存先 | 直接再生 | 問題点 |
|--------|---------|--------|
| Google Drive | ❌ | `/view` URLはブラウザ再生不可 |
| GCS（署名付きURL） | ✅ | `<video src={signedUrl}>` で再生可能 |

クリップ動画は **Google Drive** に保存されているため、再生には一工夫が必要。

### 解決策: GCS経由で署名付きURL発行

```
[クリップ詳細ページ表示]
    ↓
[GET /api/clips/:clipId/video-url]
    ↓
[GetClipVideoUrlUseCase]
    ├─ クリップの googleDriveFileId を取得
    ├─ Google Drive から動画をダウンロード（ストリーム）
    ├─ GCS に一時保存（有効期限付き）
    └─ 署名付きURL を返却（60分有効）
    ↓
[フロントエンド: <video src={signedUrl}>]
```

### キャッシュ戦略

- GCS に一時保存した動画は `clipVideoGcsUri` としてDBに保存
- 有効期限（`clipVideoGcsExpiresAt`）を記録
- 再度アクセス時、期限内ならGCSから直接署名付きURL発行（Drive再ダウンロード不要）

### API追加

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/clips/:clipId/video-url` | 再生用署名付きURLを取得 |

### Prisma スキーマ追加（Clipモデル）

```prisma
model Clip {
  // ... 既存 + 字幕関連 ...

  // 動画プレイヤー用キャッシュ
  clipVideoGcsUri       String?   @map("clip_video_gcs_uri")
  clipVideoGcsExpiresAt DateTime? @map("clip_video_gcs_expires_at")
}
```

### 共有型定義追加

```typescript
// api.ts に追加
export interface GetClipVideoUrlResponse {
  videoUrl: string;        // 署名付きURL
  expiresAt: Date;         // URL有効期限
  durationSeconds: number; // 動画長さ
}
```

### Worker 追加作業

**Worker A（Backend 字幕CRUD）に追加:**
- `GetClipVideoUrlUseCase`
- API Route: `GET /api/clips/:clipId/video-url`

**Worker C（Vercel BFF）に追加:**
- `GET /api/clip-video/clips/[clipId]/video-url`

**Worker D（Frontend 詳細ページ）:**
- `ClipVideoPlayer` で署名付きURLを使用

### フロントエンド実装

```typescript
// ClipVideoPlayer コンポーネント（概要）
function ClipVideoPlayer({ clipId }: { clipId: string }) {
  const [videoUrl, setVideoUrl] = useState<string | null>(null);

  useEffect(() => {
    // 署名付きURL取得
    getClipVideoUrl(clipId).then(res => setVideoUrl(res.videoUrl));
  }, [clipId]);

  if (!videoUrl) return <Skeleton />;

  return (
    <video src={videoUrl} controls className="w-full">
      <track kind="captions" />
    </video>
  );
}
```

---

## 注意事項

### セキュリティ
- 字幕テキストの入力値検証（XSS対策、FFmpegインジェクション対策）
- GCS署名付きURLの有効期限管理

### パフォーマンス
- 動画合成は時間がかかるため、Vercel Functions の maxDuration を 300秒に設定
- 必要に応じて非同期ジョブ化を検討

### 既存機能との整合性
- クリップ一覧（`/clips`）からパーマリンクへのリンク追加
- 動画詳細ページのクリップ一覧からもリンク追加

---

## ファイル一覧（作成・変更対象）

### 新規作成

**Backend:**
- `apps/backend/src/contexts/clip-video/domain/models/clip-subtitle.ts`
- `apps/backend/src/contexts/clip-video/domain/services/subtitle-segmentation-prompt.service.ts`
- `apps/backend/src/contexts/clip-video/domain/gateways/clip-subtitle-repository.gateway.ts`
- `apps/backend/src/contexts/clip-video/domain/gateways/subtitle-composer.gateway.ts`
- `apps/backend/src/contexts/clip-video/infrastructure/repositories/clip-subtitle.repository.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/generate-clip-subtitles.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/get-clip-subtitles.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/update-clip-subtitles.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/confirm-clip-subtitles.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/compose-subtitled-clip.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/upload-subtitled-clip-to-drive.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/usecases/get-clip-video-url.usecase.ts`
- `apps/backend/src/contexts/clip-video/application/errors/clip-subtitle.errors.ts`
- `apps/backend/src/contexts/clip-video/presentation/routes/clip-subtitles.ts`
- `apps/backend/src/contexts/clip-video/infrastructure/clients/clip-subtitle-compose.client.ts`

**Shared:**
- `apps/shared/types/clip-subtitle.ts`

**Frontend:**
- `apps/webapp/src/app/clips/[id]/page.tsx`
- `apps/webapp/src/app/clips/[id]/clip-detail-client.tsx`
- `apps/webapp/src/app/api/clip-video/clips/[clipId]/subtitles/generate/route.ts`
- `apps/webapp/src/app/api/clip-video/clips/[clipId]/subtitles/route.ts`
- `apps/webapp/src/app/api/clip-video/clips/[clipId]/compose/route.ts`
- `apps/webapp/src/app/api/clip-video/clips/[clipId]/upload-to-drive/route.ts`
- `apps/webapp/src/app/api/clip-video/clips/[clipId]/video-url/route.ts`
- `apps/webapp/src/components/features/clip-detail/subtitle-editor.tsx`
- `apps/webapp/src/components/features/clip-detail/subtitle-segment-row.tsx`
- `apps/webapp/src/components/features/clip-detail/clip-video-player.tsx`
- `apps/webapp/src/server/presentation/clip-video/actions/generateClipSubtitles.ts`
- `apps/webapp/src/server/presentation/clip-video/actions/updateClipSubtitles.ts`
- `apps/webapp/src/server/presentation/clip-video/actions/confirmClipSubtitles.ts`
- `apps/webapp/src/server/presentation/clip-video/actions/composeSubtitledClip.ts`
- `apps/webapp/src/server/presentation/clip-video/actions/uploadSubtitledClipToDrive.ts`
- `apps/webapp/src/server/presentation/clip-video/actions/getClipVideoUrl.ts`
- `apps/webapp/src/server/presentation/clip-video/loaders/loadClipDetail.ts`

### 移動（shorts-gen → shared）

- `apps/backend/src/contexts/shorts-gen/infrastructure/clients/ffmpeg-subtitle-generator.client.ts` → `apps/backend/src/contexts/shared/infrastructure/clients/ffmpeg-subtitle-generator.client.ts`
- `apps/backend/src/contexts/shorts-gen/domain/gateways/subtitle-generator.gateway.ts` → `apps/backend/src/contexts/shared/domain/gateways/subtitle-generator.gateway.ts`

### 変更

- `apps/backend/src/contexts/shared/infrastructure/database/prisma/schema.prisma`
- `apps/backend/src/contexts/clip-video/domain/models/clip.ts`
- `apps/backend/src/contexts/clip-video/infrastructure/repositories/clip.repository.ts`
- `apps/backend/src/contexts/clip-video/presentation/routes/index.ts`
- `apps/shared/types/api.ts`
- `apps/shared/types/clip.ts`
- `apps/shared/types/index.ts`
- `apps/webapp/src/components/features/clip-list/clip-card.tsx`
- `apps/webapp/src/components/features/clip-list/clip-list-table.tsx`
- `apps/webapp/src/server/infrastructure/clients/backend-client.ts`

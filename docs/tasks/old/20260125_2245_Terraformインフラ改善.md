# Terraform インフラ改善設計

## 目的

インフラ管理者がセキュリティリスクや運用上の問題を抱えた状態を解消するため。

## 対応方針

以下の基準で修正対象を分類:
- **対応する**: トレードオフがなく、明確に改善となるもの
- **対応しない**: トレードオフがあり、判断が必要なもの

---

## 対応する修正（トレードオフなし）

### 1. マイグレーショントリガーの修正

**問題**: `null_resource.run_migration` のトリガーが `container_image` を参照しているが、マイグレーションジョブは `migration_image` を使用している。

**現状** (`modules/cloud-run/main.tf:225-227`):
```terraform
triggers = {
  image = var.container_image  # ← 間違い
}
```

**修正後**:
```terraform
triggers = {
  migration_image = var.migration_image
}
```

**理由**: 単純なバグ。意図と実装が一致していない。

---

### 2. DBパスワードのSecret Manager化

**問題**: DATABASE_URL に平文パスワードが含まれ、Cloud Run の環境変数として露出している。

**現状** (`modules/cloud-run/main.tf:66-69`):
```terraform
env {
  name  = "DATABASE_URL"
  value = "postgresql://${var.database_user}:${var.database_password}@localhost/..."
}
```

**修正方針**:

1. secrets モジュールに `database_password` シークレットを追加
2. Cloud Run で `DATABASE_PASSWORD` を Secret Manager から取得
3. アプリケーション側で DATABASE_URL を組み立てる

**修正箇所**:

#### secrets モジュール
- `database_password` シークレットを作成
- Cloud Run SA に secretAccessor 権限を付与

#### cloud-run モジュール
- `DATABASE_URL` を分解し、パスワード以外の部分のみ環境変数に
- `DATABASE_PASSWORD` を Secret Manager 参照に変更

#### バックエンドアプリケーション
- 環境変数から DATABASE_URL を組み立てるロジックを追加

---

### 3. VPC エグレス設定の最適化

**問題**: `egress = "ALL_TRAFFIC"` はすべての外部通信を VPC 経由にするため、外部 API への通信が遅延する。

**現状** (`modules/cloud-run/main.tf:45`):
```terraform
vpc_access {
  connector = var.vpc_connector_id
  egress    = "ALL_TRAFFIC"
}
```

**修正後**:
```terraform
vpc_access {
  connector = var.vpc_connector_id
  egress    = "PRIVATE_RANGES_ONLY"
}
```

**理由**:
- Cloud SQL はプライベート IP を使用しており、`PRIVATE_RANGES_ONLY` で十分
- OpenAI API、Google Drive API への通信は直接インターネット経由の方が高速
- Cloud NAT は引き続き利用可能

---

### 4. ステージング環境のリソース最適化

**問題**: ステージング環境のリソースが本番並みに設定されている。

**現状** (`envs/stg/main.tf:91-95`):
```terraform
cpu             = "1"
memory          = "1Gi"
min_instances   = 0
max_instances   = 2
```

**修正後**:
```terraform
cpu             = "0.5"
memory          = "512Mi"
min_instances   = 0
max_instances   = 1
```

**理由**: ステージング環境では負荷が低いため、コスト削減が可能。

---

### 5. ハードコードされた環境名の変数化

**問題**: `env = "stg"` がハードコードされている。

**現状** (`envs/stg/main.tf:51`):
```terraform
module "networking" {
  ...
  env = "stg"  # ハードコード
}
```

**修正後**:
- `variables.tf` に `env` 変数を追加（default = "stg"）
- `var.env` を参照するように変更

---

### 6. deploy.sh の prod 環境での auto-approve 無効化

**問題**: 本番環境でも `-auto-approve` が適用される。

**現状** (`deploy.sh:73-76`):
```bash
apply)
  terraform init -upgrade ${BACKEND_CONFIG}
  terraform apply -auto-approve
  ;;
```

**修正後**:
```bash
apply)
  terraform init -upgrade ${BACKEND_CONFIG}
  if [[ "${ENV}" == "prod" ]]; then
    terraform apply
  else
    terraform apply -auto-approve
  fi
  ;;
```

---

### 7. マイグレーションジョブの VPC エグレス設定

**問題**: マイグレーションジョブも `ALL_TRAFFIC` になっている。

**現状** (`modules/cloud-run/main.tf:180`):
```terraform
egress = "ALL_TRAFFIC"
```

**修正後**:
```terraform
egress = "PRIVATE_RANGES_ONLY"
```

**理由**: マイグレーションジョブは DB 接続のみで、外部 API は不要。

---

## 対応しない修正（トレードオフあり）

### A. allow_unauthenticated = true

**トレードオフ**: 認証を入れるとフロントエンドからのアクセスに認証トークンが必要になる。現状は API Gateway や Firebase Auth が未導入のため、対応すると追加実装が必要。

### B. CORS origin の制限

**トレードオフ**: 開発中は `*` の方が便利。本番環境作成時に適切なオリジンを設定すべき。

### C. Secret のバージョン固定

**トレードオフ**: `version = "latest"` は運用が楽だが、誤った更新が即座に影響する。本番環境では固定すべきだが、ステージングでは柔軟性を優先。

### D. バックアップ有効化（ステージング）

**トレードオフ**: コストがかかる。ステージングのデータは再作成可能なら無効でも問題ない。

### E. 削除保護有効化（ステージング）

**トレードオフ**: テストで環境を作り直す際に不便。本番では必須だが、ステージングでは判断が分かれる。

---

## 修正対象ファイル一覧

| ファイル | 修正内容 |
|---------|---------|
| `modules/cloud-run/main.tf` | マイグレーショントリガー、VPC エグレス、DB パスワード Secret 化 |
| `modules/cloud-run/variables.tf` | database_password_secret_id 変数追加 |
| `modules/secrets/main.tf` | database_password シークレット追加 |
| `modules/secrets/variables.tf` | database_password 変数追加 |
| `modules/secrets/outputs.tf` | database_password_secret_id 出力追加 |
| `envs/stg/main.tf` | env 変数化、リソースサイズ変更、secrets へのパスワード渡し |
| `envs/stg/variables.tf` | env 変数追加 |
| `deploy.sh` | prod 環境での auto-approve 無効化 |
| `apps/backend/src/index.ts` または関連ファイル | DATABASE_URL 組み立てロジック |

---

## 実装順序

1. **マイグレーショントリガー修正** - 単純な修正、影響小
2. **VPC エグレス設定** - 設定変更のみ、パフォーマンス改善
3. **ハードコード環境名の変数化** - リファクタリング
4. **deploy.sh の修正** - スクリプト変更のみ
5. **ステージングリソース最適化** - コスト削減
6. **DB パスワード Secret Manager 化** - アプリ変更を伴うため最後

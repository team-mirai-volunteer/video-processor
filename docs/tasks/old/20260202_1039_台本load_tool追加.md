# 台本生成チャットにload_script tool追加

## 目的

**ユーザーが、セッションが切れた後でも既存の台本を読み込んで編集を続けられるようにするため**

現在、企画書生成チャットには`load_planning` toolがあり、セッションが切れても既存の企画書を読み込んで編集できる。しかし、台本生成チャットにはこの機能がないため、セッションが切れると台本の編集ができなくなる問題がある。

---

## 現状分析

### 企画書生成チャットのload_planning tool

**定義場所**: `apps/backend/src/contexts/shorts-gen/application/usecases/generate-planning.usecase.ts`

```typescript
const LOAD_PLANNING_TOOL: ToolDefinition = {
  name: 'load_planning',
  description: '現在保存されている企画書を読み込みます。既存の企画書を修正する場合は、必ずこのツールで現状を確認してから save_planning を呼んでください。',
  parameters: {
    type: 'object',
    properties: {},
    required: [],
  },
};
```

**処理フロー**:
1. `planningRepository.findByProjectId(projectId)` で企画書を取得
2. 存在する場合: `現在の企画書:\n\n${existingPlanning.content}` を返す
3. 存在しない場合: `企画書はまだ作成されていません。` を返す

### 台本生成チャットの現状

**定義場所**: `apps/backend/src/contexts/shorts-gen/application/usecases/generate-script.usecase.ts`

**現在のtools**:
- `save_script`: 台本（シーンの配列）をDBに保存

**問題点**:
- `load_script` toolがない
- セッションが切れると、AIは既存の台本を参照できない
- 修正依頼時に「現在の台本を確認して」と言っても対応できない

---

## 設計

### load_script tool定義

```typescript
const LOAD_SCRIPT_TOOL: ToolDefinition = {
  name: 'load_script',
  description: '現在保存されている台本（シーン一覧）を読み込みます。既存の台本を修正する場合は、必ずこのツールで現状を確認してから save_script を呼んでください。',
  parameters: {
    type: 'object',
    properties: {},
    required: [],
  },
};
```

### 処理フロー

1. `scriptRepository.findByProjectId(projectId)` で台本を取得
2. 台本が存在する場合:
   - `sceneRepository.findByScriptId(scriptId)` でシーン一覧を取得
   - シーン情報を整形して返す
3. 台本が存在しない場合:
   - `台本はまだ作成されていません。` を返す

### シーン情報の整形フォーマット

```
現在の台本:

## シーン1
- 概要: {summary}
- 映像タイプ: {visualType}
- ナレーション: {voiceText}
- 字幕: {subtitles.join(' / ')}
- 無音長さ: {silenceDurationMs}ms
- ストック動画: {stockVideoKey}
- 背景色: {solidColor}
- スタイルヒント: {imageStyleHint}

## シーン2
...
```

### システムプロンプトの修正

既存のシステムプロンプトに以下を追加:

```
5. **既存台本の修正時**
   - 既存の台本を修正する場合は、必ず load_script ツールで現状を確認してください
   - 現状を把握した上で、ユーザーの修正要望に応じた変更を行ってください
```

---

## 修正対象ファイル

| ファイル | 修正内容 |
|----------|----------|
| `apps/backend/src/contexts/shorts-gen/application/usecases/generate-script.usecase.ts` | load_script tool定義の追加、tool処理の実装 |

---

## 依存関係の確認

### 既存リポジトリメソッド

**ScriptRepository** (`script-repository.gateway.ts`):
- `findByProjectId(projectId)`: 既存メソッド、そのまま利用可能

**SceneRepository** (`scene-repository.gateway.ts`):
- `findByScriptId(scriptId)`: **既存メソッド、そのまま利用可能**
  - order順でソートされたシーン一覧を返す
  - 追加実装不要

---

## テスト方針

### ユニットテスト

`generate-script.usecase.test.ts` に以下のテストケースを追加:

1. **台本が存在する場合のload_script**
   - モックリポジトリから台本とシーンを返す
   - 整形されたテキストがtoolResultとして返されることを確認

2. **台本が存在しない場合のload_script**
   - モックリポジトリからnullを返す
   - `台本はまだ作成されていません。` が返されることを確認

---

## 実装順序

1. `generate-script.usecase.ts`に`LOAD_SCRIPT_TOOL`定義を追加
2. toolsリストに`LOAD_SCRIPT_TOOL`を追加
3. `wrapStreamWithToolHandling`にload_script処理を追加
4. システムプロンプトに説明を追加
5. ユニットテストを追加

---

## アーキテクチャ整合性チェック

[docs/backend-architecture-guide.md](docs/backend-architecture-guide.md) との整合性を確認:

| チェック項目 | 結果 |
|-------------|------|
| Gatewayはドメインの言葉で定義されているか | N/A（既存Gateway使用） |
| ApplicationはInfrastructureに直接依存していないか | OK（Gateway経由で使用） |
| Context間の直接依存がないか | OK（shorts-gen内で完結） |
| sharedにビジネスロジックが含まれていないか | N/A |
| Domain層のエラーはResult型を使っているか | N/A（UseCase層の変更のみ） |

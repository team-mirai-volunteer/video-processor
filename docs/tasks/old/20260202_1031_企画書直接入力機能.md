# 企画書直接入力機能

## 目的

「ユーザーが、別のAIで作成した企画書を直接貼り付けてSaveできるようにするため」

現状は、企画書を作成するにはAIチャットとの対話が必須であり、外部で作成したMarkdownを直接入力して保存することができない。

## 現状分析

### フロントエンド

[planning-generation-step.tsx:140-144](apps/webapp/src/components/features/shorts-gen/planning/planning-generation-step.tsx#L140-L144)

```tsx
// 企画書がない場合のプレースホルダー
<div className="text-sm text-muted-foreground bg-muted/50 p-4 rounded-md h-full flex items-center justify-center">
  <p>チャットで企画書を生成してください</p>
</div>
```

- `hasPlanning === false` の場合、エディタは表示されずプレースホルダーのみ表示
- エディタを使うにはAIチャットで `save_planning` ツールを呼び出す必要がある

### バックエンドAPI

[planning.routes.ts:247-270](apps/backend/src/contexts/shorts-gen/presentation/routes/planning.routes.ts#L247-L270)

既存の `PATCH /:projectId/planning` は**既存の企画書がある場合のみ**更新可能。

```typescript
const planning = await planningRepository.findByProjectId(projectId);

if (!planning) {
  throw new NotFoundError('Planning', projectId);  // ← 企画書がないとエラー
}
```

### データフロー

```
現状:
1. チャット開始 → 2. AI応答 → 3. save_planning ツール呼び出し → 4. 企画書作成
                                    ↓
5. エディタ表示 → 6. 編集 → 7. PATCH API → 8. 企画書更新

要望:
1. 空エディタ表示 → 2. Markdown貼り付け → 3. Save → 4. 企画書作成（新規）
```

## 設計

### 1. バックエンド: 企画書直接作成APIの追加

`POST /api/shorts-gen/projects/:projectId/planning` エンドポイントを追加する。

**理由:**
- HTTPセマンティクスに従い、新規作成は `POST`、更新は `PATCH` を使う
- 既存の `PATCH` APIの挙動を変更すると、他の箇所への影響を考慮する必要があるため、新規エンドポイントを追加する方が安全

**エンドポイント仕様:**
- Method: `POST`
- Path: `/api/shorts-gen/projects/:projectId/planning`
- Request Body: `{ content: string }`
- Response: `201 Created` with `{ id, projectId, content, version, createdAt, updatedAt }`
- エラー: 既に企画書が存在する場合は `409 Conflict`

**追加ファイル:**
- [planning.routes.ts](apps/backend/src/contexts/shorts-gen/presentation/routes/planning.routes.ts) にルートを追加

### 2. フロントエンドAPIルート: 新規作成プロキシの追加

`POST /api/shorts-gen/projects/[projectId]/planning` を追加し、バックエンドにプロキシする。

**追加ファイル:**
- `apps/webapp/src/app/api/shorts-gen/projects/[projectId]/planning/route.ts`

### 3. フロントエンド: PlanningGenerationStep の修正

#### 3.1. 空エディタコンポーネントの追加

企画書がない場合に、空のBlockNoteエディタを表示する新コンポーネントを作成する。

**コンポーネント名:** `PlanningBlockEditorNew`

**機能:**
- 空の状態から編集可能なBlockNoteエディタを表示
- Saveボタンで新規作成APIを呼び出す
- 作成成功後、`onPlanningCreated` コールバックを呼び出す

**追加ファイル:**
- `apps/webapp/src/components/features/shorts-gen/planning/planning-block-editor-new.tsx`

#### 3.2. PlanningGenerationStep の修正

[planning-generation-step.tsx](apps/webapp/src/components/features/shorts-gen/planning/planning-generation-step.tsx)

**変更内容:**
- `hasPlanning === false` の場合、プレースホルダーではなく `PlanningBlockEditorNew` を表示
- 新規props `onPlanningCreated` を追加し、新規作成後のコールバックを受け取る
- 既存の `onPlanningGenerated` と同様の処理を行う

#### 3.3. project-detail-client.tsx の修正

[project-detail-client.tsx](apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx)

**変更内容:**
- 新規企画書作成用のハンドラ `handleCreatePlanning` を追加
- `PlanningGenerationStep` に新規propsを渡す

## 修正ファイル一覧

| ファイル | 修正内容 |
|----------|----------|
| `apps/backend/src/contexts/shorts-gen/presentation/routes/planning.routes.ts` | `POST /:projectId/planning` エンドポイント追加 |
| `apps/webapp/src/app/api/shorts-gen/projects/[projectId]/planning/route.ts` | 新規作成用プロキシルート追加（新規ファイル） |
| `apps/webapp/src/components/features/shorts-gen/planning/planning-block-editor-new.tsx` | 空エディタコンポーネント（新規ファイル） |
| `apps/webapp/src/components/features/shorts-gen/planning/planning-generation-step.tsx` | 空エディタ表示対応、props追加 |
| `apps/webapp/src/components/features/shorts-gen/planning/index.ts` | export追加 |
| `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx` | ハンドラ追加、props渡し |

## UI変更イメージ

### Before（企画書なしの状態）

```
┌─────────────────────────────────────────────────────────────────┐
│ 左ペイン                              │ 右ペイン（チャット）       │
│ ┌───────────────────────────────────┐ │                          │
│ │                                   │ │  チャットUI              │
│ │   チャットで企画書を生成して      │ │                          │
│ │   ください                        │ │                          │
│ │                                   │ │                          │
│ └───────────────────────────────────┘ │                          │
└─────────────────────────────────────────────────────────────────┘
```

### After（企画書なしの状態）

```
┌─────────────────────────────────────────────────────────────────┐
│ 左ペイン（空エディタ）                │ 右ペイン（チャット）       │
│ ┌───────────────────────────────────┐ │                          │
│ │                                   │ │  チャットUI              │
│ │   [BlockNote空エディタ]           │ │                          │
│ │   ここにMarkdownを貼り付け        │ │                          │
│ │                                   │ │                          │
│ ├───────────────────────────────────┤ │                          │
│ │ version 1         [Copy] [Save]  │ │                          │
│ └───────────────────────────────────┘ │                          │
└─────────────────────────────────────────────────────────────────┘
```

- ユーザーは左ペインに直接Markdownを貼り付けてSave可能
- もしくはチャットで対話して企画書を生成することも可能（従来通り）

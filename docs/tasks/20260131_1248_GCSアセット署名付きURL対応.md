# GCSアセット署名付きURL対応

## 目的

**フロントエンドが、GCSに保存されたアセット（音声・字幕画像）をブラウザで再生・表示できない状態を解消するため**

現状、音声・字幕アセットは`gs://...`形式のGCS URIとしてDBに保存されており、ブラウザから直接アクセスできない。

## 現状分析

### ストレージ方式の不整合

| アセット種別 | ストレージ | URL形式 | ブラウザアクセス |
|-------------|-----------|---------|----------------|
| 音声 (voice) | GCS (`GcsClient`) | `gs://bucket/path` | ❌ 不可 |
| 字幕画像 (subtitle_image) | GCS (`GcsClient`) | `gs://bucket/path` | ❌ 不可 |
| 背景画像 (background_image) | Google Drive (`GoogleDriveClient`) | `https://drive.google.com/...` | ✅ 可能 |

### 問題のあるコード箇所

1. **音声生成** - `apps/backend/src/contexts/shorts-gen/presentation/routes/voice.routes.ts`
   - `SynthesizeVoiceUseCase` が `GcsClient` を使用
   - 結果の `fileUrl` に `gs://...` URIが入る

2. **字幕生成** - `apps/backend/src/contexts/shorts-gen/presentation/routes/subtitle.routes.ts:41-44`
   ```typescript
   return {
     url: result.gcsUri,  // ← gcsUriをそのままurlとして返している
     gcsUri: result.gcsUri,
   };
   ```

### DBスキーマ

`ShortsSceneAsset.fileUrl` カラムに `gs://...` 形式で保存されている。

## 設計

### 方針

**GCS署名付きURL生成機能を追加し、フロントエンドへの返却時に変換する**

署名付きURLはGCS SDKの `getSignedUrl()` で生成でき、有効期限付きのHTTPSアクセス可能なURLになる。

### 実装箇所

#### 1. GcsClientに署名付きURL生成メソッドを追加

**ファイル**: `apps/backend/src/contexts/shared/infrastructure/clients/gcs.client.ts`

```typescript
// 追加するメソッドのインターフェース
interface TempStorageGateway {
  // 既存メソッド...

  /**
   * GCS URIから署名付きURLを生成する
   * @param gcsUri GCS URI (gs://bucket/path形式)
   * @param expiresInMinutes 有効期限（分）、デフォルト60分
   * @returns 署名付きHTTPS URL
   */
  getSignedUrl(gcsUri: string, expiresInMinutes?: number): Promise<string>;
}
```

#### 2. 各ルートでレスポンス返却時にURLを変換

以下のエンドポイントで、`gs://...` を署名付きURLに変換してから返す：

| エンドポイント | ファイル |
|---------------|---------|
| `GET /scripts/:scriptId/voice` | `voice.routes.ts` |
| `POST /scripts/:scriptId/voice` | `voice.routes.ts` |
| `POST /scenes/:sceneId/voice` | `voice.routes.ts` |
| `GET /scripts/:scriptId/subtitles` | `subtitle.routes.ts` |
| `POST /scripts/:scriptId/subtitles` | `subtitle.routes.ts` |
| `POST /scenes/:sceneId/subtitles` | `subtitle.routes.ts` |

#### 3. LocalTempStorageClientにも同様のメソッドを追加

ローカル開発用にファイルパスをそのまま返すか、ローカルファイルサーバー経由のURLを返す。

### アーキテクチャ図

```
[Frontend]
    ↓ API Request
[Backend Route]
    ↓ UseCase呼び出し
[UseCase] → [GcsClient.uploadFromStream()] → GCS
    ↓ gcsUri (gs://...)
[Backend Route]
    ↓ GcsClient.getSignedUrl(gcsUri)
[Response] → signedUrl (https://storage.googleapis.com/...)
    ↓
[Frontend] → <audio src={signedUrl}> ✅ 再生可能
```

### 署名付きURLの設定

- **有効期限**: 60分（デフォルト）
- **アクション**: `read` のみ
- **生成タイミング**: APIレスポンス返却時

### DBへの保存

DBには引き続き `gs://...` 形式で保存する（変更なし）。署名付きURLは有効期限があるため永続化には適さない。

## 対象ファイル一覧

### 新規追加

なし

### 修正

| ファイル | 変更内容 |
|---------|---------|
| `apps/backend/src/contexts/shared/domain/gateways/temp-storage.gateway.ts` | `getSignedUrl` メソッドをインターフェースに追加 |
| `apps/backend/src/contexts/shared/infrastructure/clients/gcs.client.ts` | `getSignedUrl` メソッドを実装 |
| `apps/backend/src/contexts/shared/infrastructure/clients/local-temp-storage.client.ts` | `getSignedUrl` メソッドを実装（ローカル用） |
| `apps/backend/src/contexts/shorts-gen/presentation/routes/voice.routes.ts` | レスポンスのURL変換処理を追加 |
| `apps/backend/src/contexts/shorts-gen/presentation/routes/subtitle.routes.ts` | レスポンスのURL変換処理を追加 |

## 実装順序

1. `TempStorageGateway` インターフェースに `getSignedUrl` を追加
2. `GcsClient` に `getSignedUrl` を実装
3. `LocalTempStorageClient` に `getSignedUrl` を実装
4. `voice.routes.ts` のレスポンス変換処理を追加
5. `subtitle.routes.ts` のレスポンス変換処理を追加
6. 動作確認

## 備考

- 背景画像（background_image）はGoogle Driveに保存されており、今回の対応対象外
- `AssetStorageGateway` は `TempStorageGateway` のラッパーとして実装されているため、`TempStorageGateway` を修正すれば字幕側も対応される

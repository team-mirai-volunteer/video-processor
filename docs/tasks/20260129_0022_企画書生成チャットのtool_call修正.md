# 企画書生成チャットのtool_call修正

## 目的

**開発者が**、企画書生成チャット機能でURLからコンテンツを取得する際に発生するエラー（`AI_APICallError: No tool call found for function call output with call_id`）を解消するため。

## 問題分析

### エラーの内容

```
AI_APICallError: No tool call found for function call output with call_id call_dVfBIwOhUdYYUkyhFnqyrsb6
```

### 原因

Vercel AI SDK v6では、tool呼び出し後のメッセージ履歴に以下の形式が必要：

1. **assistantメッセージ**: tool-call情報を`content`配列に含める
2. **toolメッセージ**: 対応するtoolCallIdを持つtool-result

現在の実装（[generate-planning.usecase.ts:281-285](apps/backend/src/contexts/shorts-gen/application/usecases/generate-planning.usecase.ts#L281-L285)）では：

```typescript
// 現在の実装（問題あり）
messages.push({
  role: 'assistant',
  content: accumulatedText,  // テキストのみ、tool-call情報がない
});
```

assistantメッセージにtool-call情報を含めていないため、SDKが「tool-resultに対応するtool-callが見つからない」と判定している。

### Vercel AI SDK v6の正しいメッセージ形式

[AI SDK ドキュメント](https://ai-sdk.dev/docs/reference/ai-sdk-core/model-message)によると：

```typescript
// assistantメッセージ（tool-callを含む場合）
{
  role: 'assistant',
  content: [
    { type: 'text', text: 'テキスト部分' },
    {
      type: 'tool-call',
      toolCallId: 'call_xxx',
      toolName: 'fetch_url',
      input: { url: 'https://...' }
    }
  ]
}

// toolメッセージ（tool-result）
{
  role: 'tool',
  content: [
    {
      type: 'tool-result',
      toolCallId: 'call_xxx',
      toolName: 'fetch_url',
      output: { type: 'text', value: '取得した内容' }  // または result フィールド
    }
  ]
}
```

## 修正箇所

### 1. ChatMessage型の拡張（[agentic-ai.gateway.ts](apps/backend/src/contexts/shorts-gen/domain/gateways/agentic-ai.gateway.ts)）

assistantメッセージがtool-call情報を保持できるように`toolCalls`フィールドを活用する（既に定義済み、21行目）。

### 2. convertMessagesの修正（[openai-agentic.client.ts:166-170](apps/backend/src/contexts/shorts-gen/infrastructure/clients/openai-agentic.client.ts#L166-L170)）

assistantメッセージのconvertロジックを修正し、`toolCalls`がある場合はcontent配列にtool-call情報を含める。

**変更前**:
```typescript
} else if (msg.role === 'assistant') {
  messages.push({
    role: 'assistant',
    content: msg.content,
  });
}
```

**変更後**:
```typescript
} else if (msg.role === 'assistant') {
  // tool-callがある場合はcontent配列形式で構築
  if (msg.toolCalls && msg.toolCalls.length > 0) {
    const contentParts: Array<{ type: string; [key: string]: unknown }> = [];

    // テキスト部分があれば追加
    if (msg.content) {
      contentParts.push({ type: 'text', text: msg.content });
    }

    // tool-call部分を追加
    for (const tc of msg.toolCalls) {
      contentParts.push({
        type: 'tool-call',
        toolCallId: tc.id,
        toolName: tc.name,
        input: tc.arguments,
      });
    }

    messages.push({
      role: 'assistant',
      content: contentParts,
    });
  } else {
    messages.push({
      role: 'assistant',
      content: msg.content,
    });
  }
}
```

### 3. executeStreamでのassistantメッセージ追加時にtool-call情報を含める（[generate-planning.usecase.ts:281-285](apps/backend/src/contexts/shorts-gen/application/usecases/generate-planning.usecase.ts#L281-L285)）

**変更前**:
```typescript
// アシスタントメッセージを履歴に追加
messages.push({
  role: 'assistant',
  content: accumulatedText,
});
```

**変更後**:
```typescript
// アシスタントメッセージを履歴に追加（tool-call情報を含める）
messages.push({
  role: 'assistant',
  content: accumulatedText,
  toolCalls: toolCalls,  // tool-call情報を含める
});
```

## 影響範囲

- [generate-planning.usecase.ts](apps/backend/src/contexts/shorts-gen/application/usecases/generate-planning.usecase.ts): executeStream内のメッセージ追加ロジック
- [openai-agentic.client.ts](apps/backend/src/contexts/shorts-gen/infrastructure/clients/openai-agentic.client.ts): convertMessages内のassistantメッセージ変換ロジック

同様のパターンを使用している他のusecase（generate-script, generate-image-prompts, generate-publish-text）も確認が必要。

## テスト方針

1. 企画書生成チャットでURLを含むメッセージを送信
2. `fetch_url` tool-callが正常に実行されることを確認
3. URLの内容を取得後、AIが企画書を生成できることを確認

## 参考資料

- [Vercel AI SDK ModelMessage](https://ai-sdk.dev/docs/reference/ai-sdk-core/model-message)
- [Vercel AI SDK Tool Calling](https://ai-sdk.dev/docs/ai-sdk-core/tools-and-tool-calling)

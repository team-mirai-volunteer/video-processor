# 画像プロンプト一括生成と画像一括生成ボタン追加

## 目的

**ユーザーがショート動画の画像素材を効率的に生成できるようにするため。**

現状、画像生成フロー（⑥プロンプト生成→⑦画像生成）では：
- プロンプト生成は各シーンで個別にボタンを押す必要がある
- 画像の「一括生成」ボタンは存在するが、プロンプトがないシーンはスキップされる

これにより、複数シーンがある場合に操作が煩雑になっている。

---

## 現状

### バックエンド

既に一括生成用のAPIエンドポイントが実装済み：

| エンドポイント | 説明 |
|---------------|------|
| `POST /api/shorts-gen/scripts/:scriptId/image-prompts` | プロンプト一括生成（全image_genシーン対象） |
| `POST /api/shorts-gen/scripts/:scriptId/images` | 画像一括生成（プロンプトがあるシーンのみ） |
| `POST /api/shorts-gen/scenes/:sceneId/image-prompt` | 個別プロンプト生成 |
| `POST /api/shorts-gen/scenes/:sceneId/image` | 個別画像生成 |

### フロントエンド

| 機能 | 個別生成 | 一括生成 |
|------|---------|---------|
| ⑥ プロンプト生成 | ✅ あり | ❌ **なし** |
| ⑦ 画像生成 | ✅ あり | ✅ あり |

画像カラムのUIは1つのカラムで⑥⑦を統合表示しており、現在は：
- 各シーン行で「プロンプト生成」→「画像生成」ボタンを個別に押す
- カラムヘッダーの「一括生成」ボタンは画像生成のみ実行

---

## 設計

### UIの変更

画像カラムのヘッダー部分に、2つのボタンを配置する：

```
┌─────────────────────────────────┐
│ ⑥⑦ 画像                        │
│ [プロンプト一括生成] [画像一括生成] │
│                                 │
│ Scene1: プロンプト ✓  画像 ✓    │
│ Scene2: プロンプト ○  画像 ○    │
│ ...                             │
└─────────────────────────────────┘
```

### ボタンの動作

| ボタン | 動作 | 有効条件 |
|-------|------|---------|
| **プロンプト一括生成** | 全image_genシーンのプロンプトを一括生成 | image_genシーンが1つ以上存在 |
| **画像一括生成** | プロンプトがあるシーンの画像を一括生成 | プロンプト生成済みシーンが1つ以上存在 |

### ボタン状態の詳細

#### プロンプト一括生成ボタン

| 状態 | 表示 |
|------|------|
| 未生成あり | `一括生成`（default variant） |
| 生成中 | `生成中...`（disabled、spinner） |
| 全て生成済み | `再生成`（outline variant） |

#### 画像一括生成ボタン

| 状態 | 表示 |
|------|------|
| プロンプトなし | disabled |
| 未生成あり | `一括生成`（default variant） |
| 生成中 | `生成中...`（disabled、spinner） |
| 全て生成済み | `再生成`（outline variant） |

---

## 実装箇所

### フロントエンド

#### 1. 型定義の追加

**ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/types.ts`

```typescript
// 既存の GenerateAllAssetsResponse を使用
// プロンプト一括生成用のレスポンス型を追加
export interface GenerateAllImagePromptsResponse {
  success: boolean;
  results: {
    sceneId: string;
    success: boolean;
    imagePrompt?: string;
    error?: string;
  }[];
}
```

#### 2. Propsの追加

**ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/asset-generation-step.tsx`

`AssetGenerationStepProps` に追加：
```typescript
onAllImagePromptsGenerate?: () => Promise<GenerateAllImagePromptsResponse>;
```

#### 3. Hookの拡張

**ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts`

追加する関数：
- `generateAllImagePrompts`: プロンプト一括生成を実行
- `isGeneratingImagePrompts`: プロンプト生成中フラグ

状態の追加：
```typescript
interface AssetGenerationState {
  // ... 既存
  isGeneratingImagePrompts: boolean;  // 追加
}
```

#### 4. UIコンポーネントの修正

**ファイル**: `apps/webapp/src/components/features/shorts-gen/asset-generation/asset-generation-step.tsx`

`AssetColumn` コンポーネントの画像カラム部分を修正：
- 画像カラムの場合は2つのボタンを表示
- プロンプト生成済みシーン数に応じて画像一括生成ボタンの有効/無効を制御

#### 5. ハンドラーの追加

**ファイル**: `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx`

追加する関数：
- `handleAllImagePromptsGenerate`: バックエンドAPIを呼び出してプロンプト一括生成

---

## 変更対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `apps/webapp/src/components/features/shorts-gen/asset-generation/types.ts` | `GenerateAllImagePromptsResponse` 型追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/use-asset-generation.ts` | `generateAllImagePrompts` 関数追加、状態追加 |
| `apps/webapp/src/components/features/shorts-gen/asset-generation/asset-generation-step.tsx` | Props追加、画像カラムUIを2ボタン構成に変更 |
| `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx` | `handleAllImagePromptsGenerate` ハンドラー追加 |

---

## バックエンドの変更

**変更不要**

既存の `POST /api/shorts-gen/scripts/:scriptId/image-prompts` エンドポイントをそのまま使用する。

---

## テスト

### 手動テスト項目

1. プロンプト一括生成
   - [ ] image_genシーンが複数ある状態で「プロンプト一括生成」を押す
   - [ ] 全シーンのプロンプトが生成される
   - [ ] 生成中はボタンがdisabledになりスピナーが表示される
   - [ ] 完了後、ボタンが「再生成」に変わる

2. 画像一括生成
   - [ ] プロンプトがない状態で「画像一括生成」がdisabledになっている
   - [ ] プロンプト生成後、「画像一括生成」が有効になる
   - [ ] 画像一括生成を実行すると、プロンプトがあるシーンのみ画像が生成される

3. エラーハンドリング
   - [ ] プロンプト生成でエラーが発生した場合、該当シーンにエラー表示される
   - [ ] 一部失敗しても他のシーンは正常に処理される

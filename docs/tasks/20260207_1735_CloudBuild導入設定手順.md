# Cloud Build 導入設定手順

## 目的

開発者がローカル環境でデプロイコマンドを実行しなくても、Git push をトリガーに自動でステージング環境にデプロイされるようにするため。

## 現状

- デプロイは `./deploy.sh stg full` をローカルで手動実行
- ローカルで `gcloud auth login` + `gcloud auth application-default login` の両方が必要
- GitHub Actions は CI（lint, typecheck, test）のみ

## Cloud Build を選択する理由

| 観点 | GitHub Actions | Cloud Build |
|------|---------------|-------------|
| GCP認証 | Workload Identity Federation 設定が必要 | 同一GCP内で自動認証 |
| Secret Manager連携 | 追加設定が必要 | ネイティブ対応 |
| ログ・監視 | GitHub + GCP に分散 | GCP に統一 |
| Artifact Registry | Docker認証設定が必要 | 自動認証 |

---

## 設定手順

### Step 1: Cloud Build API の有効化

`infrastructure/terraform/envs/stg/main.tf` の `google_project_service.apis` に追加:

```hcl
"cloudbuild.googleapis.com",
```

### Step 2: Cloud Build サービスアカウントへの権限付与

Cloud Build のデフォルトサービスアカウント（`{PROJECT_NUMBER}@cloudbuild.gserviceaccount.com`）に以下の権限を付与する。

**Terraform で管理する場合**（`infrastructure/terraform/envs/stg/main.tf` に追加）:

```hcl
# Cloud Build service account
data "google_project" "current" {}

locals {
  cloud_build_sa = "${data.google_project.current.number}@cloudbuild.gserviceaccount.com"
}

# Cloud Build に必要な IAM ロール
resource "google_project_iam_member" "cloudbuild_roles" {
  for_each = toset([
    "roles/run.admin",                    # Cloud Run デプロイ
    "roles/iam.serviceAccountUser",       # SA として実行
    "roles/secretmanager.secretAccessor", # Secret Manager 読み取り
    "roles/artifactregistry.writer",      # イメージ push
    "roles/cloudsql.client",              # Cloud SQL 接続（migration用）
  ])

  project = var.project_id
  role    = each.value
  member  = "serviceAccount:${local.cloud_build_sa}"
}

# Terraform state bucket へのアクセス
resource "google_storage_bucket_iam_member" "cloudbuild_tfstate" {
  bucket = "mirai-video-processor-tfstate"
  role   = "roles/storage.objectAdmin"
  member = "serviceAccount:${local.cloud_build_sa}"
}
```

### Step 3: cloudbuild.yaml の作成

プロジェクトルートに `cloudbuild.yaml` を作成:

```yaml
# cloudbuild.yaml
steps:
  # 1. Docker イメージのビルド（API）
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--platform=linux/amd64'
      - '-f=apps/backend/Dockerfile'
      - '-t=${_REGISTRY}/api:${SHORT_SHA}'
      - '-t=${_REGISTRY}/api:latest'
      - '--target=runner'
      - '.'
    id: 'build-api'

  # 2. Docker イメージのビルド（Migration）
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--platform=linux/amd64'
      - '-f=apps/backend/Dockerfile'
      - '-t=${_REGISTRY}/migration:${SHORT_SHA}'
      - '-t=${_REGISTRY}/migration:latest'
      - '--target=migrator'
      - '.'
    id: 'build-migration'

  # 3. Docker イメージの Push
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '--all-tags', '${_REGISTRY}/api']
    id: 'push-api'
    waitFor: ['build-api']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '--all-tags', '${_REGISTRY}/migration']
    id: 'push-migration'
    waitFor: ['build-migration']

  # 4. Terraform plan/apply
  - name: 'hashicorp/terraform:1.7'
    dir: 'infrastructure/terraform/envs/stg'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        # Generate tfvars
        cat > terraform.tfvars << 'TFVARS'
        project_id   = "${PROJECT_ID}"
        project_name = "video-processor-stg"
        region       = "asia-northeast1"
        database_password = "$$DATABASE_PASSWORD"
        openai_api_key = "$$OPENAI_API_KEY"
        google_credentials_json = <<-EOF
        $$GOOGLE_CREDENTIALS_JSON
        EOF
        webapp_api_key = "$$WEBAPP_API_KEY"
        gemini_api_key = "$$GEMINI_API_KEY"
        fish_audio_api_key = "$$FISH_AUDIO_API_KEY"
        fish_audio_default_voice_model_id = "${_FISH_AUDIO_DEFAULT_VOICE_MODEL_ID}"
        anthropic_api_key = "$$ANTHROPIC_API_KEY"
        container_image = "${_REGISTRY}/api:${SHORT_SHA}"
        migration_image = "${_REGISTRY}/migration:${SHORT_SHA}"
        cors_origin = "${_CORS_ORIGIN}"
        google_drive_output_folder_id = "${_GOOGLE_DRIVE_OUTPUT_FOLDER_ID}"
        transcript_output_folder_id = "${_TRANSCRIPT_OUTPUT_FOLDER_ID}"
        TFVARS

        terraform init -backend-config="prefix=stg"
        terraform apply -auto-approve
    id: 'terraform-apply'
    waitFor: ['push-api', 'push-migration']
    secretEnv:
      - 'DATABASE_PASSWORD'
      - 'OPENAI_API_KEY'
      - 'GOOGLE_CREDENTIALS_JSON'
      - 'WEBAPP_API_KEY'
      - 'GEMINI_API_KEY'
      - 'FISH_AUDIO_API_KEY'
      - 'ANTHROPIC_API_KEY'

  # 5. Database Migration 実行
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'jobs'
      - 'execute'
      - 'video-processor-stg-migration'
      - '--region=asia-northeast1'
      - '--wait'
    id: 'run-migration'
    waitFor: ['terraform-apply']

  # 6. Cloud Run サービス更新（新イメージ反映）
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'services'
      - 'update'
      - 'video-processor-stg-api'
      - '--region=asia-northeast1'
      - '--image=${_REGISTRY}/api:${SHORT_SHA}'
    id: 'update-service'
    waitFor: ['run-migration']

# Secret Manager からシークレットを取得
availableSecrets:
  secretManager:
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-database-password/versions/latest
      env: DATABASE_PASSWORD
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-openai-api-key/versions/latest
      env: OPENAI_API_KEY
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-google-credentials/versions/latest
      env: GOOGLE_CREDENTIALS_JSON
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-webapp-api-key/versions/latest
      env: WEBAPP_API_KEY
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-gemini-api-key/versions/latest
      env: GEMINI_API_KEY
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-fish-audio-api-key/versions/latest
      env: FISH_AUDIO_API_KEY
    - versionName: projects/${PROJECT_ID}/secrets/video-processor-stg-anthropic-api-key/versions/latest
      env: ANTHROPIC_API_KEY

# 変数（トリガー設定時に指定）
substitutions:
  _REGISTRY: asia-northeast1-docker.pkg.dev/${PROJECT_ID}/video-processor-stg
  _CORS_ORIGIN: 'https://your-webapp.vercel.app'
  _GOOGLE_DRIVE_OUTPUT_FOLDER_ID: ''
  _TRANSCRIPT_OUTPUT_FOLDER_ID: ''
  _FISH_AUDIO_DEFAULT_VOICE_MODEL_ID: ''

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1800s'  # 30分
```

### Step 4: GitHub リポジトリとの連携（トリガー設定）

GCP コンソールまたは gcloud CLI でトリガーを作成する。

**gcloud CLI での設定:**

```bash
# GitHub リポジトリを接続（初回のみ、コンソールで実施推奨）
# Cloud Build > トリガー > リポジトリを接続

# トリガー作成
gcloud builds triggers create github \
  --name="deploy-stg" \
  --repo-name="video-processor" \
  --repo-owner="team-mirai-volunteer" \
  --branch-pattern="^main$" \
  --build-config="cloudbuild.yaml" \
  --substitutions="_CORS_ORIGIN=https://your-webapp.vercel.app,_GOOGLE_DRIVE_OUTPUT_FOLDER_ID=xxx,_TRANSCRIPT_OUTPUT_FOLDER_ID=xxx,_FISH_AUDIO_DEFAULT_VOICE_MODEL_ID=xxx" \
  --region="asia-northeast1"
```

**GCP コンソールでの設定:**

1. Cloud Build > トリガー に移動
2. 「トリガーを作成」をクリック
3. 以下を設定:
   - 名前: `deploy-stg`
   - リージョン: `asia-northeast1`
   - イベント: ブランチに push
   - ソース: GitHub（リポジトリを接続）
   - ブランチ: `^main$`
   - 構成: Cloud Build 構成ファイル（`cloudbuild.yaml`）
   - 代入変数: substitutions の値を設定

### Step 5: 初回デプロイの実行

```bash
# Terraform で Cloud Build の IAM 設定を適用
cd infrastructure/terraform
./deploy.sh stg apply

# 手動でトリガーを実行してテスト
gcloud builds triggers run deploy-stg \
  --branch=main \
  --region=asia-northeast1
```

---

## 確認方法

### ビルド履歴の確認

```bash
# 最新のビルド状況
gcloud builds list --limit=5 --region=asia-northeast1

# 特定ビルドの詳細
gcloud builds describe BUILD_ID --region=asia-northeast1

# ログをストリーム表示
gcloud builds log BUILD_ID --stream --region=asia-northeast1
```

GCP コンソール: https://console.cloud.google.com/cloud-build/builds?project=mirai-video-processor

---

## ディレクトリ構成（変更後）

```
/
├── cloudbuild.yaml                    # 新規作成
├── infrastructure/terraform/
│   ├── envs/stg/
│   │   └── main.tf                    # Cloud Build IAM 追加
│   └── ...
└── ...
```

---

## 注意事項

- **main ブランチへの push でのみ発火**: develop ブランチでのテストは GitHub Actions で継続
- **Terraform の実行**: Cloud Build 内で Terraform を実行するため、state の競合に注意（ローカルでの `terraform apply` は避ける）
- **シークレットの追加**: 新しいシークレットを追加する場合は `availableSecrets` セクションにも追加が必要

# クリップ切り抜き終端延長対応

## 目的

ユーザーが動画クリップを切り抜いた際に、終端部分が少し切れてしまう問題を解消するため。

## 背景・課題

現在の切り抜き処理では、AIが提案した `endTimeSeconds` をそのまま使用してFFmpegで切り抜きを行っている。しかし、実際に切り抜かれた動画では終端が少し切れてしまうケースがある。

これは以下の要因が考えられる：
- FFmpegのキーフレーム処理による微小な誤差
- AIが提案するタイムスタンプがトランスクリプトの終了時刻を参照しており、発話の余韻が含まれていない

## 対応方針

切り抜き時に `endTimeSeconds` に 0.5秒 を追加して、終端に余裕を持たせる。

## 実装箇所

### 変更対象ファイル

`apps/backend/src/contexts/shared/infrastructure/clients/ffmpeg.client.ts`

### 変更内容

`extractClipFromFile` メソッド内で、duration計算時に0.5秒を追加する。

**変更前:**
```typescript
const duration = endTimeSeconds - startTimeSeconds;
```

**変更後:**
```typescript
const CLIP_END_PADDING_SECONDS = 0.5;
const duration = endTimeSeconds - startTimeSeconds + CLIP_END_PADDING_SECONDS;
```

### 設計判断

| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| **A. FFmpegClient内で調整（採用）** | 影響範囲が限定的。切り抜き処理全体に一律適用される | パディング値がインフラ層にハードコードされる |
| B. UseCase内で調整 | ビジネスロジックとして明示的 | UseCaseのコードが複雑化する |
| C. Clipモデル作成時に調整 | ドメインモデルで管理できる | 他の用途（表示用など）で本来の終了時刻が必要な場合に困る |

選択肢Aを採用する理由：
- 「FFmpegで切り抜く際に少し余裕を持たせる」という技術的な調整であり、ドメインロジックというよりはインフラの実装詳細として扱うのが適切
- Clipモデルには本来のタイムスタンプを保持し、実際の切り抜き時のみパディングを適用することで、データの整合性を保てる

## 動画終端を超えた場合の挙動

FFmpegの `-t`（duration）オプションは、指定した時間が動画の残り時間を超えた場合、動画の終端で自動的に処理を終了する。エラーにはならず、利用可能な範囲だけが出力される。

例：動画長が60秒、endTimeSecondsが59.8秒の場合
- パディング適用後: 59.8 + 0.5 = 60.3秒まで切り抜こうとする
- 実際の出力: 動画終端の60秒で切れる（エラーなし）

## 影響範囲

- `extractClipFromFile` を使用するすべての切り抜き処理に適用される
- 既存のクリップデータ（DBに保存済みの `endTimeSeconds`）には影響しない
- ショート動画生成機能（shorts-gen）は別のFFmpegメソッドを使用しているため影響なし

## テスト方針

- `ffmpeg.client.test.ts` のユニットテストで、パディングが適用されていることを確認する
- 実際の動画での動作確認（手動テスト）

# 意図しないスクロール挙動の削除

## 目的

ユーザーがshorts-gen機能を使用する際に、意図しないスクロールによるストレスを感じている状態を解消するため。

具体的には、以下のような問題が発生している:
- チャット画面でメッセージが追加されるたびに自動的に最下部へスクロールされる
- ステップ完了時に自動的に別のステップが展開/折り畳まれて画面位置がジャンプする

これらの強制的なスクロール挙動を削除し、ユーザーが自分の意図した位置で画面を見ることができる状態を実現する。

## 問題箇所の調査結果

### 1. chat-ui.tsx - チャットメッセージ自動スクロール

**ファイル**: `apps/webapp/src/components/features/shorts-gen/chat/chat-ui.tsx`

**該当箇所**: 69-76行目

```typescript
const scrollToBottom = useCallback(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
}, []);

// biome-ignore lint/correctness/useExhaustiveDependencies: scroll when messages change
useEffect(() => {
  scrollToBottom();
}, [messages.length, scrollToBottom]);
```

**問題点**:
- メッセージ配列の長さ(`messages.length`)が変わるたびに`scrollToBottom()`が実行される
- ユーザーが過去のメッセージを読んでいる最中でも強制的に最下部へスクロールされる
- チャットUIは企画書生成(E4)と台本生成(E5)で使用されている

**影響範囲**:
- `PlanningGenerationStep` (企画書生成)
- `ScriptGenerationStep` (台本生成)

### 2. project-detail-client.tsx - ステップ自動展開/折り畳み

**ファイル**: `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx`

**該当箇所1**: 176-181行目 (アセット生成完了時)

```typescript
const handleAssetsComplete = useCallback(() => {
  setIsAssetsComplete(true);
  updateStepStatus('assets', 'completed');
  updateStepStatus('compose', 'ready');
  // Expand compose step automatically
  setSteps((prev) => ({
    ...prev,
    compose: { ...prev.compose, isExpanded: true },
    assets: { ...prev.assets, isExpanded: false },
  }));
}, [updateStepStatus]);
```

**該当箇所2**: 239-244行目 (台本生成完了時)

```typescript
const handleScriptGenerated = useCallback(
  (newScript: Script, newScenes: Scene[]) => {
    setScript(newScript);
    setScenes(newScenes);
    updateStepStatus('script', 'completed');
    updateStepStatus('assets', 'ready');
    // Expand assets step automatically
    setSteps((prev) => ({
      ...prev,
      assets: { ...prev.assets, isExpanded: true },
      script: { ...prev.script, isExpanded: false },
    }));
  },
  [updateStepStatus]
);
```

**問題点**:
- ステップ完了時に自動的に次のステップを展開し、完了したステップを折り畳む
- ユーザーが完了したステップの内容を確認している最中でも、画面が勝手に移動する
- 特にステップコンテンツが大きい場合、予期しない画面ジャンプが発生する

**影響範囲**:
- 台本生成完了 → アセット生成ステップへの遷移
- アセット生成完了 → 動画合成ステップへの遷移

## 修正方針

### 1. chat-ui.tsx

**変更内容**:
- `scrollToBottom` コールバック関数を削除
- メッセージ変更時の自動スクロール `useEffect` を削除
- `messagesEndRef` は残す(将来的に手動スクロールボタンを追加する可能性があるため)

**削除対象**:
```typescript
const scrollToBottom = useCallback(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
}, []);

// biome-ignore lint/correctness/useExhaustiveDependencies: scroll when messages change
useEffect(() => {
  scrollToBottom();
}, [messages.length, scrollToBottom]);
```

### 2. project-detail-client.tsx

**変更内容**:
- `handleAssetsComplete` 内のステップ展開/折り畳み処理を削除
- `handleScriptGenerated` 内のステップ展開/折り畳み処理を削除
- ステータス更新のみを行い、表示状態(isExpanded)は変更しない

**修正前**:
```typescript
// handleAssetsComplete
setSteps((prev) => ({
  ...prev,
  compose: { ...prev.compose, isExpanded: true },
  assets: { ...prev.assets, isExpanded: false },
}));

// handleScriptGenerated
setSteps((prev) => ({
  ...prev,
  assets: { ...prev.assets, isExpanded: true },
  script: { ...prev.script, isExpanded: false },
}));
```

**修正後**:
上記のステップ展開/折り畳み処理を削除。ユーザーが手動でステップを開閉する仕様に変更。

## 実装時の注意点

1. **初期表示状態の保持**:
   - `getInitialSteps()` 関数で設定される初期の `isExpanded: true` はそのまま維持
   - ページ読み込み時の初期状態は変更しない

2. **手動操作の保持**:
   - `toggleStep()` 関数はそのまま維持
   - ユーザーが手動でステップを開閉する機能は残す

3. **ステータス管理との分離**:
   - ステップの状態(`status`: pending/ready/running/completed/error)の更新は継続
   - 表示状態(`isExpanded`)の自動変更のみを削除

## テスト観点

修正後、以下の動作を確認する必要がある:

1. **チャット機能**:
   - メッセージ送信時にスクロール位置が保持されること
   - ユーザーが上にスクロールした状態で新しいメッセージが来ても、スクロール位置が変わらないこと

2. **ステップ遷移**:
   - 台本生成完了時に、scriptステップが自動で閉じないこと
   - アセット生成完了時に、assetsステップが自動で閉じないこと
   - ステップのステータス(ready/completed)は正しく更新されること

3. **手動操作**:
   - ステップヘッダーをクリックして手動で開閉できること
   - 開閉状態がユーザーの操作通りに保持されること

## 影響範囲まとめ

- **修正ファイル数**: 2ファイル
  - `apps/webapp/src/components/features/shorts-gen/chat/chat-ui.tsx`
  - `apps/webapp/src/app/shorts-gen/[projectId]/project-detail-client.tsx`

- **影響する機能**:
  - E4: 企画書生成(ChatUI使用)
  - E5: 台本生成(ChatUI使用)
  - E6-E7: 素材生成完了時の遷移
  - E8: 動画合成ステップへの遷移

- **破壊的変更**: なし
  - 既存のステータス管理ロジックは維持
  - 手動開閉機能は維持
  - API通信やデータフローには影響なし

# clip-video 字幕合成進捗のDB保存設計

## 目的

**clip-video機能のユーザー**が、**字幕付き動画の合成処理中に進捗が分からず不安になる状態**を解消するため。

---

## 現状の課題

### 現在の実装
- `ComposeSubtitledClipUseCase`は同期処理（レスポンスを返すまでブロック）
- フロントエンドは`isComposing`フラグと経過時間のみを表示
- 「ページを離れないでください」という注意書きが必要な状態
- 処理の何%くらいが完了しているかが分からない

### ユーザー体験
- 長い動画では合成に1〜2分かかる
- 「合成中...」表示のまま経過時間だけが増えていく
- 正常に動作しているのか不安になる

---

## 設計

### 1. DBスキーマ変更

`Clip`テーブルに以下のカラムを追加する。

```prisma
model Clip {
  // 既存カラム
  id                   String    @id @default(uuid())
  videoId              String    @map("video_id")
  // ... 他の既存カラム

  // 追加カラム（字幕合成進捗用）
  composeStatus        String?   @map("compose_status")     // idle | processing | completed | failed
  composeProgressPhase String?   @map("compose_progress_phase")   // downloading | converting | composing | uploading
  composeProgressPercent Int?    @map("compose_progress_percent") // 0-100
  composeErrorMessage  String?   @map("compose_error_message")

  // relations...
}
```

### 2. 進捗フェーズ定義

| フェーズ | 説明 | パーセンテージ範囲 |
|---------|------|-------------------|
| `downloading` | GCSから元動画をダウンロード | 0-20% |
| `converting` | フォーマット変換（縦/横動画変換） | 20-40% |
| `composing` | FFmpegで字幕合成 | 40-80% |
| `uploading` | GCSへ合成動画をアップロード | 80-100% |

※ `converting`は`outputFormat`が`original`以外の場合のみ

### 3. 進捗計算ロジック

`ComposeSubtitledClipUseCase`の処理フローと進捗:

```
[0%]   処理開始、composeStatus = 'processing'
       --- downloading フェーズ ---
[10%]  GCSから動画ダウンロード中
[20%]  ダウンロード完了
       --- converting フェーズ（optional）---
[30%]  フォーマット変換中
[40%]  変換完了
       --- composing フェーズ ---
[50%]  字幕合成中
[80%]  合成完了
       --- uploading フェーズ ---
[90%]  GCSへアップロード中
[100%] 完了、composeStatus = 'completed'
```

### 4. バックエンド実装変更

#### 4.1 ドメインモデル変更

[clip.ts](../apps/backend/src/contexts/clip-video/domain/models/clip.ts)に進捗関連フィールドとメソッドを追加。

```typescript
type ComposeStatus = 'idle' | 'processing' | 'completed' | 'failed';
type ComposeProgressPhase = 'downloading' | 'converting' | 'composing' | 'uploading';

interface ClipProps {
  // 既存フィールド...

  // 追加フィールド
  composeStatus: ComposeStatus | null;
  composeProgressPhase: ComposeProgressPhase | null;
  composeProgressPercent: number | null;
  composeErrorMessage: string | null;
}
```

#### 4.2 Repository変更

`ClipRepositoryGateway`に進捗更新用メソッドを追加。

```typescript
updateComposeProgress(
  clipId: string,
  phase: ComposeProgressPhase,
  percent: number
): Promise<void>

updateComposeStatus(
  clipId: string,
  status: ComposeStatus,
  errorMessage?: string
): Promise<void>
```

#### 4.3 UseCase変更 - 非同期化

[compose-subtitled-clip.usecase.ts](../apps/backend/src/contexts/clip-video/application/usecases/compose-subtitled-clip.usecase.ts)を非同期処理に変更。

**変更前**: 同期処理（レスポンスを返すまでブロック）
**変更後**: 202 Accepted を即座に返し、バックグラウンドで処理

各ステップで進捗を更新:
1. ダウンロード開始時 → `downloading`, 0%
2. ダウンロード完了時 → `downloading`, 20%
3. 変換開始時（optional）→ `converting`, 20%
4. 変換完了時 → `converting`, 40%
5. 合成開始時 → `composing`, 40%
6. 合成完了時 → `composing`, 80%
7. アップロード開始時 → `uploading`, 80%
8. アップロード完了時 → `uploading`, 100%
9. composeStatus = 'completed'

#### 4.4 APIエンドポイント追加

既存のPOSTエンドポイントを非同期化し、進捗取得用エンドポイントを追加。

```
POST /api/clip-video/clips/:clipId/compose
  → 202 Accepted（即座に返す）
  → バックグラウンドで処理開始

GET /api/clip-video/clips/:clipId/compose-status
  → { composeStatus, composeProgressPhase, composeProgressPercent, composeErrorMessage }
```

### 5. フロントエンド実装変更

#### 5.1 ポーリング追加

[subtitle-composition-status.tsx](../apps/webapp/src/components/features/clip-detail/subtitle-composition-status.tsx)でポーリングを追加。

```typescript
const POLLING_INTERVAL = 2000; // 2秒間隔

// composeStatus === 'processing' の間ポーリング
useEffect(() => {
  if (composeStatus === 'processing') {
    const interval = setInterval(fetchComposeStatus, POLLING_INTERVAL);
    return () => clearInterval(interval);
  }
}, [composeStatus]);
```

#### 5.2 UI表示変更

進捗バーとフェーズ表示を追加:

```
[=========>          ] 45%
字幕を合成中...
```

フェーズの日本語表示:
- `downloading` → 「動画をダウンロード中...」
- `converting` → 「フォーマットを変換中...」
- `composing` → 「字幕を合成中...」
- `uploading` → 「アップロード中...」

### 6. 共有型定義

`@video-processor/shared`に型を追加。

```typescript
export type ComposeStatus = 'idle' | 'processing' | 'completed' | 'failed';
export type ComposeProgressPhase = 'downloading' | 'converting' | 'composing' | 'uploading';

export interface ClipComposeStatusResponse {
  composeStatus: ComposeStatus | null;
  composeProgressPhase: ComposeProgressPhase | null;
  composeProgressPercent: number | null;
  composeErrorMessage: string | null;
}
```

---

## 実装順序

1. Prismaスキーマ変更 + マイグレーション
2. 共有型定義更新（`@video-processor/shared`）
3. ドメインモデル（`Clip`）に進捗関連フィールド追加
4. Repository実装（進捗更新メソッド追加）
5. UseCase実装（非同期化 + 各ステップで進捗更新）
6. APIエンドポイント追加（進捗取得用）
7. フロントエンドUI更新（ポーリング + 進捗表示）

---

## 考慮事項

### ページ離脱時の挙動

非同期化により「ページを離れないでください」の注意書きが不要になる。ユーザーはページを離れても処理が継続し、戻ってきたときに結果を確認できる。

### エラー時の挙動

処理中にエラーが発生した場合:
- `composeStatus` = 'failed'
- `composeErrorMessage` にエラー内容を保存
- フロントエンドでエラー表示

### 再合成時の挙動

再合成ボタンを押した場合:
- `composeStatus` = 'processing'
- `composeProgressPhase` = null
- `composeProgressPercent` = null
- `composeErrorMessage` = null
- 既存の`subtitledVideoGcsUri`/`subtitledVideoUrl`はそのまま（完了時に上書き）

---

## ファイル変更一覧

| ファイル | 変更内容 |
|---------|---------|
| `apps/backend/.../prisma/schema.prisma` | カラム追加 |
| `apps/shared/types/clip-video.ts` | 型定義追加 |
| `apps/backend/.../domain/models/clip.ts` | 進捗フィールド・メソッド追加 |
| `apps/backend/.../domain/gateways/clip-repository.gateway.ts` | 進捗更新メソッド追加 |
| `apps/backend/.../infrastructure/repositories/clip.repository.ts` | 進捗更新実装 |
| `apps/backend/.../application/usecases/compose-subtitled-clip.usecase.ts` | 非同期化 + 進捗更新 |
| `apps/backend/.../presentation/routes/clip-subtitles.ts` | エンドポイント追加 |
| `apps/webapp/.../clip-detail/subtitle-composition-status.tsx` | ポーリング + 進捗表示 |

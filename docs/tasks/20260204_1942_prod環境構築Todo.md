# prod環境構築Todo

## 目的

開発チームがprod環境を利用できるようになり、本番サービスを提供できる状態になるため。

## 現状

- **stg環境**: 正常稼働中
- **prod環境**: GCPリソースが存在しない。Terraformコードも古いまま更新されていない

## stgとprodのTerraformコード差分

### envs/prod/variables.tf に不足している変数

| 変数名 | 説明 |
|--------|------|
| `env` | 環境名（networking moduleで使用） |
| `webapp_api_key` | WebApp BFF認証用APIキー |
| `gemini_api_key` | Gemini APIキー |
| `fish_audio_api_key` | Fish Audio APIキー |
| `fish_audio_default_voice_model_id` | Fish Audio デフォルト音声モデルID |
| `anthropic_api_key` | Anthropic APIキー |
| `migration_image` | DBマイグレーション用コンテナイメージ |
| `temp_storage_type` | 一時ストレージタイプ（local/gcs） |
| `video_temp_bucket` | 動画一時保存用GCSバケット |

### envs/prod/main.tf の問題点

1. **secretsモジュール**: stgでは7つのシークレットを渡しているが、prodでは2つのみ
   - 不足: `database_password`, `webapp_api_key`, `gemini_api_key`, `fish_audio_api_key`, `fish_audio_default_voice_model_id`, `anthropic_api_key`

2. **cloud-runモジュール**: 以下の設定が不足
   - `migration_image` - DBマイグレーション機能
   - 各種 `*_secret_id` - シークレット参照
   - `concurrency` - 同時リクエスト数
   - `temp_storage_type`, `video_temp_bucket` - GCS一時ストレージ

3. **その他**: `database_password`が直接渡されているが、stgではsecrets経由で渡している

### envs/prod/.env.example に不足している変数

- `WEBAPP_API_KEY`
- `GEMINI_API_KEY`
- `FISH_AUDIO_API_KEY`
- `FISH_AUDIO_DEFAULT_VOICE_MODEL_ID`
- `ANTHROPIC_API_KEY`
- `MIGRATION_IMAGE`

---

## Todoリスト

### フェーズ1: GCPプロジェクトの準備

- [ ] **1-1**: prod用GCPプロジェクトの存在確認
  - 存在しない場合は作成する
  - プロジェクトID例: `video-processor-prod`または適切な命名

- [ ] **1-2**: Terraform実行権限の確認
  - gcloud CLIでprodプロジェクトに対する認証ができることを確認
  - 必要な権限: オーナーまたは編集者権限

- [ ] **1-3**: tfstate用GCSバケットへのアクセス確認
  - 既存バケット `mirai-video-processor-tfstate` を使用する場合、prodプロジェクトからアクセス可能か確認

### フェーズ2: Terraformコードの更新

- [ ] **2-1**: `envs/prod/variables.tf` の更新
  - stgと同じ変数を追加（上記差分参照）

- [ ] **2-2**: `envs/prod/main.tf` の更新
  - secretsモジュールに全シークレットを渡す
  - cloud-runモジュールにmigration、secrets ID、temp storage設定を追加
  - networkingモジュールの`env`をハードコードから変数化

- [ ] **2-3**: `envs/prod/.env.example` の更新
  - stgと同じ環境変数を追加

- [ ] **2-4**: `envs/prod/terraform.tfvars.tpl` の確認・更新
  - 新しい変数のテンプレートを追加

### フェーズ3: 環境変数・シークレットの準備

- [ ] **3-1**: prod用APIキーの準備
  - OpenAI APIキー（prod用）
  - Gemini APIキー（prod用）
  - Fish Audio APIキー + ボイスモデルID（prod用）
  - Anthropic APIキー（prod用）
  - WebApp APIキー（新規生成）

- [ ] **3-2**: prod用Google Drive出力フォルダの作成
  - クリップ出力用フォルダ
  - トランスクリプト出力用フォルダ

- [ ] **3-3**: prod用Googleサービスアカウントの作成
  - GCPコンソールからサービスアカウントを作成
  - 必要な権限を付与
  - JSONキーをダウンロード

- [ ] **3-4**: prod用 `.env` ファイルの作成
  - `envs/prod/.env.example` をコピーして `.env` を作成
  - 各値を実際の値で埋める

### フェーズ4: デプロイ実行

- [ ] **4-1**: Terraform初期化
  ```bash
  ./deploy.sh prod init
  ```

- [ ] **4-2**: Terraformプラン確認
  ```bash
  ./deploy.sh prod plan
  ```
  - 作成されるリソースを確認
  - エラーがないことを確認

- [ ] **4-3**: Terraform適用
  ```bash
  ./deploy.sh prod apply
  ```
  - API有効化に時間がかかる場合は再実行

- [ ] **4-4**: Dockerイメージのビルドとプッシュ
  ```bash
  ./deploy.sh prod build
  ```
  - または手動でビルド・プッシュ

- [ ] **4-5**: Cloud Runサービスの更新
  - 新しいイメージでCloud Runを更新

- [ ] **4-6**: DBマイグレーション実行
  - マイグレーションジョブが正常に完了することを確認

### フェーズ5: 動作確認

- [ ] **5-1**: Cloud Run URLへのアクセス確認
  - ヘルスチェックエンドポイントへアクセス

- [ ] **5-2**: DB接続確認
  - Cloud SQLへの接続が正常に行われることを確認

- [ ] **5-3**: 基本機能のE2Eテスト
  - 動画処理の一連のフローが動作することを確認

---

## 注意事項

- **削除保護**: prodのCloud SQLは `deletion_protection = true` のため、誤削除を防止
- **バックアップ**: prodのCloud SQLは自動バックアップ有効（7日間保持）
- **最小インスタンス**: prodのCloud Runは `min_instances = 1` のため、常時1インスタンス稼働（コストに注意）
- **CORS設定**: prodでは `CORS_ORIGIN` に具体的なフロントエンドドメインを設定すること（`*` は非推奨）

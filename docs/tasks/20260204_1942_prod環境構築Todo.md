# prod環境構築Todo

## 目的

開発チームがprod環境を利用できるようになり、本番サービスを提供できる状態になるため。

## 現状

- **GCPプロジェクト**: `mirai-video-processor`（stgと共用）
- **stg環境**: 正常稼働中（`video-processor-stg-*` リソース群）
- **prod環境**: Terraformコードが古く、stgとの差分が多数ある。GCPリソース未作成

## stgとprodのTerraformコード差分

### envs/prod/variables.tf に不足している変数

| 変数名 | 説明 |
|--------|------|
| `env` | 環境名（networking moduleで使用） |
| `webapp_api_key` | WebApp BFF認証用APIキー |
| `gemini_api_key` | Gemini APIキー |
| `fish_audio_api_key` | Fish Audio APIキー |
| `fish_audio_default_voice_model_id` | Fish Audio デフォルト音声モデルID |
| `anthropic_api_key` | Anthropic APIキー |
| `migration_image` | DBマイグレーション用コンテナイメージ |
| `temp_storage_type` | 一時ストレージタイプ（local/gcs） |
| `video_temp_bucket` | 動画一時保存用GCSバケット |

### envs/prod/main.tf の問題点

1. **networkingモジュール**: `env = "prod"` がハードコードされている（stgでは `var.env` を使用）
   - ただし prod は固定値で問題ないため、`env`変数を追加して `var.env` に変更が望ましい

2. **secretsモジュール**: stgでは8つの値を渡しているが、prodでは2つのみ
   - 不足: `database_password`, `webapp_api_key`, `gemini_api_key`, `fish_audio_api_key`, `fish_audio_default_voice_model_id`, `anthropic_api_key`

3. **cloud-runモジュール**: 以下の設定が不足
   - `migration_image` - DBマイグレーション機能
   - `database_password_secret_id` - Secret Manager経由（現在は `database_password` を直接渡している）
   - `webapp_api_key_secret_id` - Secret Manager経由
   - `gemini_api_key_secret_id` - Secret Manager経由
   - `fish_audio_api_key_secret_id` - Secret Manager経由
   - `fish_audio_default_voice_model_id` - 直接値
   - `anthropic_api_key_secret_id` - Secret Manager経由
   - `concurrency` - 同時リクエスト数（stgでは80）
   - `temp_storage_type`, `video_temp_bucket` - GCS一時ストレージ

4. **cloud-runモジュールのスペック**: 以下はprod用に要検討
   - `cpu = "2"` → stgは `"4"` （動画処理のため `"4"` が必要な可能性あり）
   - `memory = "2Gi"` → stgは `"16Gi"` （動画処理のため大容量が必要な可能性あり）
   - `max_instances = 10` → stgは `1`（prodでは複数でOK）
   - `request_timeout = 3600` → stgは `900`

### envs/prod/.env.example に不足している変数

- `WEBAPP_API_KEY`
- `GEMINI_API_KEY`
- `FISH_AUDIO_API_KEY`
- `FISH_AUDIO_DEFAULT_VOICE_MODEL_ID`
- `ANTHROPIC_API_KEY`
- `MIGRATION_IMAGE`

---

## Todoリスト

### フェーズ1: 既存GCPプロジェクトでのprod準備

> 同一プロジェクト `mirai-video-processor` 内にprodリソースを追加する

- [ ] **1-1**: Terraform実行権限の確認
  - gcloud CLIで `mirai-video-processor` プロジェクトに対する認証ができることを確認
  - stgデプロイ時と同じ権限でOK

- [ ] **1-2**: tfstate用GCSバケットの確認
  - 既存バケット `mirai-video-processor-tfstate` をstg/prod共用
  - stgとprodでstate prefixが分かれていることを確認（backend.tfのprefix設定）

- [ ] **1-3**: Artifact Registryにprod用リポジトリを作成
  - `video-processor-prod` リポジトリを `asia-northeast1` に作成
  - stgは `video-processor-stg` で既に存在

### フェーズ2: Terraformコードの更新

- [ ] **2-1**: `envs/prod/variables.tf` の更新
  - stgと同じ変数を追加（上記差分参照）
  - `env` 変数を追加（default = "prod"）

- [ ] **2-2**: `envs/prod/main.tf` の更新
  - networkingモジュール: `env = "prod"` → `env = var.env` に変更
  - secretsモジュールに全シークレットを渡す（stgと同じ8つ）
  - cloud-runモジュールに以下を追加:
    - `migration_image`
    - 各種 `*_secret_id`（Secret Manager経由に統一）
    - `database_password` 直接渡しを削除
    - `concurrency`
    - `temp_storage_type`, `video_temp_bucket`
    - `fish_audio_default_voice_model_id`
  - cloud-runモジュールのスペック検討:
    - cpu/memoryはstgと同じ `"4"` / `"16Gi"` にする（動画処理で必要）
    - `min_instances = 1`（コールドスタート回避）
    - `max_instances` は適切な値を設定

- [ ] **2-3**: `envs/prod/.env.example` の更新
  - stgと同じ環境変数を追加（MIGRATION_IMAGE含む）

- [ ] **2-4**: `envs/prod/terraform.tfvars.tpl` の確認・更新
  - 新しい変数のテンプレートを追加

### フェーズ3: 環境変数・シークレットの準備

- [ ] **3-1**: prod用APIキーの準備
  - OpenAI APIキー（prod用 or stgと共用）
  - Gemini APIキー（prod用 or stgと共用）
  - Fish Audio APIキー + ボイスモデルID（prod用 or stgと共用）
  - Anthropic APIキー（prod用 or stgと共用）
  - WebApp APIキー（新規生成）

- [ ] **3-2**: prod用Google Drive出力フォルダの作成
  - クリップ出力用フォルダ
  - トランスクリプト出力用フォルダ

- [ ] **3-3**: prod用Googleサービスアカウント
  - 既存の `video-processor-prod-run-sa` がTerraformで自動作成される
  - Google Drive APIアクセス用のサービスアカウントJSONキーを準備
    - stgと同じものを共用するか、prod用に新規作成するか検討

- [ ] **3-4**: prod用 `.env` ファイルの作成
  - `envs/prod/.env.example` をコピーして `.env` を作成
  - 各値を実際の値で埋める

### フェーズ4: デプロイ実行

- [ ] **4-1**: Terraform初期化
  ```bash
  cd infrastructure/terraform
  ./deploy.sh prod init
  ```

- [ ] **4-2**: Terraformプラン確認
  ```bash
  ./deploy.sh prod plan
  ```
  - 作成されるリソースを確認（stgリソースに影響がないこと）
  - エラーがないことを確認

- [ ] **4-3**: Terraform適用
  ```bash
  ./deploy.sh prod apply
  ```
  - API有効化は既にstgで済んでいるため不要（同一プロジェクト）

- [ ] **4-4**: Dockerイメージのビルドとプッシュ
  ```bash
  REGISTRY=asia-northeast1-docker.pkg.dev/mirai-video-processor/video-processor-prod

  # バックエンドイメージ
  docker build --platform linux/amd64 -f apps/backend/Dockerfile -t ${REGISTRY}/backend:latest .
  docker push ${REGISTRY}/backend:latest

  # マイグレーションイメージ
  docker build --platform linux/amd64 -f apps/backend/Dockerfile --target migrator -t ${REGISTRY}/migration:latest .
  docker push ${REGISTRY}/migration:latest
  ```

- [ ] **4-5**: DBマイグレーション実行
  - マイグレーションジョブが正常に完了することを確認

### フェーズ5: 動作確認

- [ ] **5-1**: Cloud Run URLへのアクセス確認
  - ヘルスチェックエンドポイントへアクセス

- [ ] **5-2**: DB接続確認
  - Cloud SQLへの接続が正常に行われることを確認

- [ ] **5-3**: 基本機能のE2Eテスト
  - 動画処理の一連のフローが動作することを確認

---

## 注意事項

- **同一プロジェクト**: stgとprodは同じGCPプロジェクト `mirai-video-processor` 内に共存する。リソース名は `video-processor-stg-*` / `video-processor-prod-*` で区別される
- **API有効化**: 同一プロジェクトなのでstg構築時に有効化済み。prod側のTerraformでも `google_project_service` は冪等に動作する
- **tfstate分離**: stgとprodは同じGCSバケットだがprefix（パス）で分離されている
- **削除保護**: prodのCloud SQLは `deletion_protection = true` のため、誤削除を防止
- **バックアップ**: prodのCloud SQLは自動バックアップ有効（7日間保持）
- **最小インスタンス**: prodのCloud Runは `min_instances = 1` のため、常時1インスタンス稼働（コストに注意）
- **CORS設定**: prodでは `CORS_ORIGIN` に具体的なフロントエンドドメインを設定すること（`*` は非推奨）

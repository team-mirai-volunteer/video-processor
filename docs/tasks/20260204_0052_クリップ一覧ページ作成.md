# クリップ一覧ページ作成

## 目的

ユーザーが、動画をまたいで切り抜き（クリップ）を横断的に確認できるようにするため。現状はクリップを確認するには各動画の詳細ページに行く必要があり、全体のクリップを一覧で俯瞰できない。

## 概要

clip-video BCのクリップデータを、動画横断でページネーション付きで一覧表示する新しいページ `/clips` を作成する。

## 表示項目

| 項目 | データソース |
|------|------------|
| 元動画タイトル | `Video.title` |
| 切り抜きタイトル | `Clip.title` |
| 切り抜かれた文章 | `Clip.transcript` |
| 元動画の詳細ページリンク | `/videos/{videoId}` |
| GDriveリンク | `Clip.googleDriveUrl` |

## ページネーション

- デフォルト: 50件/ページ
- 最大: 100件/ページ
- `page` / `limit` クエリパラメータで制御
- 既存の `Pagination` 型 (`PaginatedResponse<T>`) を再利用

## 設計

### 1. 共有型定義 (apps/shared)

`apps/shared/types/api.ts` に以下を追加:

- `GetAllClipsQuery` - クエリパラメータ型 (`page`, `limit`)
- `AllClipSummary` - 一覧用の型（元動画タイトル含む）
- `GetAllClipsResponse` - `PaginatedResponse<AllClipSummary>`

`AllClipSummary` の構造:

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | string | クリップID |
| title | string \| null | クリップタイトル |
| transcript | string \| null | 切り抜き文章 |
| googleDriveUrl | string \| null | GDriveリンク |
| status | ClipStatus | ステータス |
| videoId | string | 元動画ID |
| videoTitle | string \| null | 元動画タイトル |
| createdAt | Date | 作成日時 |

`apps/shared/types/index.ts` にエクスポートを追加。

### 2. バックエンド

#### 2a. Domain - Gateway拡張

`clip-repository.gateway.ts` に追加:

- `findAllPaginated(options: { page: number; limit: number }): Promise<{ clips: ClipWithVideo[]; total: number }>` メソッド
- `ClipWithVideo` 型 - `Clip` と `videoTitle` を含む

#### 2b. Infrastructure - Repository実装

`clip.repository.ts` に `findAllPaginated` を実装:

- Prismaの `clip.findMany` で `include: { video: { select: { title: true } } }` を使用
- `orderBy: { createdAt: 'desc' }` でソート
- `skip` / `take` でページネーション
- `clip.count()` で総件数を取得

#### 2c. Application - UseCase

`get-all-clips.usecase.ts` を新規作成:

- `ClipRepositoryGateway` に依存
- 入力: `{ page?: number; limit?: number }`
- デフォルト: page=1, limit=50, 最大limit=100
- 出力: `GetAllClipsResponse` (PaginatedResponse)

#### 2d. Presentation - Route

`clips.ts` に `GET /api/clips` エンドポイントを追加:

- クエリパラメータ: `page`, `limit`
- UseCase を呼び出してレスポンスを返す

### 3. フロントエンド

#### 3a. Server Loader

`apps/webapp/src/server/presentation/clip-video/loaders/loadAllClips.ts` を新規作成:

- `backendClient.getAllClips(query)` を呼び出す

#### 3b. Backend Client

`apps/webapp/src/server/infrastructure/clients/backend-client.ts` に `getAllClips` メソッドを追加:

- `GET /api/clips` を呼び出す

#### 3c. ページ

`apps/webapp/src/app/clips/page.tsx` を新規作成:

- Server Component
- `loadAllClips` でデータ取得
- `ClipListTable` コンポーネントを呼び出す

#### 3d. テーブルコンポーネント

`apps/webapp/src/components/features/clip-list/clip-list-table.tsx` を新規作成:

- Client Component (ページネーション操作のため)
- shadcn/ui の `Table` コンポーネントを使用
- 各行: 元動画タイトル（動画詳細リンク付き）、クリップタイトル、文章（長文は省略表示）、GDriveリンク（外部リンクアイコン付き）
- ページネーションUI: 前へ/次へボタン + ページ番号表示

#### 3e. ナビゲーション

`apps/webapp/src/app/layout.tsx` のヘッダーに「クリップ一覧」リンクを追加。

## 並列タスク分割

以下の3タスクは互いに依存がなく、並列実行可能:

### タスクA: 共有型定義 + バックエンド全体

1. `apps/shared/types/api.ts` に `GetAllClipsQuery`, `AllClipSummary`, `GetAllClipsResponse` を追加
2. `apps/shared/types/index.ts` にエクスポート追加
3. `clip-repository.gateway.ts` に `findAllPaginated` メソッド追加
4. `clip.repository.ts` に実装追加
5. `get-all-clips.usecase.ts` 新規作成
6. `clips.ts` ルートにエンドポイント追加

### タスクB: フロントエンド - ページ・コンポーネント

1. `clip-list-table.tsx` テーブルコンポーネント作成
2. `apps/webapp/src/app/clips/page.tsx` ページ作成

### タスクC: フロントエンド - データ層 + ナビゲーション

1. `backend-client.ts` に `getAllClips` メソッド追加
2. `loadAllClips.ts` loader作成
3. `layout.tsx` のナビゲーションにリンク追加

**依存関係**: タスクBはタスクA（型定義）とタスクC（loader）に依存するが、型定義のインターフェースが上記で合意されていれば、コンパイルは後から通せるため並列着手可能。

## アーキテクチャ整合性チェック

- Domain層の Gateway にインターフェースを定義 → OK
- Infrastructure の Repository が Gateway を実装 → OK
- Application の UseCase は Gateway 経由でデータアクセス → OK
- Presentation は UseCase を呼び出す → OK
- Context 間の直接依存なし → OK
- 共有型は `apps/shared` に配置 → OK

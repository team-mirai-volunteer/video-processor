# shorts-gen（ショート動画生成）機能仕様

## 概要

新規Bounded Context `shorts-gen` を追加し、AIを活用したショート動画の自動生成フローを実現する。

---

## 処理フロー

```
①企画ルート作成 ─┬─→ ②企画書作成 ─→ ③台本作成 ─┬─→ ④音声合成 ────────┐
                 │                              ├─→ ⑤字幕生成 ────────┼─→ ⑧Compose → ⑨公開テキスト
                 │                              ├─→ ⑥画像プロンプト → ⑦画像生成 ┘
                 │                              │
                 └──────────────────────────────┘
                    (②③は対話的、やり直し可能)
```

---

## 各ステップ詳細

### ① 企画ルートを作る

| 項目 | 内容 |
|------|------|
| Input | 動画企画タイトル（最終タイトルとは別） |
| Output | 動画メタデータ（縦横比など全体に関する仕様） |
| ツール | なし |

**備考**:
- 縦横比は初期9:16固定、変数としては保持
- 解像度は初期1080x1920固定、変数としては保持

---

### ② 企画書を作る

| 項目 | 内容 |
|------|------|
| Input | 長文（コピペしたマニフェストや、URL）、①の出力 |
| Output | 企画書マークダウン |
| ツール | OpenAI + Vercel AI SDK（Agenticに動作） |

**備考**:
- **対話的**にしたい（チャットUI + SSE）
- AIが **tool use で保存**する
- 会話履歴は揮発OK（成果物さえ残れば）
- **編集して保存可能**

---

### ③ 台本を作る

| 項目 | 内容 |
|------|------|
| Input | ②の出力 |
| Output | シーンの配列 |
| ツール | OpenAI + Vercel AI SDK（Agenticに動作） |

**シーンの構造**:
```typescript
interface Scene {
  summary: string;           // シーン概要
  visualType: VisualType;    // シーン映像タイプ
  voiceText: string | null;  // 読み上げ音声文（nullable）
  subtitles: string[];       // 字幕文の配列（1シーン複数可）
  silenceDurationMs: number | null; // 無音の場合のシーン長さ
}

type VisualType =
  | 'image_gen'    // 画像生成
  | 'stock_video'  // ありものの動画（党首演説動画素材など）
  | 'solid_color'; // 塗りつぶし
```

**備考**:
- **ここで秒数は決めない**（音声ベースの間が大切）
- **対話的**にしたい（チャットUI + SSE）
- AIが **tool use で保存**する
- 会話履歴は揮発OK
- 字幕はCompose時にシーン内に**均等に割り付け**
- **編集して保存可能**
- 「ありもの動画」素材はGitHub管理（PJ内に配置、100MB以内想定）
- 素材の指定方法: セレクタ（対応表JSONで管理）

---

### ④ 音声を合成する

| 項目 | 内容 |
|------|------|
| Input | ③の出力 |
| Output | シーンごとの音声ファイル、秒数 |
| ツール | Fish Audio想定 |

**備考**:
- TTSとSTSを別でやる可能性あり
- API仕様は実装時に調査

---

### ⑤ 字幕を作成する

| 項目 | 内容 |
|------|------|
| Input | ③の出力 |
| Output | 背景透明の画像の配列 |
| ツール | FFmpeg |

---

### ⑥ 画像プロンプトを作成する

| 項目 | 内容 |
|------|------|
| Input | ③の出力、**スタイル指定文章**（猫キャラを使うなど） |
| Output | シーンごとの画像プロンプト |
| ツール | OpenAI |

**備考**:
- **編集して保存可能**
- スタイル指定文章の保存場所は要設計（Project単位？）

---

### ⑦ 画像を生成する

| 項目 | 内容 |
|------|------|
| Input | ⑥の出力 |
| Output | シーンごとの画像ファイル |
| ツール | nano banana |

**備考**:
- API仕様は実装時に調査・ドキュメント化

---

### ⑧ Composeする

| 項目 | 内容 |
|------|------|
| Input | ③④⑤⑦の出力、BGM（nullable） |
| Output | 動画ファイル |
| ツール | FFmpeg |

**備考**:
- BGMはGitHub内の固定ファイル

---

### ⑨ 公開用テキストを作成する

| 項目 | 内容 |
|------|------|
| Input | ②③の出力 |
| Output | 動画タイトル、ディスクリプション |
| ツール | OpenAI |

---

## 共通仕様

### やり直し
- **それぞれの処理は個別にやり直し可能**
- 前のフローを再実行もできる

### 編集保存
- ②③⑥の出力は編集して保存可能

### ストレージ
- 素材（音声、画像、動画）はGCSに保存
- パス/URLはDBに保存

---

## 体験フロー

1. **ショート動画生成タブ**が存在
2. そこから**企画ルート一覧**が見られる
3. 企画ルート詳細ページでは、**UIが縦に連なる生成フロー**で順に生成していける
4. 前のフローを再実行もできる
5. UI上、**音声・字幕・画像生成は縦に3分割**され並列実行可能

```
┌─────────────────────────────────────────────┐
│ ① 企画ルート: "AIについて解説"              │ [編集]
├─────────────────────────────────────────────┤
│ ② 企画書                                    │ [再生成] [編集]
│ ┌─────────────────────────────────────────┐ │
│ │ [チャットUI - SSE対話]                   │ │
│ └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────┤
│ ③ 台本                                      │ [再生成] [編集]
│ ┌─────────────────────────────────────────┐ │
│ │ [チャットUI - SSE対話]                   │ │
│ │ シーン1: ...                             │ │
│ │ シーン2: ...                             │ │
│ └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────┤
│        ④音声    │   ⑤字幕   │ ⑥⑦画像       │ ← 3列並列
│ ┌─────────┐ │ ┌───────┐ │ ┌─────────┐      │
│ │ [生成]   │ │ │[生成] │ │ │ [生成]  │      │
│ │ Scene1 ✓│ │ │Scene1✓│ │ │ Scene1 ✓│      │
│ │ Scene2 ✓│ │ │Scene2✓│ │ │ Scene2 ✓│      │
│ └─────────┘ │ └───────┘ │ └─────────┘      │
├─────────────────────────────────────────────┤
│ ⑧ Compose                                   │ [生成]
│ [プレビュー動画]                            │
├─────────────────────────────────────────────┤
│ ⑨ 公開テキスト                              │ [生成] [編集]
│ タイトル: ...                               │
│ 説明: ...                                   │
└─────────────────────────────────────────────┘
```

---

## 設計観点

- 既存BCの構造（DDD・テスト重視）を堅持
- infraのclientに**integration testを必ず実装**し個別に動作確認可能にする
- 認証なし、ロック実装不要

---

## 環境変数

```env
# Fish Audio
FISH_AUDIO_API_KEY=
FISH_AUDIO_API_URL=

# nano banana
NANO_BANANA_API_KEY=
NANO_BANANA_API_URL=

# OpenAI (既存のものを流用可能)
OPENAI_API_KEY=

# GCS (既存のものを流用)
GCS_BUCKET_NAME=
```

---

## 未決事項

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| ⑥スタイル指定文章の保存場所 | Project単位 / Scene単位 / パラメータのみ | **要確認** |
| TTS/STS分離 | 統合 / 分離 | 実装時に判断 |

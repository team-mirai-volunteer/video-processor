# キャッシュ処理（Drive → GCS）の進捗表示設計

## 目的

**ユーザーが、長時間かかるキャッシュ処理（動画転送）の進捗が分からず不安になる状態を解消するため**

現在の「キャッシュ (Drive → GCS)」ステップは「実行中...」としか表示されず、処理がどの程度進んでいるか分からない。特に動画ファイルは大きい（数百MB〜数GB）ため、数分〜数十分かかることがあり、この間ユーザーはフィードバックがないまま待つことになる。

## 方式選定

### 比較検討

| 方式 | リアルタイム性 | リロード耐性 | 実装コスト |
|------|--------------|-------------|-----------|
| SSE | 高 | 低（進捗が途切れる） | 中 |
| WebSocket | 最高 | 低 | 高 |
| **ポーリング + DB保存** | 中（5秒間隔） | **高** | **低** |

### 採用方式: ポーリング + DB保存

理由:
- リロードしても進捗を取得可能
- 既存のアーキテクチャに馴染む
- Cloud Runとの相性が良い（コネクション維持不要）
- 他のステップ（音声抽出、文字起こし等）にも同じパターンで対応可能

## 設計詳細

### 1. DBスキーマ変更

`Video`テーブルに自由形式の進捗メッセージフィールドを追加:

```prisma
model Video {
  // ... 既存フィールド

  progressMessage  String?   @map("progress_message")  // 追加

  // ...
}
```

### 2. 進捗メッセージの例

| フェーズ | progressMessage例 |
|---------|------------------|
| キャッシュ確認 | `キャッシュ確認中...` |
| ダウンロード中 | `ダウンロード中... 256MB / 1.2GB (21%)` |
| 完了 | `null`（クリア） |
| エラー | `null`（errorMessageに記録） |

### 3. バックエンド実装

#### 3.1 Videoドメインモデル拡張

```typescript
// domain/models/video.ts
class Video {
  // 既存メソッド...

  withProgressMessage(message: string | null): Video {
    return new Video({
      ...this.props,
      progressMessage: message,
    });
  }
}
```

#### 3.2 CacheVideoUseCase の進捗更新

```typescript
// application/usecases/cache-video.usecase.ts
async execute(videoId: string): Promise<CacheVideoResult> {
  // ...

  // 進捗更新: ダウンロード開始
  currentVideo = currentVideo.withProgressMessage('ダウンロード中...');
  await this.videoRepository.save(currentVideo);

  // ストリーム転送（進捗コールバック付き）
  const { gcsUri, expiresAt } = await this.tempStorageGateway.uploadFromStreamWithProgress(
    { videoId: video.id },
    stream,
    (bytesTransferred) => {
      // 進捗更新（スロットリング: 5秒ごと or 10%ごと）
      const percent = Math.floor((bytesTransferred / totalBytes) * 100);
      const message = `ダウンロード中... ${formatBytes(bytesTransferred)} / ${formatBytes(totalBytes)} (${percent}%)`;
      // 非同期で更新（awaitしない）
      this.updateProgress(videoId, message);
    }
  );

  // 完了時にクリア
  currentVideo = currentVideo.withProgressMessage(null);
  await this.videoRepository.save(currentVideo);
}
```

#### 3.3 Gateway層の拡張

```typescript
// domain/gateways/temp-storage.gateway.ts
export interface TempStorageGateway {
  // 既存メソッド...

  uploadFromStreamWithProgress(
    params: TempStorageStreamUploadParams,
    source: NodeJS.ReadableStream,
    onProgress?: (bytesTransferred: number) => void
  ): Promise<TempStorageUploadResult>;
}
```

#### 3.4 GcsClient の進捗計測実装

Transform Streamを使ってバイト数を計測:

```typescript
// infrastructure/clients/gcs.client.ts
import { Transform } from 'node:stream';

async uploadFromStreamWithProgress(
  params: TempStorageStreamUploadParams,
  source: NodeJS.ReadableStream,
  onProgress?: (bytesTransferred: number) => void
): Promise<TempStorageUploadResult> {
  // ... GCS準備 ...

  let bytesTransferred = 0;
  const progressTracker = new Transform({
    transform(chunk, encoding, callback) {
      bytesTransferred += chunk.length;
      onProgress?.(bytesTransferred);
      this.push(chunk);
      callback();
    }
  });

  await pipeline(source, progressTracker, writeStream);

  // ...
}
```

### 4. フロントエンド実装

#### 4.1 ポーリングの実装

```typescript
// ProcessingPipeline.tsx
const [progressMessage, setProgressMessage] = useState<string | null>(null);

// ポーリング: キャッシュ実行中のみ
useEffect(() => {
  if (steps.cache.status !== 'running') return;

  const interval = setInterval(async () => {
    const video = await fetchVideo(videoId);
    setProgressMessage(video.progressMessage);

    // 完了判定
    if (video.gcsUri) {
      clearInterval(interval);
      // ... 完了処理
    }
  }, 5000); // 5秒ごと

  return () => clearInterval(interval);
}, [steps.cache.status, videoId]);
```

#### 4.2 PipelineStep の表示拡張

```tsx
<PipelineStep
  stepNumber={1}
  title="キャッシュ (Drive → GCS)"
  description="Google DriveからGCSへ動画をストリーム転送します"
  status={steps.cache.status}
  progressMessage={progressMessage}  // 追加
  // ...
>
```

### 5. 進捗更新のスロットリング

DBへの書き込み頻度を抑えるため、以下のいずれかの条件で更新:

- 前回更新から5秒以上経過
- 進捗が10%以上変化
- フェーズが変化

```typescript
class ProgressThrottler {
  private lastUpdate = 0;
  private lastPercent = 0;

  shouldUpdate(percent: number): boolean {
    const now = Date.now();
    const timeDiff = now - this.lastUpdate >= 5000;
    const percentDiff = percent - this.lastPercent >= 10;

    if (timeDiff || percentDiff) {
      this.lastUpdate = now;
      this.lastPercent = percent;
      return true;
    }
    return false;
  }
}
```

## 影響範囲

### DBマイグレーション
- `Video`テーブルに`progress_message`カラム追加

### バックエンド
- `apps/backend/src/domain/models/video.ts` - `withProgressMessage`メソッド追加
- `apps/backend/src/domain/gateways/temp-storage.gateway.ts` - インターフェース拡張
- `apps/backend/src/infrastructure/clients/gcs.client.ts` - 進捗付きアップロード実装
- `apps/backend/src/infrastructure/clients/local-temp-storage.client.ts` - 同上
- `apps/backend/src/infrastructure/repositories/video.repository.ts` - マッピング追加
- `apps/backend/src/application/usecases/cache-video.usecase.ts` - 進捗更新ロジック

### 共有型定義
- `apps/shared/types/video.ts` - `progressMessage`フィールド追加

### フロントエンド
- `apps/webapp/src/components/features/processing-pipeline/processing-pipeline.tsx` - ポーリング実装
- `apps/webapp/src/components/features/processing-pipeline/pipeline-step.tsx` - 進捗表示UI

## API変更

既存の `GET /api/videos/:id` レスポンスに `progressMessage` が追加される:

```json
{
  "id": "xxx",
  "status": "transcribing",
  "transcriptionPhase": "downloading",
  "progressMessage": "ダウンロード中... 256MB / 1.2GB (21%)",
  ...
}
```

## 将来の拡張

同じパターンで他のステップにも適用可能:

| ステップ | progressMessage例 |
|---------|------------------|
| 音声抽出 | `音声抽出中... 50%` |
| 文字起こし | `文字起こし中... セグメント 45/120` |
| AI校正 | `AI校正中... チャンク 3/5` |
| クリップ抽出 | `クリップ作成中... 2/5件完了` |

# 動画ダウンロードのストリーム化設計

## 目的

Cloud Run上で動画処理時にメモリクラッシュ（OOM）が頻発している状態を解消するため、
Google DriveからGCSへの動画転送をストリーム処理化し、メモリ使用量を大幅に削減する。

## 背景・現状の問題

### 現在のフロー

```
Google Drive → Buffer（オンメモリ） → GCSにアップロード（キャッシュ）
                    ↓
              FFmpegで音声抽出（Buffer → Buffer）
                    ↓
              文字起こしAPI
```

### 問題点

1. `GoogleDriveClient.downloadFile` が `responseType: 'arraybuffer'` で動画全体をメモリに展開
2. `GcsClient.upload` も `file.save(buffer)` で全Bufferをメモリに保持
3. 処理中に複数の大きなBuffer（動画 + 音声）が同時に存在
4. 大容量動画（数百MB〜数GB）でOOMが発生

## 設計方針

### Phase 1（本設計のスコープ）

Google Drive → GCS への転送をストリーム化し、動画ダウンロード時のメモリ使用量を削減する。

- `StorageGateway` にストリームダウンロードメソッドを追加
- `TempStorageGateway` にストリームアップロード/ダウンロードメソッドを追加
- `CreateTranscriptUseCase` を修正し、Drive → GCS をストリームで転送後、GCSから読み取る

### Phase 2（将来スコープ・本設計外）

- FFmpegのストリーム入出力対応
- 音声もGCSに置いてSpeech-to-Text Batch APIに直接渡す

## Gateway インターフェース変更

### StorageGateway（Google Drive用）

```typescript
// 追加メソッド
export interface StorageGateway {
  // 既存
  downloadFile(fileId: string): Promise<Buffer>;

  // 新規追加
  downloadFileAsStream(fileId: string): Promise<Readable>;
}
```

### TempStorageGateway（GCS/ローカル用）

```typescript
export interface TempStorageStreamUploadParams {
  videoId: string;
  contentType?: string;
}

export interface TempStorageGateway {
  // 既存（Buffer版）
  upload(params: TempStorageUploadParams): Promise<TempStorageUploadResult>;
  download(gcsUri: string): Promise<Buffer>;
  exists(gcsUri: string): Promise<boolean>;

  // 新規追加（Stream版）
  uploadFromStream(
    params: TempStorageStreamUploadParams,
    source: Readable
  ): Promise<TempStorageUploadResult>;

  downloadAsStream(gcsUri: string): Readable;
}
```

## Infrastructure実装

### GoogleDriveClient

```typescript
async downloadFileAsStream(fileId: string): Promise<Readable> {
  const response = await this.drive.files.get(
    { fileId, alt: 'media', supportsAllDrives: true },
    { responseType: 'stream' }
  );
  return response.data as Readable;
}
```

### GcsClient

```typescript
async uploadFromStream(
  params: TempStorageStreamUploadParams,
  source: Readable
): Promise<TempStorageUploadResult> {
  const gcsPath = `videos/${params.videoId}/original.mp4`;
  const gcsUri = `gs://${this.bucketName}/${gcsPath}`;

  const bucket = this.storage.bucket(this.bucketName);
  const file = bucket.file(gcsPath);
  const writeStream = file.createWriteStream({
    contentType: params.contentType ?? 'video/mp4',
  });

  await pipeline(source, writeStream);

  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + this.expirationDays);

  return { gcsUri, expiresAt };
}

downloadAsStream(gcsUri: string): Readable {
  const { bucketName, filePath } = this.parseGcsUri(gcsUri);
  const bucket = this.storage.bucket(bucketName);
  const file = bucket.file(filePath);
  return file.createReadStream();
}
```

### LocalTempStorageClient

```typescript
async uploadFromStream(
  params: TempStorageStreamUploadParams,
  source: Readable
): Promise<TempStorageUploadResult> {
  const videoDir = path.join(this.baseDir, 'videos', params.videoId);
  const filePath = path.join(videoDir, 'original.mp4');

  await fs.promises.mkdir(videoDir, { recursive: true });

  const writeStream = fs.createWriteStream(filePath);
  await pipeline(source, writeStream);

  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + this.expirationDays);

  return {
    gcsUri: `local://${filePath}`,
    expiresAt,
  };
}

downloadAsStream(uri: string): Readable {
  const filePath = this.parseUri(uri);
  return fs.createReadStream(filePath);
}
```

### LocalStorageClient（ローカル開発用Google Drive代替）

```typescript
async downloadFileAsStream(fileId: string): Promise<Readable> {
  const dataPath = this.getDataPath(fileId);

  if (!fs.existsSync(dataPath)) {
    throw new Error(`File not found: ${fileId}`);
  }

  return fs.createReadStream(dataPath);
}
```

## UseCase 分割設計

現在の `CreateTranscriptUseCase` を複数のUseCaseに分割し、UIから個別実行可能にする。

### 新しいUseCase構成

```
CacheVideoUseCase        : Drive → GCS（ストリーム転送）
ExtractAudioUseCase      : GCS → 音声ファイル抽出
TranscribeAudioUseCase   : 音声 → 文字起こし
RefineTranscriptUseCase  : 文字起こし → 整形（既存）

CreateTranscriptUseCase  : 上記すべてをラップ（オーケストレーション）
```

### 各UseCaseの責務

#### CacheVideoUseCase
- 入力: `videoId`
- 処理: GCSにキャッシュがなければ、DriveからGCSへストリーム転送
- 出力: `{ gcsUri, expiresAt }`
- UI用途: 動画のキャッシュを事前に作成

#### ExtractAudioUseCase
- 入力: `videoId`（GCSにキャッシュ済み前提）
- 処理: GCSから動画を取得し、FFmpegで音声抽出
- 出力: `{ audioBuffer, format }`
- UI用途: 音声抽出のみ実行

#### TranscribeAudioUseCase
- 入力: `videoId`, `audioBuffer`
- 処理: Speech-to-Text APIで文字起こし、DB保存
- 出力: `{ transcriptionId }`
- UI用途: 文字起こしのみ実行

#### CreateTranscriptUseCase（ラッパー）
- 入力: `videoId`
- 処理: 上記すべてを順番に実行
- 出力: `{ videoId, transcriptionId }`
- UI用途: 一括処理

### ステータス管理

各UseCaseがVideoのphaseを更新:

| UseCase | Phase |
|---------|-------|
| CacheVideoUseCase | `downloading` |
| ExtractAudioUseCase | `extracting_audio` |
| TranscribeAudioUseCase | `transcribing` |
| RefineTranscriptUseCase | `refining` |

### CacheVideoUseCase の処理フロー

```
1. GCSにキャッシュが存在するか確認
2. 存在しない場合:
   a. Google Driveからストリームで取得
   b. GCSにストリームで書き込み（pipe）
   c. DBにGCS情報を保存
3. GCS URIを返却
```

ポイント:
- Drive → GCS 転送時はメモリを使わない（ストリームpipe）
- FFmpegへの入力は従来通りBuffer（Phase 2で対応予定）

## エラーハンドリング

### 転送途中でのエラー

- `pipeline()` がエラーをthrow
- GCSに不完全なファイルが残る可能性がある
- 対策: catch時に `file.delete()` でクリーンアップ

### ネットワークタイムアウト

- Google Drive APIのストリームはbackpressureを自動処理
- GCSへの書き込みが遅い場合、Drive側のダウンロードも自動で待機

## 実装順序

1. **Gateway インターフェース変更**
   - `storage.gateway.ts` に `downloadFileAsStream` 追加
   - `temp-storage.gateway.ts` に `uploadFromStream`, `downloadAsStream` 追加

2. **Infrastructure実装**
   - `GoogleDriveClient` にストリームメソッド追加
   - `GcsClient` にストリームメソッド追加
   - `LocalStorageClient` にストリームメソッド追加
   - `LocalTempStorageClient` にストリームメソッド追加

3. **統合テスト作成**
   - `google-drive.client.test.ts` にストリームダウンロードテスト追加
   - `gcs.client.test.ts` を新規作成（ストリームアップロード/ダウンロード）
   - `local-storage.client.test.ts` を新規作成（必要に応じて）

4. **UseCase修正**
   - `CreateTranscriptUseCase.getVideoBuffer` をストリーム転送に変更
   - 既存のユニットテストを修正

## テスト方針

### 統合テスト（GcsClient）

```typescript
describe('GcsClient Integration', () => {
  describe('uploadFromStream', () => {
    it('should upload file from stream to GCS');
    it('should handle large file upload');
  });

  describe('downloadAsStream', () => {
    it('should download file as stream from GCS');
    it('should handle non-existent file');
  });
});
```

### 統合テスト（GoogleDriveClient）

```typescript
describe('downloadFileAsStream', () => {
  it('should download file as stream');
  it('should handle large file download without memory spike');
});
```

### ユニットテスト（UseCase）

既存のモックを拡張し、ストリームメソッドのモックを追加。

## 環境変数

変更なし。既存の環境変数をそのまま使用:

- `GOOGLE_CLOUD_PROJECT`
- `VIDEO_TEMP_BUCKET`
- `VIDEO_TEMP_EXPIRATION_DAYS`
- `LOCAL_TEMP_STORAGE_DIR`（ローカル開発用）

## ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `domain/gateways/storage.gateway.ts` | `downloadFileAsStream` 追加 |
| `domain/gateways/temp-storage.gateway.ts` | `uploadFromStream`, `downloadAsStream` 追加 |
| `infrastructure/clients/google-drive.client.ts` | ストリームメソッド実装 |
| `infrastructure/clients/gcs.client.ts` | ストリームメソッド実装 |
| `infrastructure/clients/local-storage.client.ts` | ストリームメソッド実装 |
| `infrastructure/clients/local-temp-storage.client.ts` | ストリームメソッド実装 |
| `application/usecases/cache-video.usecase.ts` | 新規作成（Drive → GCS） |
| `application/usecases/extract-audio.usecase.ts` | 新規作成（GCS → 音声） |
| `application/usecases/transcribe-audio.usecase.ts` | 新規作成（音声 → 文字起こし） |
| `application/usecases/create-transcript.usecase.ts` | ラッパーとして修正 |
| `test/integration/infrastructure/clients/gcs.client.test.ts` | 新規作成 |
| `test/integration/infrastructure/clients/google-drive.client.test.ts` | テスト追加 |
